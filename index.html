<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vape Tracker</title>

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vape Tracker">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Apple Splash Screens -->
    <link rel="apple-touch-startup-image" href="vape_bg_new.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="icon" type="image/png" href="favicon.png">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&subset=cyrillic&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-color: #050505;
            --bg-image: url('vape_bg_new.png');
            --bg-overlay: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85));
            --card-bg: rgba(255, 255, 255, 0.05);
            --accent-color: #00f2ff;
            --secondary-accent: #7000ff;
            --text-color: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.5);
            --success-color: #00f0aa;
            --danger-color: #ff3b30;
            --glass-border: rgba(255, 255, 255, 0.08);
            --shadow-color: rgba(0, 0, 0, 0.4);
            --tab-active-bg: #ffffff;
            --tab-active-text: #000000;
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        /* NEW STYLES FOR LOGOUT */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 10px 16px;
            border-radius: 14px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .logout-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.15);
        }

        .logout-btn i {
            font-size: 14px;
        }

        #appTitle {
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            white-space: nowrap;
        }

        #appTitle.offline {
            color: #888 !important;
            opacity: 0.7;
        }

        body.light-theme {
            --bg-color: #f2f2f7;
            --bg-image: url('vape_bg_light.png');
            --bg-overlay: linear-gradient(rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.3));
            --card-bg: rgba(255, 255, 255, 0.65);
            /* more translucent for glass */
            --accent-color: #000000;
            --secondary-accent: rgba(0, 0, 0, 0.05);
            --text-color: #000000;
            --text-secondary: rgba(0, 0, 0, 0.6);
            --success-color: #00a83f;
            --danger-color: #ff3b30;
            --glass-border: rgba(0, 0, 0, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.05);
            --tab-active-bg: #000000;
            --tab-active-text: #ffffff;
        }


        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Roboto', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            /* Blur transitions handled separately for smoothness */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: calc(45px + var(--safe-area-top)) 0 calc(110px + var(--safe-area-bottom));
            min-height: 100vh;
            min-height: 100dvh;
            /* Use dynamic viewport height if supported */
            overflow-x: hidden;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            /* Remove blue highlight on tap */
            overscroll-behavior-y: none;
            /* Prevent page bounce */
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 0 20px;
            width: 100%;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-image: var(--bg-overlay), var(--bg-image);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            pointer-events: none;
            will-change: transform;
            transform: translateZ(0);
            /* Hardware acceleration */
        }

        /* Settings Toggle Switch */
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent-color);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 28px;
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 8px;
            color: var(--accent-color);
            margin-bottom: 40px;
            opacity: 0.9;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0f0f19 0%, #1a1a2e 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.4s ease;
        }

        #loadingOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Navigation */
        .tabs {
            position: fixed;
            bottom: calc(25px + var(--safe-area-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 15, 25, 0.8);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-radius: 40px;
            display: flex;
            padding: 8px;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--glass-border);
            width: 95%;
            max-width: 450px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            -webkit-user-select: none;
        }

        .tab {
            flex: 1;
            padding: 12px 0;
            border-radius: 32px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            color: var(--text-secondary);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            user-select: none;
            -webkit-user-select: none;
        }

        .tab:active {
            transform: scale(0.95);
        }

        /* Range Input Styling */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.4);
            margin-top: -6px;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .tab.active {
            background: var(--tab-active-bg);
            color: var(--tab-active-text);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.15);
            transform: scale(1);
        }

        .page {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .page.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .theme-toggle {
            position: absolute;
            top: calc(20px + var(--safe-area-top));
            right: 20px;
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            background: var(--glass-border);
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 35px;
        }

        .total-box {
            text-align: left;
            background: var(--card-bg);
            backdrop-filter: blur(30px) saturate(150%);
            -webkit-backdrop-filter: blur(30px) saturate(150%);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 28px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            transition: backdrop-filter 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: auto;
            transform: translateZ(0);
        }

        .total-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background: var(--accent-color);
            opacity: 0.5;
        }

        .total-box.profit::before {
            background: var(--secondary-accent);
        }

        .total-box div {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 400;
        }

        .total-box span {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-color);
        }

        /* Input Card */
        .input-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(25px) saturate(200%);
            -webkit-backdrop-filter: blur(25px) saturate(200%);
            padding: 30px;
            border-radius: 32px;
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.1), 0 20px 40px rgba(0, 0, 0, 0.4);
            margin-bottom: 35px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-group {
            margin-bottom: 20px;
        }

        input,
        select {
            width: 100%;
            padding: 18px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            appearance: none;
        }

        input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: none;
            transform: translateY(-2px);
        }

        /* Light Theme Input Improvements */
        body.light-theme input,
        body.light-theme select {
            background: rgba(0, 0, 0, 0.08);
            border: 1.5px solid rgba(0, 0, 0, 0.15);
            color: #000;
        }

        body.light-theme input::placeholder,
        body.light-theme select option {
            color: rgba(0, 0, 0, 0.4);
        }

        body.light-theme input:focus,
        body.light-theme select:focus {
            background: rgba(0, 0, 0, 0.12);
            border-color: rgba(0, 0, 0, 0.3);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
            font-size: 15px;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }

        .checkbox-group input {
            display: none;
        }

        .checkbox-custom {
            width: 24px;
            height: 24px;
            border-radius: 8px;
            border: 2px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
        }

        .checkbox-group input:checked+.checkbox-custom,
        .checkbox-group input:checked+.checkbox-custom.checkbox-accent,
        .checkbox-group input:checked+.checkbox-custom.checkbox-warning {
            background: #ffffff !important;
            border-color: #ffffff !important;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .checkbox-accent {
            border-color: var(--accent-color);
        }

        .checkbox-warning {
            border-color: #ff9800;
            background: rgba(255, 152, 0, 0.05);
        }

        .checkbox-custom::after {
            content: '‚úì';
            color: #000;
            font-size: 16px;
            font-weight: 800;
            display: none;
        }

        .checkbox-group input:checked+.checkbox-custom::after {
            display: block;
        }

        /* Autocomplete */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .autocomplete-list {
            position: absolute;
            top: 105%;
            left: 0;
            right: 0;
            background: rgba(20, 20, 35, 0.95);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1100;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            display: none;
        }

        .autocomplete-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: rgba(0, 242, 255, 0.1);
            color: var(--accent-color);
        }

        .autocomplete-item b {
            font-size: 16px;
        }

        .autocomplete-item small {
            font-size: 12px;
            font-weight: 800;
        }

        /* Stats */

        .main-btn {
            width: 100%;
            padding: 18px;
            border-radius: 18px;
            border: none;
            background: var(--accent-color);
            color: var(--bg-color);
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 20px var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .main-btn:active {
            transform: scale(0.97);
            box-shadow: 0 5px 10px var(--shadow-color);
        }

        body.light-theme .main-btn {
            background: #000;
            color: #fff;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        button.main-btn.btn-error {
            background: #ff4d4d !important;
            box-shadow: 0 0 30px rgba(255, 77, 77, 0.4);
            animation: error-shake 0.4s ease-in-out;
        }

        @keyframes error-shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20%,
            60% {
                transform: translateX(-5px);
            }

            40%,
            80% {
                transform: translateX(5px);
            }
        }

        /* History & Items */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 25px;
            padding: 0 5px;
        }

        .history-header h2 {
            font-size: 14px;
            margin: 0 0 12px 0;
            font-weight: 300;
            letter-spacing: 5px;
            text-transform: uppercase;
            color: var(--text-color);
            opacity: 0.6;
            user-select: none;
            -webkit-user-select: none;
        }

        .clear-btn {
            background: rgba(255, 61, 113, 0.1);
            border: 1px solid rgba(255, 61, 113, 0.4);
            color: var(--danger-color);
            padding: 0 18px;
            height: 44px;
            border-radius: 22px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clear-btn:active {
            background: var(--danger-color);
            color: white;
        }

        .date-divider {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin: 30px 0 15px;
            padding-left: 5px;
            letter-spacing: 3px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: fadeInItem 0.4s ease-out;
        }

        .date-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, var(--glass-border), transparent);
        }

        .item-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            padding: 20px;
            border-radius: 22px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.02);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInItem 0.4s ease-out;
        }

        .item-card:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }

        .item-info b {
            font-size: 18px;
            color: var(--text-color);
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .item-info small {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .item-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .item-price {
            font-weight: 800;
            font-size: 18px;
            color: var(--success-color);
        }

        .delete-btn {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: #ff3d71;
            font-size: 18px;
            width: 36px;
            height: 36px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-btn:active {
            background: rgba(255, 61, 113, 0.2);
            transform: scale(0.9);
        }

        .badge {
            font-size: 10px;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        .badge.active {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #000 !important;
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }

        body.light-theme .badge.active {
            background: #000 !important;
            color: #fff !important;
        }

        .badge.toggle-btn {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-color);
            cursor: pointer;
            margin: 0;
            height: 44px;
            padding: 0 20px;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            border: 1px solid var(--glass-border);
        }

        .badge.toggle-btn:hover {
            border-color: var(--glass-border);
        }

        .badge-profit {
            background: rgba(0, 255, 157, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(0, 255, 157, 0.2);
        }

        /* Calendar Trigger */
        .date-filter-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .calendar-trigger {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--accent-color);
            position: relative;
        }

        .calendar-trigger::after {
            content: 'üìÖ';
            font-size: 18px;
        }

        .calendar-trigger.active {
            background: rgba(0, 242, 255, 0.1);
            border-color: var(--accent-color);
        }

        input[type="date"].hidden-picker {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        /* Inventory Controls */
        .qty-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qty-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .qty-btn:active {
            background: var(--accent-color);
            color: black;
            transform: scale(0.9);
        }

        .edit-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }

        .edit-btn:hover {
            color: var(--accent-color);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-card {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .modal-card h3 {
            margin-top: 0;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 800;
            letter-spacing: 1px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 40px;
            display: block;
            margin-bottom: 10px;
        }

        /* Stats Period Selector */
        .stats-period-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.05);
            /* Lighter by default */
            padding: 6px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
        }

        body.light-theme .stats-period-selector {
            background: rgba(0, 0, 0, 0.05);
        }

        .period-btn {
            flex: 1;
            padding: 12px 8px;
            border: none;
            border-radius: 16px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .period-btn.active {
            background: var(--accent-color);
            color: var(--bg-color);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.1);
        }

        /* Top Products Bar */
        .product-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .product-bar-name {
            width: 100px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-bar-fill {
            flex: 1;
            height: 24px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .product-bar-progress {
            height: 100%;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-size: 12px;
            font-weight: 600;
            transition: width 0.5s ease;
        }

        /* Low Stock Warning */
        .low-stock-warning {
            display: inline-block;
            background: linear-gradient(135deg, #ff3d71, #ff6b6b);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 8px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        /* Loss Item */
        .loss-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 61, 113, 0.1);
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #ff3d71;
        }

        .loss-item-info {
            flex: 1;
        }

        .loss-item-info b {
            font-size: 14px;
        }

        .loss-item-info small {
            display: block;
            color: var(--text-secondary);
            margin-top: 4px;
            font-size: 12px;
        }

        @keyframes fadeInItem {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        #salesDisplay {
            transition: all 0.3s ease;
            min-height: 200px;
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideDownToast 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes slideDownToast {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .goal-container {
            margin-top: -10px;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.03);
            padding: 12px 15px;
            border-radius: 18px;
            border: 1px solid var(--glass-border);
            display: none;
            /* Hidden by default */
        }

        .goal-text {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .progress-bg {
            height: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent-color);
            border-radius: 3px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1), background 0.5s ease;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.2);
        }

        .notes-btn {
            position: fixed;
            bottom: calc(100px + var(--safe-area-bottom));
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
            width: 56px;
            height: 56px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 900;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ai-btn {
            position: fixed;
            bottom: calc(100px + var(--safe-area-bottom));
            left: 20px;
            background: rgba(112, 0, 255, 0.2);
            border: 1px solid rgba(112, 0, 255, 0.4);
            color: var(--text-color);
            width: 56px;
            height: 56px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 900;
            box-shadow: 0 10px 30px rgba(112, 0, 255, 0.3);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .ai-btn:active {
            transform: scale(0.9);
        }

        .ai-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Chat Modal - Floating Window Style */
        #chatModal {
            display: none;
            flex-direction: column;
            position: fixed;
            bottom: calc(90px + var(--safe-area-bottom));
            left: 20px;
            width: 350px;
            height: 500px;
            max-width: 85vw;
            max-height: 60vh;
            background: rgba(15, 15, 20, 0.95);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(0, 0, 0, 0.2);
            z-index: 5000;
            overflow: hidden;
            animation: slideInChat 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            transform-origin: bottom left;
        }

        @keyframes slideInChat {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            background: linear-gradient(to right, rgba(112, 0, 255, 0.1), transparent);
        }

        .chat-input-area {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-end;
            background: rgba(0, 242, 255, 0.15);
            border: 1px solid rgba(0, 242, 255, 0.3);
            border-bottom-right-radius: 4px;
            color: white;
        }

        .message.ai {
            align-self: flex-start;
            background: rgba(112, 0, 255, 0.15);
            border: 1px solid rgba(112, 0, 255, 0.3);
            border-bottom-left-radius: 4px;
            color: white;
        }

        .chat-input-area {
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-top: 1px solid var(--glass-border);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            outline: none;
        }

        .send-btn {
            background: var(--secondary-accent);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Typing indicator */
        .typing {
            display: flex;
            gap: 4px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 18px;
            align-self: flex-start;
            margin-bottom: 10px;
            width: fit-content;
        }

        .typing span {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }



        /* Swipe Elements */
        .item-card-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 22px;
            margin-bottom: 12px;
            user-select: none;
            touch-action: pan-y;
        }

        .swipe-action {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 120px;
            display: flex;
            align-items: center;
            padding: 0 25px;
            color: white;
            font-weight: bold;
            font-size: 13px;
            line-height: normal;
            border-radius: 22px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .swipe-action.left {
            background: var(--danger-color);
            justify-content: flex-end;
            right: 0;
            left: auto;
        }

        .swipe-action.right {
            background: var(--success-color);
            justify-content: flex-start;
            left: 0;
            right: auto;
        }

        .item-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            padding: 20px;
            border-radius: 22px;
            margin-bottom: 0;
            /* Handled by wrapper */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.02);
            transition: transform 0.2s ease-out;
            position: relative;
            z-index: 2;
        }

        .badge-debt {
            background: rgba(255, 152, 0, 0.15);
            color: #ff9800;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .note-date {
            font-size: 10px;
            opacity: 0.5;
            margin-bottom: 5px;
        }

        .note-text {
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .note-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0.3;
            cursor: pointer;
            padding: 5px;
        }

        .note-delete:hover {
            opacity: 1;
            color: var(--danger-color);
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Header Buttons -->
        <!-- Theme toggle moved to Settings in Info tab -->

        <!-- Floating Action Button -->
        <!-- Floating Action Button: AI Assistant -->
        <button id="aiFab" class="ai-btn" onclick="openChatModal()" title="AI –ü–æ–º–æ—â–Ω–∏–∫">
            <img src="ai_assistant.png" alt="AI">
        </button>

        <!-- Floating Action Button: Notes -->
        <button class="notes-btn" onclick="openNotesModal()" title="–ó–∞–º–µ—Ç–∫–∏">üìù</button>

        <div class="header" style="margin-top: 10px;">
            <div style="width: 80px;"></div> <!-- Spacer -->
            <h1 id="appTitle" onclick="handleTitleClick()">VAPE TRACKER</h1>
            <button class="logout-btn" onclick="logout()" title="–í—ã–π—Ç–∏">
                <span>–í–´–ô–¢–ò</span>
            </button>
        </div>

        <div class="stats-grid">
            <div class="total-box">
                <div>–í—ã—Ä—É—á–∫–∞</div>
                <span id="totalRevenue">0</span> ‚ÇΩ
            </div>
            <div class="total-box profit">
                <div>–ü—Ä–∏–±—ã–ª—å</div>
                <span id="totalProfit" style="color: var(--success-color);">0</span> ‚ÇΩ
            </div>
        </div>

        <div id="goalContainer" class="goal-container">
            <div class="goal-text">
                <span style="opacity: 0.7;">–¶–µ–ª—å</span>
                <span id="goalProgressText" style="color: var(--accent-color);">0 / 0 ‚ÇΩ</span>
            </div>
            <div class="progress-bg">
                <div id="goalProgressBar" class="progress-bar"></div>
            </div>
        </div>

        <!-- Page: Sales -->
        <div id="salesPage" class="page active">
            <div class="input-card">
                <div class="input-group autocomplete-container">
                    <input type="text" id="saleName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: Brusko)"
                        oninput="handleAutocomplete(this)" onfocus="handleAutocomplete(this)" autocomplete="off">
                    <div id="autocompleteList" class="autocomplete-list"></div>
                </div>
                <div class="input-group" style="display: flex; gap: 15px;">
                    <input type="number" id="saleQty" placeholder="–ö–æ–ª-–≤–æ" inputmode="numeric" pattern="[0-9]*"
                        required>
                    <input type="number" id="salePrice" placeholder="–¶–µ–Ω–∞" inputmode="decimal" step="any" required>
                </div>

                <div
                    style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <label class="checkbox-group" style="flex: 1; display: flex; justify-content: flex-start;">
                        <input type="checkbox" id="useDate" checked onchange="toggleDateInput()">
                        <div class="checkbox-custom"></div>
                        <span>–î–∞—Ç–∞</span>
                    </label>

                    <label class="checkbox-group" style="flex: 1; display: flex; justify-content: center;">
                        <input type="checkbox" id="showBuyer" onchange="toggleCustomerInput()">
                        <div class="checkbox-custom checkbox-accent"></div>
                        <span>–ö–ª–∏–µ–Ω—Ç</span>
                    </label>

                    <label class="checkbox-group" style="flex: 1; display: flex; justify-content: flex-end;">
                        <input type="checkbox" id="isDebt" onchange="toggleCustomerInput(); toggleDebtColor();">
                        <div class="checkbox-custom checkbox-warning"></div>
                        <span style="color: #ff9800;">–í –¥–æ–ª–≥</span>
                    </label>
                </div>

                <div id="debtorNameContainer"
                    style="display: none; animation: fadeIn 0.3s ease; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                    <input type="text" id="debtorName" placeholder="üë§ –§–ò–û –ø–æ–∫—É–ø–∞—Ç–µ–ª—è"
                        style="border-radius: 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; padding: 12px 14px; font-size: 14px;">
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="debtorContact" placeholder="üìû –ù–æ–º–µ—Ä"
                            style="flex:1; border-radius: 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; padding: 12px 14px; font-size: 14px;">
                        <input type="text" id="debtorSocial" placeholder="‚úàÔ∏è TG / –°–æ—Ü-—Å–µ—Ç–∏"
                            style="flex:1; border-radius: 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; padding: 12px 14px; font-size: 14px;">
                    </div>
                </div>

                <div id="manualDateContainer" style="display: none; animation: fadeIn 0.3s ease; margin-bottom: 15px;">
                    <input type="date" id="saleDate"
                        style="border-radius: 16px; background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); color: white; padding: 14px; width: 100%;">
                </div>

                <div class="input-group" style="margin-top: 5px;">
                    <input type="text" id="saleNote" placeholder="–ó–∞–º–µ—Ç–∫–∞ –∫ –ø—Ä–æ–¥–∞–∂–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                        style="border-radius: 16px; background: rgba(255,255,255,0.03); font-size: 13px; padding: 12px 14px;">
                </div>
            </div>

            <button id="addSaleBtn" class="main-btn" onclick="addSale()">–ü–†–û–î–ê–¢–¨</button>

            <div class="history-header" style="margin-top: 25px;">
                <div style="display: flex; flex-direction: column; gap: 4px; width: 100%;">
                    <div style="display: flex; gap: 4px; align-items: center; width: 100%;">
                        <select id="sortType" class="badge toggle-btn" onchange="setSortType(this.value)"
                            style="padding-right: 30px; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2210%22%20height%3D%2210%22%20viewBox%3D%220%200%2012%2012%22%20fill%3D%22none%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cpath%20d%3D%22M2%204L6%208L10%204%22%20stroke%3D%22white%22%20stroke-width%3D%221.5%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 10px center; appearance: none; outline: none; border: 1px solid var(--glass-border); flex: 1; height: 44px;">
                            <option value="date" style="background:#222; color:#fff">–ü–æ –¥–∞—Ç–µ</option>
                            <option value="amount" style="background:#222; color:#fff">–ü–æ —Å—É–º–º–µ</option>
                            <option value="name" style="background:#222; color:#fff">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                            <option value="popular" style="background:#222; color:#fff">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
                            <option value="profit_day" style="background:#222; color:#fff">–ü—Ä–∏–±—ã–ª—å–Ω—ã–π –¥–µ–Ω—å</option>
                        </select>
                        <button id="sortDirBtn" class="badge toggle-btn" onclick="toggleSortDir()"
                            style="width: 44px; min-width: 44px; padding: 0; font-size: 16px; border: 1px solid var(--glass-border);">‚Üì</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div id="calendarWrapper" class="date-filter-wrapper">
                        <div class="calendar-trigger" id="calIcon"></div>
                        <input type="date" id="dateFilter" class="hidden-picker" onchange="onDateChange(this)"
                            onfocus="document.getElementById('calIcon').classList.add('active')"
                            onblur="document.getElementById('calIcon').classList.remove('active')">
                    </div>
                    <button class="clear-btn" onclick="clearSales()">–û–ß–ò–°–¢–ò–¢–¨</button>
                </div>
            </div>
            <div id="salesDisplay"></div>
            <!-- salesPage ends here -->
        </div>

        <!-- Page: Inventory -->
        <div id="inventoryPage" class="page">
            <div class="input-card">
                <div class="input-group">
                    <input type="text" id="invName" placeholder="–ù—É —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–π, —á–µ–º –∑–∞–∫—É–ø–∏–ª—Å—è?" required>
                </div>
                <div class="input-group" style="display: flex; gap: 15px;">
                    <input type="text" id="invStrength" placeholder="–ö—Ä–µ–ø–æ—Å—Ç—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    <input type="number" id="invQty" placeholder="–®—Ç." inputmode="numeric" pattern="[0-9]*" required>
                </div>
                <div class="input-group" style="display: flex; gap: 15px;">
                    <input type="number" id="invCost" placeholder="–ó–∞–∫—É–ø (‚ÇΩ/—à—Ç)" inputmode="decimal" step="any"
                        required>
                    <input type="number" id="invPrice" placeholder="–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (‚ÇΩ)" inputmode="decimal" step="any"
                        required>
                </div>
                <button class="main-btn" onclick="addInventory()">–ù–ê –°–ö–õ–ê–î</button>
            </div>

            <div class="history-header" style="justify-content: flex-end; margin-top: 10px; margin-bottom: 15px;">
                <button class="clear-btn" onclick="clearInventory()"
                    style="width: 44px; padding: 0; background: rgba(255, 61, 113, 0.08);"
                    title="–û—á–∏—Å—Ç–∏—Ç—å —Å–∫–ª–∞–¥">üóëÔ∏è</button>
            </div>

            <!-- Inventory Stats -->
            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="total-box">
                    <div>–ó–∞–∫—É–ø–ª–µ–Ω–æ –Ω–∞</div>
                    <span id="invTotalCost">0</span> ‚ÇΩ
                </div>
                <div class="total-box profit">
                    <div>–û–∂–∏–¥. –≤—ã—Ä—É—á–∫–∞</div>
                    <span id="invTotalRevenue">0</span> ‚ÇΩ
                </div>
            </div>

            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="total-box">
                    <div>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞</div>
                    <span id="invTotalCount">0</span> —à—Ç.
                </div>
                <div class="total-box profit">
                    <div>–†–∞–∑–Ω–æ–≤–∏–¥–Ω–æ—Å—Ç—å</div>
                    <span id="invTotalVariety">0</span> –µ–¥.
                </div>
            </div>

            <div id="inventoryDisplay"></div>
        </div>

        <!-- Page: Debts -->
        <div id="debtsPage" class="page">
            <div class="input-card" style="padding: 30px;">
                <h3 style="margin: 0 0 25px 0; text-align: center; letter-spacing: 2px;">–†–ê–ë–û–¢–ê –° –î–û–õ–ì–ê–ú–ò</h3>

                <div class="total-box" style="margin-bottom: 25px; --accent-color: #ff9800;">
                    <div>–û–±—â–∏–π –¥–æ–ª–≥</div>
                    <span id="totalDebtsSum" style="color: #ff9800;">0</span> ‚ÇΩ
                </div>

                <div id="debtsDisplay"></div>

                <div style="padding: 20px 10px 0; opacity: 0.6; font-size: 13px; text-align: center; line-height: 1.5;">
                    üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ üü¢ ‚Äî –û–ø–ª–∞—á–µ–Ω–æ<br>
                    –°–≤–∞–π–ø –≤–ª–µ–≤–æ üî¥ ‚Äî –ü—Ä–æ—Å—Ç–∏—Ç—å (–≤ —É–±—ã—Ç–∫–∏)
                </div>
            </div>
        </div>

        <!-- Page: Losses -->
        <div id="lossesPage" class="page">
            <div class="input-card" style="padding: 30px;">
                <h3 style="margin: 0 0 25px 0; text-align: center; letter-spacing: 2px;">–£–ë–´–¢–ö–ò / –°–ü–ò–°–ê–ù–ò–Ø</h3>

                <div class="total-box" style="margin-bottom: 25px; --accent-color: #ff3b30;">
                    <div>–£–±—ã—Ç–æ–∫</div>
                    <span id="lossesPageTotal" style="color: #ff3b30;">0</span> ‚ÇΩ
                </div>

                <button class="main-btn"
                    style="margin-bottom: 25px; background: linear-gradient(135deg, #ff3d71, #ff6b6b); box-shadow: 0 10px 20px rgba(255, 61, 113, 0.2);"
                    onclick="openLossModal()">–î–û–ë–ê–í–ò–¢–¨ –£–ë–´–¢–û–ö</button>

                <div id="lossesHistory"></div>

                <div style="padding: 20px 10px 0; opacity: 0.6; font-size: 13px; text-align: center; line-height: 1.5;">
                    –ó–¥–µ—Å—å —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –±—Ä–∞–∫–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã, –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ <br> –∏–ª–∏ –µ—Å–ª–∏ —Ä–µ—à–∏–ª —Å–∞–º –ø–æ–ø–∞—Ä–∏—Ç—å –∏–ª–∏ –ø–æ–¥–∞—Ä–∏—Ç—å.
                </div>
            </div>
        </div>

        <!-- Page: Stats -->
        <div id="statsPage" class="page">
            <div class="stats-period-selector">
                <button class="period-btn active" onclick="setStatsPeriod('day')">–î–µ–Ω—å</button>
                <button class="period-btn" onclick="setStatsPeriod('week')">–ù–µ–¥–µ–ª—è</button>
                <button class="period-btn" onclick="setStatsPeriod('month')">–ú–µ—Å—è—Ü</button>
                <button class="period-btn" onclick="setStatsPeriod('all')">–í—Å—ë</button>
            </div>

            <div class="stats-grid">
                <div class="total-box">
                    <div>–í—ã—Ä—É—á–∫–∞</div>
                    <span id="statRevenue">0</span> ‚ÇΩ
                </div>
                <div class="total-box profit">
                    <div>–ü—Ä–∏–±—ã–ª—å</div>
                    <span id="statProfit">0</span> ‚ÇΩ
                </div>
            </div>

            <!-- Chart Card -->
            <div class="input-card" style="padding: 20px; overflow: hidden;">
                <h4
                    style="margin: 0 0 15px 0; font-size: 12px; color: var(--accent-color); text-transform: uppercase; letter-spacing: 2px; text-align: center;">
                    –ì—Ä–∞—Ñ–∏–∫ –≤—ã—Ä—É—á–∫–∏</h4>
                <div style="height: 200px; width: 100%; position: relative;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <div class="stats-grid">
                <div class="total-box" style="--accent-color: #ff6b6b;">
                    <div>–£–±—ã—Ç–∫–∏</div>
                    <span id="statLosses" style="color: #ff6b6b;">0</span> ‚ÇΩ
                </div>
                <div class="total-box" style="--accent-color: #ffd93d;">
                    <div>–ü—Ä–æ–¥–∞–∂</div>
                    <span id="statSalesCount">0</span> —à—Ç.
                </div>
            </div>

            <div
                style="margin: 25px 0 15px 12px; font-size: 11px; font-weight: bold; opacity: 0.5; text-transform: uppercase; letter-spacing: 1.5px;">
                –°–ö–õ–ê–î –°–ï–ô–ß–ê–°</div>
            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="total-box" style="--accent-color: var(--secondary-accent);">
                    <div>–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
                    <span id="statInvValue">0</span> ‚ÇΩ
                </div>
                <div class="total-box profit" style="--accent-color: var(--success-color);">
                    <div>–û–∂–∏–¥. –ø—Ä–∏–±—ã–ª—å</div>
                    <span id="statInvProfit">0</span> ‚ÇΩ
                </div>
            </div>

            <div class="input-card" style="padding: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--text-secondary);">üî• –¢–û–ü —Ç–æ–≤–∞—Ä—ã</h3>
                <div id="topProducts"></div>
            </div>

            <div class="input-card" style="padding: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--text-secondary);">üìâ –ù–µ –ø—Ä–æ–¥–∞—ë—Ç—Å—è</h3>
                <div id="worstProducts"></div>
            </div>
        </div>
    </div>

    <!-- Edit Inventory Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-card">
            <h3>–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –¢–û–í–ê–†</h3>
            <input type="hidden" id="editItemId">
            <div class="input-group">
                <input type="text" id="editName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            </div>
            <div class="input-group">
                <input type="text" id="editStrength" placeholder="–ö—Ä–µ–ø–æ—Å—Ç—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div class="input-group" style="display: flex; gap: 15px;">
                <input type="number" id="editCost" placeholder="–ó–∞–∫—É–ø" inputmode="decimal" step="any">
                <input type="number" id="editPrice" placeholder="–ü—Ä–æ–¥–∞–∂–∞" inputmode="decimal" step="any">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2;" onclick="saveEdit()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <!-- Edit Sale Modal -->
    <div id="editSaleModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="letter-spacing: 2px;">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –ü–†–û–î–ê–ñ–£</h3>
            <input type="hidden" id="editSaleId">
            <div class="input-group">
                <input type="text" id="editSaleName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            </div>
            <div class="input-group" style="display: flex; gap: 10px;">
                <input type="number" id="editSaleQty" placeholder="–ö–æ–ª-–≤–æ" inputmode="numeric" pattern="[0-9]*">
                <input type="number" id="editSalePrice" placeholder="–¶–µ–Ω–∞" inputmode="decimal" step="any">
            </div>
            <div class="input-group" style="margin-top: 10px;">
                <input type="text" id="editSaleNote" placeholder="–ó–∞–º–µ—Ç–∫–∞ –∫ –ø—Ä–æ–¥–∞–∂–µ">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2;" onclick="saveSaleEdit()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeSaleModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <!-- Add Loss Modal -->
    <div id="lossModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="color: #ff6b6b;">–î–û–ë–ê–í–ò–¢–¨ –£–ë–´–¢–û–ö</h3>
            <div class="input-group">
                <div class="autocomplete-container" style="width: 100%;">
                    <input type="text" id="lossName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" autocomplete="off">
                    <div id="lossAutocompleteList" class="autocomplete-list"></div>
                </div>
            </div>
            <div class="input-group" style="display: flex; gap: 15px;">
                <input type="number" id="lossQty" placeholder="–ö–æ–ª-–≤–æ" inputmode="numeric" pattern="[0-9]*">
                <input type="number" id="lossCost" placeholder="–ó–∞–∫—É–ø —Ü–µ–Ω–∞" inputmode="decimal" step="any">
            </div>
            <div class="input-group">
                <select id="lossReason"
                    style="width: 100%; padding: 14px; border-radius: 16px; background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); color: white; font-size: 16px;">
                    <option value="defect">–ë—Ä–∞–∫</option>
                    <option value="lost">–ü–æ—Ç–µ—Ä—è–Ω</option>
                    <option value="gift">–ü–æ–¥–∞—Ä–∏–ª</option>
                    <option value="self">–û—Å—Ç–∞–≤–∏–ª —Å–µ–±–µ</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>

            <div class="checkbox-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="lossDeductStock" checked>
                    <div class="checkbox-custom"></div>
                    <span>–°–ø–∏—Å–∞—Ç—å —Å–æ —Å–∫–ª–∞–¥–∞</span>
                </label>
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <input type="text" id="lossNote" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2; background: linear-gradient(135deg, #ff3d71, #ff6b6b);"
                    onclick="saveLoss()">–î–û–ë–ê–í–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeLossModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <!-- Edit Loss Modal -->
    <div id="editLossModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="color: #ff6b6b; letter-spacing: 2px;">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –£–ë–´–¢–û–ö</h3>
            <input type="hidden" id="editLossId">
            <div class="input-group">
                <input type="text" id="editLossName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
            </div>
            <div class="input-group" style="display: flex; gap: 15px;">
                <input type="number" id="editLossQty" placeholder="–ö–æ–ª-–≤–æ" inputmode="numeric" pattern="[0-9]*">
                <input type="number" id="editLossCost" placeholder="–ó–∞–∫—É–ø —Ü–µ–Ω–∞" inputmode="decimal" step="any">
            </div>
            <div class="input-group">
                <select id="editLossReason"
                    style="width: 100%; padding: 14px; border-radius: 16px; background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); color: white; font-size: 16px;">
                    <option value="defect">–ë—Ä–∞–∫</option>
                    <option value="lost">–ü–æ—Ç–µ—Ä—è–Ω</option>
                    <option value="gift">–ü–æ–¥–∞—Ä–∏–ª</option>
                    <option value="self">–û—Å—Ç–∞–≤–∏–ª —Å–µ–±–µ</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>
            <div class="input-group" style="margin-top: 20px;">
                <input type="text" id="editLossNote" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2; background: linear-gradient(135deg, #ff3d71, #ff6b6b);"
                    onclick="saveLossEdit()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeLossEditModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <!-- Duplicate Conflict Modal -->
    <div id="duplicateConflictModal" class="modal-overlay">
        <div class="modal-card" style="text-align: center;">
            <h3 style="color: #ffd93d;">–¢–û–í–ê–† –£–ñ–ï –ï–°–¢–¨</h3>
            <p style="font-size: 14px; opacity: 0.8; margin-bottom: 20px;">
                –¢–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω–∞ –∏ –∫—Ä–µ–ø–æ—Å—Ç—å) —É–∂–µ –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ. –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?
            </p>
            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                <button class="main-btn" style="background: var(--success-color); color: #000;"
                    onclick="handleMergeResult('merge')">–û–ë–™–ï–î–ò–ù–ò–¢–¨ –°–£–ú–ú–£</button>
                <button class="main-btn" style="background: rgba(255,255,255,0.1);"
                    onclick="handleMergeResult('new')">–î–û–ë–ê–í–ò–¢–¨ –ö–ê–ö –ù–û–í–´–ô</button>
            </div>
            <div class="checkbox-group" style="justify-content: center;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="dontAskMerge">
                    <div class="checkbox-custom"></div>
                    <span style="font-size: 12px;">–ë–æ–ª—å—à–µ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="letter-spacing: 2px;">–°–ú–ï–ù–ò–¢–¨ –ü–ê–†–û–õ–¨</h3>
            <div class="input-group">
                <input type="password" id="currentPassword" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
            </div>
            <div class="input-group">
                <input type="password" id="newPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
            </div>
            <div class="input-group">
                <input type="password" id="confirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
            </div>
            <div id="passwordChangeError" style="color: #ff3b30; font-size: 13px; margin-bottom: 15px; display: none;">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2;" onclick="saveNewPassword()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeChangePasswordModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <!-- Removed old syncStatus div -->

    <!-- Notes Modal -->
    <div id="notesModal" class="modal-overlay">
        <div class="modal-card" style="max-height: 80vh; display: flex; flex-direction: column;">
            <h3 style="letter-spacing: 2px;">–ó–ê–ú–ï–¢–ö–ò</h3>

            <div style="margin-bottom: 20px;">
                <textarea id="noteInput" placeholder="–ß—Ç–æ –∑–∞–ø–∏—Å–∞—Ç—å?"
                    style="width: 100%; height: 100px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 14px; color: white; padding: 15px; font-size: 14px; resize: none;"></textarea>
                <button class="main-btn" onclick="addNote()" style="margin-top: 10px;">–î–û–ë–ê–í–ò–¢–¨</button>
            </div>

            <div id="notesContainer" style="flex: 1; overflow-y: auto; padding-right: 5px;">
                <!-- Notes will be listed here -->
            </div>

            <button class="clear-btn" style="margin-top: 20px; width: 100%;"
                onclick="closeNotesModal()">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('sales')"><span
                style="font-size: 18px;">üí∏</span><span>–ü—Ä–æ–¥–∞–∂–∏</span></div>
        <div class="tab" onclick="switchTab('inventory')"><span style="font-size: 18px;">üì¶</span><span>–°–∫–ª–∞–¥</span>
        </div>
        <div class="tab" onclick="switchTab('debts')"><span style="font-size: 18px;">ü§ù</span><span>–î–æ–ª–≥–∏</span>
        </div>
        <div class="tab" onclick="switchTab('losses')"><span style="font-size: 18px;">üìâ</span><span>–£–±—ã—Ç–∫–∏</span>
        </div>
        <div class="tab" onclick="switchTab('stats')"><span style="font-size: 18px;">üìä</span><span>–ò—Ç–æ–≥–∏</span>
        </div>
        <div class="tab" onclick="switchTab('data')"><span style="font-size: 18px;">‚öôÔ∏è</span><span>–ò–Ω—Ñ–æ</span></div>
    </div>

    <!-- Data & Settings Page -->
    <div id="dataPage" class="page">
        <div style="max-width: 600px; margin: 0 auto;">
            <!-- Statistics Cards -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                <div
                    style="background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 15px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 5px;">üìä</div>
                    <div
                        style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px;">
                        –ü—Ä–æ–¥–∞–∂</div>
                    <div id="infoSalesCount" style="font-size: 20px; font-weight: 700; color: var(--accent-color);">0
                    </div>
                </div>
                <div
                    style="background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 15px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 5px;">üì¶</div>
                    <div
                        style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px;">
                        –ù–∞ —Å–∫–ª–∞–¥–µ</div>
                    <div id="infoInventoryCount" style="font-size: 20px; font-weight: 700; color: var(--accent-color);">
                        0
                    </div>
                </div>
            </div>

            <div
                style="background: linear-gradient(135deg, rgba(112, 0, 255, 0.1), rgba(0, 242, 255, 0.1)); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 15px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center; margin-bottom: 20px;">
                <div
                    style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">
                    –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–∫–ª–∞–¥–∞</div>
                <div id="infoInventoryValue" style="font-size: 24px; font-weight: 700; color: #ffffff;">0 <span
                        style="font-size: 16px; font-weight: normal; opacity: 0.6;">‚ÇΩ</span></div>
            </div>

            <!-- Settings Card -->
            <div class="input-card">
                <h3
                    style="margin-top: 0; margin-bottom: 20px; text-align: center; letter-spacing: 2px; font-size: 14px;">
                    –ù–ê–°–¢–†–û–ô–ö–ò</h3>

                <div class="settings-row">
                    <div style="font-size: 14px; display: flex; align-items: center; gap: 10px;">
                        <span>‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="themeSwitch" onchange="toggleTheme()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="settings-row">
                    <div style="font-size: 14px; display: flex; align-items: center; gap: 10px;">
                        <span>üìù –ó–∞–º–µ—Ç–∫–∏</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="notesSwitch" onchange="toggleNotesSetting()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="settings-row">
                    <div style="font-size: 14px; display: flex; align-items: center; gap: 10px;">
                        <span>ü§ñ AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="userAISwitch" onchange="toggleUserAI()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="settings-row">
                    <div style="font-size: 14px; display: flex; align-items: center; gap: 10px;">
                        <span>üì≥ –í–∏–±—Ä–∞—Ü–∏—è (Haptic)</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="hapticSwitch" onchange="toggleHapticSetting()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div id="hapticIntensityRow" class="settings-row"
                    style="display: none; flex-direction: column; align-items: flex-start; gap: 10px; border-bottom: none;">
                    <div
                        style="font-size: 12px; color: var(--text-secondary); display: flex; justify-content: space-between; width: 100%;">
                        <span>–°–∏–ª–∞ –æ—Ç–¥–∞—á–∏</span>
                        <span id="hapticIntensityValue">–°—Ä–µ–¥–Ω—è—è</span>
                    </div>
                    <input type="range" id="hapticIntensity" min="1" max="3" step="1" value="2"
                        oninput="updateHapticIntensity()"
                        style="width: 100%; height: 6px; border-radius: 3px; background: rgba(255,255,255,0.1); outline: none; -webkit-appearance: none; appearance: none; margin: 10px 0;">
                </div>
            </div>

            <!-- Goal Card -->
            <div class="input-card">
                <h3
                    style="margin-top: 0; margin-bottom: 15px; text-align: center; letter-spacing: 2px; font-size: 14px;">
                    üéØ
                    –ú–û–Ø –¶–ï–õ–¨</h3>
                <div class="input-group">
                    <input type="number" id="goalInput" placeholder="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—É–º–º—É (‚ÇΩ)" oninput="updateGoal()"
                        inputmode="numeric"
                        style="text-align: center; font-size: 18px; font-weight: bold; color: var(--accent-color);">
                </div>
                <div style="font-size: 10px; opacity: 0.5; text-align: center; line-height: 1.4;">
                    –¶–µ–ª—å –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –≤—ã—Ä—É—á–∫–µ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ (–¥–µ–Ω—å, –º–µ—Å—è—Ü –∏ —Ç.–¥.)
                </div>
            </div>

            <!-- Data Management Card -->
            <div class="input-card">
                <h3
                    style="margin-top: 0; margin-bottom: 20px; text-align: center; letter-spacing: 2px; font-size: 14px;">
                    –î–ê–ù–ù–´–ï</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <button class="main-btn" onclick="exportData()"
                        style="padding: 14px 10px; font-size: 11px; background: rgba(0,0,0,0.05); color: var(--text-color); border: 1px solid var(--glass-border);">
                        ‚¨áÔ∏è –ë–≠–ö–ê–ü
                    </button>
                    <button class="main-btn" onclick="document.getElementById('importFile').click()"
                        style="padding: 14px 10px; font-size: 11px; background: rgba(0,0,0,0.05); color: var(--text-color); border: 1px solid var(--glass-border);">
                        ‚¨ÜÔ∏è –ó–ê–ì–†–£–ó–ò–¢–¨
                    </button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">

                <button class="main-btn" onclick="shareData()" style="margin-bottom: 15px;">
                    üì§ –ü–û–î–ï–õ–ò–¢–¨–°–Ø –î–ê–ù–ù–´–ú–ò
                </button>

                <button class="main-btn" onclick="openHelpPage()"
                    style="background: rgba(0,242,255,0.15); color: var(--accent-color); border: 1.5px solid rgba(0,242,255,0.3);">
                    ‚ùì –ö–ê–ö –ü–û–õ–¨–ó–û–í–ê–¢–¨–°–Ø?
                </button>

                <button class="main-btn" onclick="openChangePasswordModal()"
                    style="margin-top: 15px; background: rgba(0, 242, 255, 0.15); color: var(--accent-color); border: 1.5px solid rgba(0, 242, 255, 0.3);">
                    üîë –°–ú–ï–ù–ò–¢–¨ –ü–ê–†–û–õ–¨
                </button>

                <button class="main-btn" onclick="logout()"
                    style="margin-top: 15px; background: rgba(255, 61, 113, 0.15); color: #ff3b30; border: 1.5px solid rgba(255, 61, 113, 0.3);">
                    üö™ –í–´–ô–¢–ò
                </button>

                <!-- Admin Panel (Hidden by default) -->
                <div id="adminPanel"
                    style="display: none; margin-top: 20px; background: rgba(255, 61, 113, 0.1); padding: 18px; border-radius: 18px; border: 1px solid var(--danger-color);">
                    <h4
                        style="margin-top: 0; margin-bottom: 12px; color: var(--danger-color); font-size: 13px; text-transform: uppercase; letter-spacing: 1.5px;">
                        üõ°Ô∏è –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å
                    </h4>

                    <div
                        style="font-size: 13px; color: var(--text-color); margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px;">
                        <div><b>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:</b> <span id="adminLastSeen"
                                style="color: var(--accent-color)">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
                        <div><b>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</b> <span id="adminLastDevice" style="opacity: 0.7;">-</span></div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <button class="main-btn" onclick="adminResetPassword()"
                            style="background: var(--danger-color); font-size: 12px; padding: 10px;">
                            ‚ôªÔ∏è –°–ë–†–û–°–ò–¢–¨ –ü–ê–†–û–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
                        </button>
                        <small style="display: block; margin-top: 5px; opacity: 0.6; font-size: 10px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                            —Å–º–æ–∂–µ—Ç
                            –≤–æ–π—Ç–∏ –±–µ–∑ –ø–∞—Ä–æ–ª—è, –Ω–æ –±—É–¥–µ—Ç –æ–±—è–∑–∞–Ω —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π.</small>
                    </div>

                    <div style="margin-top: 15px;">
                        <h5 style="margin: 0 0 10px 0; font-size: 12px; opacity: 0.8;">ü§ñ AI –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ:</h5>
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px;">
                            <h6 style="margin: 10px 0 5px 0; font-size: 10px; opacity: 0.6;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI (Firebase):
                            </h6>

                            <!-- AI Toggle -->
                            <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <label class="switch">
                                    <input type="checkbox" id="aiEnabledCheck" onchange="saveAISettings()">
                                    <span class="slider round"></span>
                                </label>
                                <span style="font-size: 12px;">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤–∫–ª—é—á–µ–Ω</span>
                            </div>

                            <!-- Model Select -->
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 10px; display: block; margin-bottom: 3px;">–ú–æ–¥–µ–ª—å:</label>
                                <select id="aiModelSelect" onchange="saveAISettings()"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 8px; padding: 5px; font-size: 11px;">
                                    <option value="llama-3.3-70b-versatile">Groq: Llama 3.3 70B</option>
                                    <option value="qwen/qwen3-32b">Groq: Qwen 3 32B</option>
                                    <option value="openai/gpt-oss-120b">Groq: GPT-OSS 120B</option>
                                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                    <option value="custom">Custom (—Å–º. –Ω–∏–∂–µ)</option>
                                </select>
                            </div>

                            <!-- Custom Model Name -->
                            <input type="text" id="aiCustomModel" placeholder="ID –ú–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä. gemini-2.5)"
                                style="width: 100%; margin-bottom: 8px; font-size: 11px; padding: 6px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 8px; color: white; display: none;">

                            <!-- Groq Key -->
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 10px; display: block; margin-bottom: 3px; color: #f59e0b;">üîë
                                    Groq API Key (gsk_...):</label>
                                <input type="password" id="aiGroqKey" placeholder="gsk_..." onchange="saveAISettings()"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #f59e0b; border-radius: 8px; padding: 6px; font-size: 11px; outline: none;">
                            </div>

                            <!-- Gemini Key -->
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 10px; display: block; margin-bottom: 3px; color: #3b82f6;">üíé
                                    Gemini API Key (AIza...):</label>
                                <input type="password" id="aiGeminiKey" placeholder="AIza..."
                                    onchange="saveAISettings()"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #3b82f6; border-radius: 8px; padding: 6px; font-size: 11px; outline: none;">
                            </div>

                            <!-- System Prompt -->
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 10px; display: block; margin-bottom: 3px; color: #10b981;">üìú
                                    –°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (Prompt):</label>
                                <textarea id="aiSystemPrompt" rows="3" placeholder="–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –≤ –≤–µ–π–ø-—à–æ–ø–µ..."
                                    onchange="saveAISettings()"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #fff; border-radius: 8px; padding: 6px; font-size: 11px; outline: none;"></textarea>
                            </div>

                            <div style="margin-bottom: 10px;">
                                <label
                                    style="font-size: 10px; display: block; margin-bottom: 3px; opacity: 0.5;">–†–µ–∑–µ—Ä–≤–Ω—ã–µ
                                    –∫–ª—é—á–∏ (–ª—é–±—ã–µ):</label>
                                <textarea id="aiBackupKeys" rows="2" placeholder="–î–æ–ø. –∫–ª—é—á–∏..."
                                    onchange="saveAISettings()"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 8px; padding: 6px; font-size: 10px; outline: none;"></textarea>
                            </div>

                            <button onclick="saveAISettings()"
                                style="width: 100%; background: var(--success-color); color: black; font-weight: bold; font-size: 11px; padding: 8px; border-radius: 8px; border: none; margin-bottom: 15px;">üíæ
                                –°–û–•–†–ê–ù–ò–¢–¨ –ù–ê–°–¢–†–û–ô–ö–ò</button>


                            <span style="font-size: 11px;">–õ–∏–º–∏—Ç (—Å–µ–≥–æ–¥–Ω—è):</span>
                            <span id="adminDailyCount" style="font-size: 12px; font-weight: bold;">0 / 20</span>
                        </div>

                        <h6 style="margin: 10px 0 5px 0; font-size: 10px; opacity: 0.6;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:</h6>
                        <div id="adminChatHistory"
                            style="max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 8px; font-size: 10px; font-family: monospace; margin-bottom: 5px;">
                            <div style="text-align: center; opacity: 0.4;">–ü—É—Å—Ç–æ</div>
                        </div>
                        <button onclick="clearChatHistory()"
                            style="width: 100%; background: rgba(255, 61, 113, 0.1); border: 1px solid rgba(255, 61, 113, 0.3); color: var(--danger-color); font-size: 10px; padding: 5px; border-radius: 6px;">–û—á–∏—Å—Ç–∏—Ç—å
                            –∏—Å—Ç–æ—Ä–∏—é AI</button>
                    </div>

                    <div style="margin-top: 15px;">
                        <h5
                            style="margin: 0 0 10px 0; font-size: 12px; opacity: 0.8; display: flex; justify-content: space-between;">
                            <span>üìú –õ–µ–Ω—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π:</span>
                            <span style="font-size: 10px; color: var(--accent-color); cursor: pointer;"
                                onclick="clearAuditLog()">–æ—á–∏—Å—Ç–∏—Ç—å</span>
                        </h5>
                        <div id="adminActivityLog"
                            style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 12px; font-size: 11px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05);">
                            <!-- Activity log items -->
                            <div style="opacity: 0.5; text-align: center; padding: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <h5 style="margin: 0 0 10px 0; font-size: 12px; opacity: 0.8;">–ò—Å—Ç–æ—Ä–∏—è –ø–∞—Ä–æ–ª–µ–π (–û–±–ª–∞–∫–æ):</h5>
                        <div id="adminPassHistory"
                            style="max-height: 100px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 8px; font-size: 11px; margin-bottom: 10px; font-family: monospace;">
                            <!-- History items -->
                        </div>
                    </div>
                </div>

                <div
                    style="margin-top: 20px; background: rgba(255,255,255,0.05); padding: 18px; border-radius: 18px; border: 1px solid var(--glass-border);">
                    <h4
                        style="margin-top: 0; margin-bottom: 12px; color: var(--accent-color); font-size: 13px; text-transform: uppercase; letter-spacing: 1.5px;">
                        –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:</h4>
                    <div style="font-size: 13px; line-height: 1.6; color: var(--text-color); opacity: 0.9;">
                        <p style="margin-bottom: 10px;">üíæ <b>–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∫–æ–ø–∏—é:</b> –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø, —á—Ç–æ–±—ã –Ω–µ
                            –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ.</p>
                        <p style="margin: 0;">üîÑ <b>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:</b> –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–ø–∞–ª–∏ ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª –∏
                            –≤—ã–±–µ—Ä–∏—Ç–µ
                            —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞. –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏—Å—Ç–æ—Ä–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–µ—Ä–Ω—É—Ç—Å—è.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal">
        <div class="chat-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <img src="ai_assistant.png" style="width: 30px; height: 30px; border-radius: 50%;">
                <span style="font-weight: bold; letter-spacing: 1px;">VAPE AI</span>
            </div>
            <button onclick="closeChatModal()"
                style="background: none; border: none; color: var(--text-secondary); font-size: 24px;">&times;</button>
        </div>
        <div id="chatMessages" class="chat-messages">
            <div class="message ai">–ô–æ, –±—Ä–æ! ü§ô –Ø –Ω–∞ —Å–≤—è–∑–∏. –ß–µ–º –ø–æ–º–æ—á—å –ø–æ —à–æ–ø—É?</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="–°–ø—Ä–æ—Å–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–°–∫–æ–ª—å–∫–æ –≤—ã—Ä—É—á–∫–∞?'"
                onkeypress="handleChatEnter(event)">
            <button class="send-btn" onclick="sendChatMessage()">‚û§</button>
        </div>
    </div>

    <!-- Force Password Setup Modal -->
    <div id="forceSetupModal" class="modal-overlay" style="z-index: 20000; background: var(--bg-color);">
        <div class="modal-card">
            <h3 style="letter-spacing: 2px; color: var(--danger-color);">‚ö†Ô∏è –£–°–¢–ê–ù–û–í–ò–¢–ï –ü–ê–†–û–õ–¨</h3>
            <p style="font-size: 14px; opacity: 0.9; line-height: 1.5; margin-bottom: 20px;">
                –í–∞—à –ø–∞—Ä–æ–ª—å –±—ã–ª —Å–±—Ä–æ—à–µ–Ω. –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–¥—É–º–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å.
            </p>
            <div class="input-group">
                <input type="password" id="forceNewPass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
            </div>
            <div class="input-group">
                <input type="password" id="forceConfirmPass" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <div id="forceSetupError" style="color: #ff3b30; font-size: 13px; margin-bottom: 15px; display: none;">
            </div>

            <button class="main-btn" onclick="saveForcedPassword()">–°–û–•–†–ê–ù–ò–¢–¨ –ò –í–û–ô–¢–ò</button>
        </div>
    </div>

    <!-- Help Page Modal -->
    <div id="helpPageModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 600px; margin: 0 auto; padding: calc(45px + var(--safe-area-top)) 20px 120px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; font-size: 18px; letter-spacing: 2px;">–ö–ê–ö –ü–û–õ–¨–ó–û–í–ê–¢–¨–°–Ø?</h2>
                <button onclick="closeHelpPage()"
                    style="background: none; border: none; font-size: 28px; color: var(--text-color); cursor: pointer; padding: 10px;">‚úï</button>
            </div>

            <!-- Sales Section -->
            <div class="input-card" style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: var(--accent-color);">üí∏ –ü—Ä–æ–¥–∞–∂–∏</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–ó–¥–µ—Å—å –≤—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç–µ –∫–∞–∂–¥—É—é –ø—Ä–æ–¥–∞–∂—É:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><b>–ù–∞–∑–≤–∞–Ω–∏–µ</b> ‚Äî –Ω–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å, –∏ —Ç–æ–≤–∞—Ä—ã —Å–æ —Å–∫–ª–∞–¥–∞ –ø–æ—è–≤—è—Ç—Å—è –≤ –ø–æ–¥—Å–∫–∞–∑–∫–∞—Ö</li>
                        <li><b>–ö–æ–ª-–≤–æ</b> ‚Äî —Å–∫–æ–ª—å–∫–æ —à—Ç—É–∫ –ø—Ä–æ–¥–∞–ª–∏</li>
                        <li><b>–¶–µ–Ω–∞</b> ‚Äî –∑–∞ —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–¥–∞–ª–∏ (—Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏)</li>
                    </ul>
                    <p style="margin: 10px 0 0 0;">–ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Ç–æ–≤–∞—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å–æ —Å–∫–ª–∞–¥–∞, –∞ –ø—Ä–∏–±—ã–ª—å
                        —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫: —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ ‚àí –∑–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞.</p>
                </div>
            </div>

            <!-- Inventory Section -->
            <div class="input-card" style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: var(--accent-color);">üì¶ –°–∫–ª–∞–¥</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–°—é–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç–µ —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–∫—É–ø–∏–ª–∏:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><b>–ù–∞–∑–≤–∞–Ω–∏–µ</b> ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: Brusko –Ø–≥–æ–¥–Ω—ã–π –º–∏–∫—Å)</li>
                        <li><b>–ö–æ–ª-–≤–æ</b> ‚Äî —Å–∫–æ–ª—å–∫–æ —à—Ç—É–∫ –∑–∞–∫—É–ø–∏–ª–∏</li>
                        <li><b>–ó–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞</b> ‚Äî –∑–∞ —Å–∫–æ–ª—å–∫–æ –∫—É–ø–∏–ª–∏ (–æ–¥–Ω–∞ —à—Ç—É–∫–∞)</li>
                    </ul>
                    <p style="margin: 10px 0 0 0;">–ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ –µ—Å—Ç—å ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫
                        —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é.</p>
                </div>
            </div>

            <!-- Losses Section -->
            <div class="input-card" style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: var(--accent-color);">üìâ –£–±—ã—Ç–∫–∏</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –ø–æ—Ç–µ—Ä–∏: –±—Ä–∞–∫, –∫—Ä–∞–∂–∞, –ø—Ä–æ—Å—Ä–æ—á–∫–∞ –∏ —Ç.–¥.</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><b>–ù–∞–∑–≤–∞–Ω–∏–µ</b> ‚Äî –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∏–∑ —Å–∫–ª–∞–¥–∞ –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</li>
                        <li><b>–ö–æ–ª-–≤–æ</b> ‚Äî —Å–∫–æ–ª—å–∫–æ —à—Ç—É–∫ –ø–æ—Ç–µ—Ä—è–Ω–æ</li>
                        <li><b>–ó–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞</b> ‚Äî –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—É–º–º—ã —É–±—ã—Ç–∫–∞</li>
                        <li><b>–ü—Ä–∏—á–∏–Ω–∞</b> ‚Äî –ø–æ—á–µ–º—É —Ç–æ–≤–∞—Ä —Å–ø–∏—Å–∞–Ω</li>
                        <li><b>–°–ø–∏—Å–∞—Ç—å —Å–æ —Å–∫–ª–∞–¥–∞</b> ‚Äî —É–º–µ–Ω—å—à–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</li>
                    </ul>
                </div>
            </div>

            <!-- Stats Section -->
            <div class="input-card" style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: var(--accent-color);">üìä –ò—Ç–æ–≥–∏</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><b>–í—ã—Ä—É—á–∫–∞</b> ‚Äî —Å—É–º–º–∞ –≤—Å–µ—Ö –ø—Ä–æ–¥–∞–∂</li>
                        <li><b>–ü—Ä–∏–±—ã–ª—å</b> ‚Äî –≤—ã—Ä—É—á–∫–∞ –º–∏–Ω—É—Å –∑–∞–∫—É–ø–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</li>
                        <li><b>–£–±—ã—Ç–∫–∏</b> ‚Äî –æ–±—â–∞—è —Å—É–º–º–∞ —Å–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</li>
                        <li><b>–¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤</b> ‚Äî —Å–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏</li>
                    </ul>
                    <p style="margin: 10px 0 0 0;">–ú–æ–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –¥–∞—Ç–∞–º –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞ –¥–µ–Ω—å, –Ω–µ–¥–µ–ª—é –∏–ª–∏ –º–µ—Å—è—Ü.
                    </p>
                </div>
            </div>

            <!-- Data Section -->
            <div class="input-card">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: var(--accent-color);">‚öôÔ∏è –ò–Ω—Ñ–æ</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><b>–ë—ç–∫–∞–ø</b> ‚Äî —Å–∫–∞—á–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª</li>
                        <li><b>–ó–∞–≥—Ä—É–∑–∏—Ç—å</b> ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞</li>
                        <li><b>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</b> ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±—ç–∫–∞–ø —á–µ—Ä–µ–∑ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</li>
                    </ul>
                    <p style="margin: 10px 0 0 0;">‚ö†Ô∏è –î–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø —Ä–µ–≥—É–ª—è—Ä–Ω–æ! –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏ –º–æ–≥—É—Ç
                        –ø—Ä–æ–ø–∞—Å—Ç—å –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞.</p>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, query, orderBy, limit, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBPDXk_HldcpjSTWHfIq00pAm-U_0EuaQQ",
            authDomain: "vape-price.firebaseapp.com",
            projectId: "vape-price",
            storageBucket: "vape-price.firebasestorage.app",
            messagingSenderId: "251545583200",
            appId: "1:251545583200:web:037acd5796580e28c6cd05",
            measurementId: "G-03V6W6RVYL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        enableIndexedDbPersistence(db).catch((err) => {
            console.warn('Persistence status:', err.code);
        });

        window.db = db;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.addDoc = addDoc;
        window.collection = collection;
        window.doc = doc;
        window.auth = auth;
        window.query = query;
        window.orderBy = orderBy;
        window.limit = limit;
        window.getDocs = getDocs;

        // Legacy compatibility
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseAuth = auth;


        // Obfuscated credentials decoder
        const _0x4a2b = (s) => atob(s);
        const _0x3c1d = () => {
            const p1 = _0x4a2b('YWRtaW5AdmFwZS5jb20=');
            const p2 = _0x4a2b('YXJ0ZW12YXBl');
            return [p1, p2];
        };

        window.addEventListener('online', async () => {
            if (!auth.currentUser) {
                const [e, p] = _0x3c1d();
                try {
                    await signInWithEmailAndPassword(auth, e, p);
                } catch (err) {
                    console.error("Re-auth failed:", err);
                }
            }
            updateSyncUI(navigator.onLine && !!auth.currentUser);
        });

        // Auto-login to Firebase
        let cloudSub = null;
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Firebase Authenticated üîì");



                updateSyncUI(true);

                // Real-time listener: data will sync instantly across devices
                if (cloudSub) cloudSub();
                cloudSub = onSnapshot(doc(db, "tracker", "mainData"), (docSnap) => {
                    if (docSnap.exists()) {

                        processCloudUpdate(docSnap.data());
                    } else {

                    }
                }, (err) => {
                    console.error("Cloud Listener Error:", err);

                    updateSyncUI(false);
                });
            } else {
                console.log("Authenticating Firebase...");




                const [e, p] = _0x3c1d();
                signInWithEmailAndPassword(auth, e, p)
                    .catch(err => {
                        console.error("Firebase Auth Error:", err);


                        updateSyncUI(false);
                    });
            }
        });

        window.addEventListener('offline', () => updateSyncUI(false));

        let isCloudOnline = true;

        function updateSyncUI(online) {
            isCloudOnline = online;
            const title = document.getElementById('appTitle');
            if (title) {
                if (online) {
                    title.classList.remove('offline');
                    title.textContent = 'VAPE TRACKER';
                } else {
                    title.classList.add('offline');
                    title.textContent = 'VAPE TRACKER !';
                }
            }
        }

        function handleTitleClick() {
            if (!isCloudOnline) {
                showToast("–í–æ–∑–º–æ–∂–Ω–æ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ, –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –±—É–¥–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ.", "error");
            }
        }
    </script>

    <script>
        // Auth Check
        if (!sessionStorage.getItem('vapeAuth') && !localStorage.getItem('vapeAuth')) {
            window.location.href = 'login.html';
        }

        // Data State
        let sales = JSON.parse(localStorage.getItem('vapeSales')) || [];
        let inventory = JSON.parse(localStorage.getItem('vapeInventory')) || [];
        let losses = JSON.parse(localStorage.getItem('vapeLosses')) || [];
        let debts = JSON.parse(localStorage.getItem('vapeDebts')) || [];
        let notes = JSON.parse(localStorage.getItem('vapeNotes')) || [];
        let financialGoal = parseInt(localStorage.getItem('vapeFinancialGoal')) || 0;

        function updateDatalist() {
            // This function used to update a datalist, but we moved to custom autocomplete.
            // We keep it defined to prevent crashes since it's called in multiple places.
            console.log('Datalist updated');
        }

        // Load cloud data on startup removed from here, handled by onAuthStateChanged
        let sortType = localStorage.getItem('vapeSortType') || 'date';
        let sortDir = localStorage.getItem('vapeSortDir') || 'desc';
        let statsPeriod = 'day';

        // Anti-duplicate protection vars
        let lastAddedSignature = '';
        let lastAddedTime = 0;

        let pendingInventoryItem = null;
        let vapeDontAskMerge = localStorage.getItem('vapeDontAskMerge') === 'true';

        // Loading animation
        window.addEventListener('DOMContentLoaded', () => {
            const overlay = document.getElementById('loadingOverlay');
            setTimeout(() => {
                overlay.classList.add('hidden');
                setTimeout(() => overlay.remove(), 400);
            }, 600); // Show for 600ms
        });

        // Tab Switching
        let isSwitching = false;

        function switchTab(tabName) {
            if (isSwitching) return;
            triggerHaptic('light');

            const tabs = document.querySelectorAll('.tab');
            let targetTab = null;
            tabs.forEach(t => {
                if (t.getAttribute('onclick').includes(`'${tabName}'`)) {
                    targetTab = t;
                }
            });

            const currentTab = document.querySelector('.tab.active');
            if (currentTab === targetTab) return;

            isSwitching = true;

            // 1. Update Tabs immediately
            tabs.forEach(t => t.classList.remove('active'));
            if (targetTab) targetTab.classList.add('active');

            // 2. Find target page
            let targetPageId = 'salesPage';
            if (tabName === 'inventory') targetPageId = 'inventoryPage';
            else if (tabName === 'debts') targetPageId = 'debtsPage';
            else if (tabName === 'losses') targetPageId = 'lossesPage';
            else if (tabName === 'stats') targetPageId = 'statsPage';
            else if (tabName === 'data') targetPageId = 'dataPage';

            const targetPage = document.getElementById(targetPageId);
            const activePage = document.querySelector('.page.active');

            // Helper to render data
            const renderData = () => {
                if (tabName === 'sales') renderSales();
                else if (tabName === 'inventory') renderInventory();
                else if (tabName === 'debts') renderDebts();
                else if (tabName === 'losses') renderLosses();
                else if (tabName === 'stats') renderStats();
                else if (tabName === 'data') updateInfoPageStats();
            };

            // 3. Sequential Transition
            if (activePage) {
                // Fade out old
                activePage.classList.remove('active');

                // Wait for CSS transition (300ms)
                setTimeout(() => {
                    activePage.style.display = 'none';
                    window.scrollTo(0, 0);

                    renderData(); // Update data before showing

                    // Show new page (invisible state)
                    targetPage.style.display = 'block';
                    // Force reflow
                    void targetPage.offsetWidth;

                    // Fade in new
                    targetPage.classList.add('active');

                    isSwitching = false;
                }, 300);
            } else {
                // Initial load or edge case
                renderData();
                targetPage.style.display = 'block';
                setTimeout(() => targetPage.classList.add('active'), 10);
                isSwitching = false;
            }
        }

        // Inventory Logic
        function addInventory() {
            const name = document.getElementById('invName').value.trim();
            const strength = document.getElementById('invStrength').value.trim();
            const qty = parseInt(document.getElementById('invQty').value);
            const cost = parseFloat(document.getElementById('invCost').value);
            const price = parseFloat(document.getElementById('invPrice').value);

            if (name && !isNaN(qty) && !isNaN(cost) && !isNaN(price)) {
                const newItem = { id: Date.now(), name, strength, qty, cost, price };

                // Check for strict duplicate (Name + Strength + Cost + Price)
                const existing = inventory.find(i =>
                    i.name.toLowerCase() === name.toLowerCase() &&
                    (i.strength || '').toLowerCase() === strength.toLowerCase() &&
                    i.cost === cost &&
                    i.price === price
                );

                if (existing && !vapeDontAskMerge) {
                    pendingInventoryItem = newItem;
                    document.getElementById('duplicateConflictModal').style.display = 'flex';
                } else if (existing && vapeDontAskMerge) {
                    // Merge automatically if user said "don't ask"
                    existing.qty += qty;
                    finalizeInventoryAdd();
                } else {
                    inventory.push(newItem);
                    finalizeInventoryAdd();
                }
            } else {
                alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è —Å–∫–ª–∞–¥–∞!");
            }
        }

        function handleMergeResult(action) {
            if (!pendingInventoryItem) return;

            if (action === 'merge') {
                const existing = inventory.find(i =>
                    i.name.toLowerCase() === pendingInventoryItem.name.toLowerCase() &&
                    (i.strength || '').toLowerCase() === (pendingInventoryItem.strength || '').toLowerCase() &&
                    i.cost === pendingInventoryItem.cost &&
                    i.price === pendingInventoryItem.price
                );
                if (existing) existing.qty += pendingInventoryItem.qty;
            } else {
                inventory.push(pendingInventoryItem);
            }

            if (document.getElementById('dontAskMerge').checked) {
                vapeDontAskMerge = true;
                localStorage.setItem('vapeDontAskMerge', 'true');
            }

            finalizeInventoryAdd();
            document.getElementById('duplicateConflictModal').style.display = 'none';
        }

        function finalizeInventoryAdd() {
            document.getElementById('invName').value = '';
            document.getElementById('invStrength').value = '';
            document.getElementById('invQty').value = '';
            document.getElementById('invCost').value = '';
            document.getElementById('invPrice').value = '';
            pendingInventoryItem = null;
            saveData();
            renderInventory();
        }

        function deleteInventory(id) {
            if (confirm("–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä —Å–æ —Å–∫–ª–∞–¥–∞?")) {
                inventory = inventory.filter(i => i.id !== id);
                saveData();
                renderInventory();
                updateDatalist();
            }
        }

        function renderInventory() {
            const display = document.getElementById('inventoryDisplay');
            display.innerHTML = '';

            let totalCost = 0;
            let totalRevenue = 0;
            let totalCount = 0;
            inventory.forEach(item => {
                totalCost += item.cost * item.qty;
                totalRevenue += (item.price || 0) * item.qty;
                totalCount += item.qty;
            });

            document.getElementById('invTotalCost').textContent = totalCost.toLocaleString('ru-RU');
            document.getElementById('invTotalRevenue').textContent = totalRevenue.toLocaleString('ru-RU');
            document.getElementById('invTotalCount').textContent = totalCount.toLocaleString('ru-RU');
            document.getElementById('invTotalVariety').textContent = inventory.length.toLocaleString('ru-RU');

            if (inventory.length === 0) {
                display.innerHTML = '<div class="empty-state">–°–∫–ª–∞–¥ –ø—É—Å—Ç</div>';
                return;
            }

            inventory.forEach(item => {
                const lowStockWarning = item.qty === 1 ? '<span class="low-stock-warning">‚ö†Ô∏è –ü–æ—Å–ª–µ–¥–Ω–∏–π!</span>' :
                    item.qty === 0 ? '<span class="low-stock-warning" style="background: #666;">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>' : '';

                const cardMarkup = `
                    <div class="item-info">
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <b style="font-size: 17px;">${item.name}</b>
                            ${item.strength ? `<span class="badge" style="background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); padding: 5px 10px; opacity: 0.8;">${item.strength}</span>` : ''}
                            <button class="edit-btn" onclick="openEdit(${item.id})">‚úé</button>
                            ${lowStockWarning}
                        </div>
                        <small style="margin-top: 5px; display: block;">–í –Ω–∞–ª–∏—á–∏–∏: ${item.qty} —à—Ç. | –ó–∞–∫—É–ø: ${item.cost} ‚ÇΩ | –ü—Ä–æ–¥.: ${item.price || 0} ‚ÇΩ</small>
                    </div>
                    <div class="item-right" style="flex-direction: row; align-items: center; gap: 8px;">
                        <div class="qty-controls">
                            <div class="qty-btn" onclick="updateQty(${item.id}, -1)">‚àí</div>
                            <div class="qty-btn" onclick="updateQty(${item.id}, 1)">+</div>
                        </div>
                        <button class="delete-btn" onclick="deleteInventory(${item.id})">√ó</button>
                    </div>
                `;
                const wrapper = createSwipeWrapper(cardMarkup, () => deleteInventory(item.id));
                display.appendChild(wrapper);
            });
        }

        function updateQty(id, change) {
            const item = inventory.find(i => i.id === id);
            if (item) {
                item.qty = Math.max(0, item.qty + change);
                saveData();
                renderInventory();
            }
        }

        function openEdit(id) {
            const item = inventory.find(i => i.id === id);
            if (item) {
                document.getElementById('editItemId').value = id;
                document.getElementById('editName').value = item.name;
                document.getElementById('editStrength').value = item.strength || '';
                document.getElementById('editCost').value = item.cost;
                document.getElementById('editPrice').value = item.price;
                document.getElementById('editModal').style.display = 'flex';
            }
        }

        function closeModal() {
            triggerHaptic('light');
            document.getElementById('editModal').style.display = 'none';
        }

        function saveEdit() {
            const id = parseInt(document.getElementById('editItemId').value);
            const name = document.getElementById('editName').value.trim();
            const strength = document.getElementById('editStrength').value.trim();
            const cost = parseFloat(document.getElementById('editCost').value);
            const price = parseFloat(document.getElementById('editPrice').value);

            if (name && !isNaN(cost) && !isNaN(price)) {
                const item = inventory.find(i => i.id === id);
                if (item) {
                    item.name = name;
                    item.strength = strength;
                    item.cost = cost;
                    item.price = price;
                    saveData();
                    renderInventory();
                    closeModal();
                }
            } else {
                alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
            }
        }

        // Autocomplete Logic
        function handleAutocomplete(input) {
            const val = input.value.toLowerCase();
            const list = document.getElementById('autocompleteList');
            list.innerHTML = '';

            if (!val && document.activeElement !== input) {
                list.style.display = 'none';
                return;
            }

            const matches = inventory.filter(i => i.name.toLowerCase().includes(val));

            if (matches.length > 0) {
                matches.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.innerHTML = `
                        <div style="display: flex; flex-direction: column;">
                            <b>${item.name}</b>
                            <small style="opacity: 0.6; font-size: 10px;">${item.strength || ''}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: var(--accent-color); font-weight: bold;">${item.price || 0} ‚ÇΩ</div>
                            <small style="opacity: 0.5;">${item.qty} —à—Ç.</small>
                        </div>
                    `;
                    div.style.display = 'flex';
                    div.style.justifyContent = 'space-between';
                    div.style.alignItems = 'center';

                    div.onclick = () => {
                        input.value = item.name;
                        document.getElementById('salePrice').value = item.price || '';
                        const qtyInput = document.getElementById('saleQty');
                        if (!qtyInput.value) qtyInput.value = 1;
                        list.style.display = 'none';
                    };
                    list.appendChild(div);
                });
                list.style.display = 'block';
            } else {
                list.style.display = 'none';
            }
        }

        // Close lists on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                document.getElementById('autocompleteList').style.display = 'none';
            }
        });

        // Sales Logic
        function toggleDateInput() {
            const useDate = document.getElementById('useDate').checked;
            document.getElementById('manualDateContainer').style.display = useDate ? 'none' : 'block';
        }

        function toggleCustomerInput() {
            const isDebt = document.getElementById('isDebt').checked;
            const showBuyer = document.getElementById('showBuyer').checked;
            document.getElementById('debtorNameContainer').style.display = (isDebt || showBuyer) ? 'flex' : 'none';
        }

        function toggleDebtColor() {
            const isDebt = document.getElementById('isDebt').checked;
            const btn = document.getElementById('addSaleBtn');
            if (isDebt) {
                btn.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
                btn.innerText = '–í –î–û–õ–ì';
            } else {
                btn.style.background = '';
                btn.innerText = '–ü–†–û–î–ê–¢–¨';
            }
        }

        function addSale() {
            const name = document.getElementById('saleName').value.trim();
            const qty = parseInt(document.getElementById('saleQty').value);
            const price = parseFloat(document.getElementById('salePrice').value);
            const useDate = document.getElementById('useDate').checked;
            const manualDate = document.getElementById('saleDate').value;
            const isDebt = document.getElementById('isDebt').checked;
            const debtorName = document.getElementById('debtorName').value.trim();
            const debtorContact = document.getElementById('debtorContact').value.trim();
            const debtorSocial = document.getElementById('debtorSocial').value.trim();
            const saleNote = document.getElementById('saleNote').value.trim();

            if (!name || isNaN(qty) || isNaN(price)) {
                alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è –ø—Ä–æ–¥–∞–∂–∏!");
                return;
            }

            if (isDebt && !debtorName) {
                alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–æ–ª–∂–Ω–∏–∫–∞!");
                return;
            }

            // Anti-duplication check
            const currentSignature = `${name}|${qty}|${price}`;
            const timeNow = Date.now();
            if (currentSignature === lastAddedSignature && (timeNow - lastAddedTime < 5000)) {
                const btn = document.getElementById('addSaleBtn');
                btn.classList.add('btn-error');
                btn.innerText = '–ü–û–î–û–ñ–î–ò–¢–ï...';
                setTimeout(() => {
                    btn.classList.remove('btn-error');
                    btn.innerText = '–ü–†–û–î–ê–¢–¨';
                }, 1000);
                return;
            }

            let costPrice = 0;
            // Deduct from inventory if matched
            const invItem = inventory.find(i => i.name.toLowerCase() === name.toLowerCase());
            if (invItem) {
                if (invItem.qty < qty) {
                    if (!confirm(`–ù–∞ —Å–∫–ª–∞–¥–µ –≤—Å–µ–≥–æ ${invItem.qty}. –ü—Ä–æ–¥–∞—Ç—å –≤—Å–µ —Ä–∞–≤–Ω–æ?`)) return;
                }
                costPrice = invItem.cost;
                invItem.qty -= qty;
            }

            const now = new Date();
            let saleDateStr = now.toLocaleDateString('ru-RU');
            if (!useDate) {
                if (manualDate) {
                    const d = new Date(manualDate);
                    saleDateStr = d.toLocaleDateString('ru-RU');
                } else {
                    saleDateStr = '–ë–µ–∑ –¥–∞—Ç—ã';
                }
            }

            const sale = {
                id: Date.now(),
                name,
                qty,
                price,
                cost: costPrice,
                date: saleDateStr,
                timestamp: now.getTime(),
                isDebt,
                debtor: debtorName || null,
                contact: debtorContact || null,
                social: debtorSocial || null,
                note: saleNote || null
            };

            if (isDebt) {
                debts.unshift(sale);
                saveData(`–î–æ–±–∞–≤–ª–µ–Ω –¥–æ–ª–≥: ${debtorName} (${name})`);
                showToast("–î–æ–ª–≥ –∑–∞–ø–∏—Å–∞–Ω ü§ù");
            } else {
                sales.unshift(sale);
                saveData(`–ü—Ä–æ–¥–∞–∂–∞: ${name}`);
                showToast("–ü—Ä–æ–¥–∞–Ω–æ! üí∏");
            }

            lastAddedSignature = currentSignature;
            lastAddedTime = timeNow;

            saveData();
            renderSales();
            renderDebts();
            renderInventory();
            updateDatalist();

            document.getElementById('saleName').value = '';
            document.getElementById('saleQty').value = '';
            document.getElementById('salePrice').value = '';
            document.getElementById('saleNote').value = '';
            document.getElementById('isDebt').checked = false;
            document.getElementById('showBuyer').checked = false;
            document.getElementById('debtorNameContainer').style.display = 'none';
            document.getElementById('debtorName').value = '';
            document.getElementById('debtorContact').value = '';
            document.getElementById('debtorSocial').value = '';
        }

        function deleteSale(id) {
            if (confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É?")) {
                sales = sales.filter(s => s.id !== id);
                saveData();
                renderSales();
            }
        }

        // Edit Sale Functions
        function openSaleEdit(id) {
            const sale = sales.find(s => s.id === id);
            if (sale) {
                document.getElementById('editSaleId').value = id;
                document.getElementById('editSaleName').value = sale.name || '';
                document.getElementById('editSaleQty').value = sale.qty || '';
                document.getElementById('editSalePrice').value = sale.price || '';
                document.getElementById('editSaleNote').value = sale.note || '';
                document.getElementById('editSaleModal').style.display = 'flex';
            }
        }

        function closeSaleModal() {
            document.getElementById('editSaleModal').style.display = 'none';
        }

        function saveSaleEdit() {
            const id = parseInt(document.getElementById('editSaleId').value);
            const name = document.getElementById('editSaleName').value.trim();
            const qty = parseInt(document.getElementById('editSaleQty').value);
            const price = parseFloat(document.getElementById('editSalePrice').value);

            if (!name || isNaN(qty) || isNaN(price)) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            const sale = sales.find(s => s.id === id);
            if (sale) {
                sale.name = name;
                sale.qty = qty;
                sale.price = price;
                sale.note = document.getElementById('editSaleNote').value.trim() || null;
                saveData();
                renderSales();
                closeSaleModal();
            }
        }

        function setSortType(type) {
            sortType = type;
            localStorage.setItem('vapeSortType', type);
            renderSales();
        }

        function toggleSortDir() {
            sortDir = sortDir === 'desc' ? 'asc' : 'desc';
            localStorage.setItem('vapeSortDir', sortDir);
            renderSales();
        }

        function updateSortUI() {
            document.getElementById('sortType').value = sortType;
            const dirBtn = document.getElementById('sortDirBtn');
            dirBtn.innerText = sortDir === 'desc' ? '‚Üì' : '‚Üë';
            dirBtn.style.display = sortType === 'profit_day' ? 'none' : 'flex';
        }

        function renderSales() {
            const display = document.getElementById('salesDisplay');
            const totalRevEl = document.getElementById('totalRevenue');
            const totalProfEl = document.getElementById('totalProfit');
            const filterDate = document.getElementById('dateFilter').value;

            display.innerHTML = '';

            updateSortUI();

            if (!['date', 'amount', 'name', 'popular', 'profit_day'].includes(sortType)) {
                sortType = 'date';
                localStorage.setItem('vapeSortType', 'date');
                updateSortUI();
            }

            let filteredSales = sales;
            if (filterDate) {
                const [y, m, d] = filterDate.split('-');
                const formattedFilter = `${parseInt(d)}.${parseInt(m)}.${y}`;
                filteredSales = sales.filter(s => {
                    const [sd, sm, sy] = s.date.split('.');
                    return `${parseInt(sd)}.${parseInt(sm)}.${sy}` === formattedFilter;
                });
            }

            let totalRev = 0;
            let totalProf = 0;

            // Stats (Filtered by date)
            filteredSales.forEach(s => {
                totalRev += (s.price * s.qty);
                totalProf += (s.price - (s.cost || 0)) * s.qty;
            });

            if (totalRevEl) totalRevEl.innerText = totalRev.toLocaleString('ru-RU');
            if (totalProfEl) totalProfEl.innerText = totalProf.toLocaleString('ru-RU');

            // Update Goal Progress
            updateGoalUI(totalRev);

            if (filteredSales.length === 0) {
                display.innerHTML = `<div class="empty-state">${filterDate ? '–ù–∞ —ç—Ç—É –¥–∞—Ç—É –ø—É—Å—Ç–æ' : '–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–¥–∞–∂'}</div>`;
                return;
            }

            if (sortType === 'date' || sortType === 'profit_day') {
                // Grouped views
                const groups = {};
                filteredSales.forEach(s => {
                    if (!groups[s.date]) {
                        groups[s.date] = { items: [], totalProfit: 0, dateObj: null };
                        if (s.date !== '–ë–µ–∑ –¥–∞—Ç—ã') {
                            const [d, m, y] = s.date.split('.');
                            groups[s.date].dateObj = new Date(y, m - 1, d);
                        }
                    }
                    groups[s.date].items.push(s);
                    groups[s.date].totalProfit += (s.price - (s.cost || 0)) * s.qty;
                });

                const sortedDates = Object.keys(groups).sort((a, b) => {
                    if (sortType === 'profit_day') {
                        return groups[b].totalProfit - groups[a].totalProfit;
                    } else if (sortDir === 'desc') {
                        if (a === '–ë–µ–∑ –¥–∞—Ç—ã') return 1;
                        if (b === '–ë–µ–∑ –¥–∞—Ç—ã') return -1;
                        return (groups[b].dateObj || 0) - (groups[a].dateObj || 0);
                    } else {
                        if (a === '–ë–µ–∑ –¥–∞—Ç—ã') return -1;
                        if (b === '–ë–µ–∑ –¥–∞—Ç—ã') return 1;
                        return (groups[a].dateObj || 0) - (groups[b].dateObj || 0);
                    }
                });

                sortedDates.forEach(date => {
                    const group = groups[date];
                    const div = document.createElement('div');
                    let html = `<div class="date-divider">${date} ${sortType === 'profit_day' ? `<span style="font-size:10px; opacity:0.7; margin-left:auto;">+${group.totalProfit.toLocaleString('ru-RU')} ‚ÇΩ</span>` : ''}</div>`;

                    const container = document.createElement('div');
                    group.items.forEach(s => {
                        const profit = (s.price - s.cost) * s.qty;
                        const cardMarkup = `
                            <div class="item-info">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <b>${s.name}</b>
                                    <button class="edit-btn" onclick="openSaleEdit(${s.id})">‚úé</button>
                                </div>
                                <small>${sortType === 'profit_day' ? s.date + ' ‚Ä¢ ' : ''}${s.qty} —à—Ç. √ó ${s.price} ‚ÇΩ ${s.cost > 0 ? `<span class="badge badge-profit">+${profit.toLocaleString('ru-RU')} ‚ÇΩ</span>` : ''}</small>
                                ${s.debtor ? `<div style="font-size: 10px; margin-top: 4px; color: var(--accent-color); opacity: 0.8;">üë§ ${s.debtor}${s.contact || s.social ? ` ‚Ä¢ ${[s.contact, s.social].filter(x => x).join(' / ')}` : ''}</div>` : ''}
                                ${s.note ? `<div style="font-size: 10px; margin-top: 2px; opacity: 0.6; font-style: italic;">üìù ${s.note}</div>` : ''}
                            </div>
                            <div class="item-right">
                                <span class="item-price">${(s.price * s.qty).toLocaleString('ru-RU')} ‚ÇΩ</span>
                                <button class="delete-btn" onclick="deleteSale(${s.id})">√ó</button>
                            </div>
                        `;
                        const wrapper = createSwipeWrapper(cardMarkup,
                            () => deleteSale(s.id),
                            () => openSaleEdit(s.id),
                            '–£–¥–∞–ª–∏—Ç—å', '–ò–∑–º–µ–Ω–∏—Ç—å'
                        );
                        container.appendChild(wrapper);
                    });
                    div.innerHTML = html;
                    div.appendChild(container);
                    display.appendChild(div);
                });
            } else {
                // Flat views (Amount, Name, Popular)
                const itemsToSort = [...filteredSales];

                if (sortType === 'amount') {
                    itemsToSort.sort((a, b) => sortDir === 'desc' ? (b.price * b.qty) - (a.price * a.qty) : (a.price * a.qty) - (b.price * b.qty));
                } else if (sortType === 'name') {
                    itemsToSort.sort((a, b) => sortDir === 'desc' ? b.name.localeCompare(a.name) : a.name.localeCompare(b.name));
                } else if (sortType === 'popular') {
                    itemsToSort.sort((a, b) => sortDir === 'desc' ? b.qty - a.qty : a.qty - b.qty);
                }

                itemsToSort.forEach(s => {
                    const profit = (s.price - s.cost) * s.qty;
                    const cardMarkup = `
                        <div class="item-info">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <b>${s.name}</b>
                                <button class="edit-btn" onclick="openSaleEdit(${s.id})">‚úé</button>
                            </div>
                            <small>${s.date} ‚Ä¢ ${s.qty} —à—Ç. √ó ${s.price} ‚ÇΩ ${s.cost > 0 ? `<span class="badge badge-profit">+${profit.toLocaleString('ru-RU')} ‚ÇΩ</span>` : ''}</small>
                            ${s.debtor ? `<div style="font-size: 10px; margin-top: 4px; color: var(--accent-color); opacity: 0.8;">üë§ ${s.debtor}${s.contact || s.social ? ` ‚Ä¢ ${[s.contact, s.social].filter(x => x).join(' / ')}` : ''}</div>` : ''}
                            ${s.note ? `<div style="font-size: 10px; margin-top: 2px; opacity: 0.6; font-style: italic;">üìù ${s.note}</div>` : ''}
                        </div>
                        <div class="item-right">
                            <span class="item-price">${(s.price * s.qty).toLocaleString('ru-RU')} ‚ÇΩ</span>
                            <button class="delete-btn" onclick="deleteSale(${s.id})">√ó</button>
                        </div>
                    `;
                    const wrapper = createSwipeWrapper(cardMarkup, () => deleteSale(s.id), () => openSaleEdit(s.id), '–£–¥–∞–ª–∏—Ç—å', '–ò–∑–º–µ–Ω–∏—Ç—å');
                    display.appendChild(wrapper);
                });
            }
        }

        // Debts Logic
        function renderDebts() {
            const display = document.getElementById('debtsDisplay');
            const totalSumEl = document.getElementById('totalDebtsSum');
            display.innerHTML = '';

            let totalSum = 0;
            debts.forEach(d => totalSum += (d.price * d.qty));
            totalSumEl.textContent = totalSum.toLocaleString('ru-RU');

            if (debts.length === 0) {
                display.innerHTML = '<div class="empty-state">–î–æ–ª–≥–æ–≤ –Ω–µ—Ç üéâ</div>';
                return;
            }

            debts.forEach(d => {
                const markup = `
                    <div class="item-info">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <b style="color: #ff9800;">${d.debtor}</b>
                            <span class="badge badge-debt" style="font-size: 10px;">–î–û–õ–ì</span>
                        </div>
                        <small>${d.name} (${d.qty} —à—Ç.) ‚Ä¢ ${d.date}</small>
                        ${d.contact ? `<div style="font-size: 10px; margin-top: 4px; opacity: 0.7;">üìû ${d.contact}</div>` : ''}
                    </div>
                    <div class="item-right" style="flex-direction: row; gap: 10px; align-items: center;">
                        <span class="item-price" style="color: #ff9800;">${(d.price * d.qty).toLocaleString('ru-RU')} ‚ÇΩ</span>
                        <div style="display: flex; gap: 5px;">
                            <button class="qty-btn" style="background: rgba(0, 240, 170, 0.2); color: var(--success-color); border: 1px solid var(--success-color);" onclick="manageDebt(${d.id}, 'paid')">‚úì</button>
                            <button class="qty-btn" style="background: rgba(255, 59, 48, 0.2); color: var(--danger-color); border: 1px solid var(--danger-color);" onclick="manageDebt(${d.id}, 'forgive')">√ó</button>
                        </div>
                    </div>
                `;
                const wrapper = createSwipeWrapper(markup,
                    () => manageDebt(d.id, 'forgive'),
                    () => manageDebt(d.id, 'paid'),
                    '–ü—Ä–æ—Å—Ç–∏—Ç—å', '–û–ø–ª–∞—á–µ–Ω–æ'
                );
                display.appendChild(wrapper);
            });
        }

        function manageDebt(id, action) {
            const debt = debts.find(d => d.id === id);
            if (!debt) return;

            if (action === 'paid') {
                if (confirm(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É –¥–æ–ª–≥–∞ –æ—Ç ${debt.debtor}?`)) {
                    debts = debts.filter(d => d.id !== id);
                    debt.isDebt = false;
                    debt.debtor = null;
                    sales.unshift(debt);
                    saveData(`–î–æ–ª–≥ –æ–ø–ª–∞—á–µ–Ω: ${debt.debtor} (${debt.name})`);
                    showToast("–û–ø–ª–∞—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∞! üí∏");
                    renderDebts();
                    renderSales();
                }
            } else if (action === 'forgive') {
                if (confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ü–†–û–°–¢–ò–¢–¨ –¥–æ–ª–≥ ${debt.debtor}? –°—É–º–º–∞ —É–π–¥–µ—Ç –≤ —É–±—ã—Ç–∫–∏.`)) {
                    debts = debts.filter(d => d.id !== id);
                    const lossItem = {
                        id: Date.now(),
                        name: `–ü—Ä–æ—â–µ–Ω–Ω—ã–π –¥–æ–ª–≥: ${debt.debtor} (${debt.name})`,
                        cost: (debt.price * debt.qty), // Forgiving full retail amount as loss
                        qty: 1,
                        date: new Date().toLocaleDateString('ru-RU'),
                        reason: '–ü—Ä–æ—â–µ–Ω–Ω—ã–π –¥–æ–ª–≥'
                    };
                    losses.unshift(lossItem);
                    saveData(`–î–æ–ª–≥ –ø—Ä–æ—â–µ–Ω: ${debt.debtor}`);
                    showToast("–î–æ–ª–≥ –ø—Ä–æ—â–µ–Ω üìâ");
                    renderDebts();
                    renderLosses();
                }
            }
        }

        // Swipe Functionality
        function createSwipeWrapper(innerMarkup, onSwipeLeft, onSwipeRight, leftLabel = "–£–¥–∞–ª–∏—Ç—å", rightLabel = "–î–µ–π—Å—Ç–≤–∏–µ") {
            const wrapper = document.createElement('div');
            wrapper.className = 'item-card-wrapper';

            const leftAction = document.createElement('div');
            leftAction.className = 'swipe-action left';
            leftAction.innerHTML = `<span>${leftLabel}</span>`;

            const rightAction = document.createElement('div');
            rightAction.className = 'swipe-action right';
            rightAction.innerHTML = `<span>${rightLabel}</span>`;

            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = innerMarkup;

            wrapper.appendChild(leftAction);
            wrapper.appendChild(rightAction);
            wrapper.appendChild(card);

            // Swipe Logic
            let startX = 0;
            let currentX = 0;
            let isSwiping = false;
            const threshold = 100;

            card.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                isSwiping = true;
                card.style.transition = 'none';
            }, { passive: true });

            card.addEventListener('touchmove', (e) => {
                if (!isSwiping) return;
                currentX = e.touches[0].clientX - startX;

                // Resistance
                if (Math.abs(currentX) > 150) currentX = currentX > 0 ? 150 + (currentX - 150) * 0.2 : -150 + (currentX + 150) * 0.2;

                card.style.transform = `translateX(${currentX}px)`;

                // Show appropriate swipe action
                if (currentX > 10) {
                    rightAction.style.opacity = '1';
                    leftAction.style.opacity = '0';
                } else if (currentX < -10) {
                    leftAction.style.opacity = '1';
                    rightAction.style.opacity = '0';
                } else {
                    leftAction.style.opacity = '0';
                    rightAction.style.opacity = '0';
                }
            }, { passive: true });

            card.addEventListener('touchend', () => {
                isSwiping = false;
                card.style.transition = 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

                if (currentX > threshold && onSwipeRight) {
                    card.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        onSwipeRight();
                        if (card.parentElement) card.style.transform = 'translateX(0)';
                    }, 300);
                } else if (currentX < -threshold && onSwipeLeft) {
                    card.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                        onSwipeLeft();
                        if (card.parentElement) card.style.transform = 'translateX(0)';
                    }, 300);
                } else {
                    card.style.transform = 'translateX(0)';
                }

                // Hide swipe actions
                leftAction.style.opacity = '0';
                rightAction.style.opacity = '0';

                currentX = 0;
            });

            return wrapper;
        }

        // Global Actions
        async function saveData(lastAction = null) {
            // Local save (fallback)
            const now = Date.now();
            localStorage.setItem('vapeSales', JSON.stringify(sales));
            localStorage.setItem('vapeInventory', JSON.stringify(inventory));
            localStorage.setItem('vapeLosses', JSON.stringify(losses));
            localStorage.setItem('vapeDebts', JSON.stringify(debts));
            localStorage.setItem('vapeNotes', JSON.stringify(notes));
            localStorage.setItem('vapeFinancialGoal', financialGoal);
            localStorage.setItem('vapeLastUpdate', now);

            // Cloud save - only if authenticated
            if (window.firebaseDB && window.firebaseAuth.currentUser) {
                try {
                    const docRef = firebaseDoc(window.firebaseDB, "tracker", "mainData");
                    const snap = await firebaseGetDoc(docRef);
                    let auditLog = [];
                    if (snap.exists() && snap.data().auditLog) {
                        auditLog = snap.data().auditLog;
                    }

                    if (lastAction) {
                        const device = navigator.userAgent.includes('iPhone') ? 'iPhone' :
                            navigator.userAgent.includes('Android') ? 'Android' : 'PC';
                        auditLog.unshift({
                            text: lastAction,
                            time: now,
                            device: device
                        });
                        // Keep only last 50 actions
                        if (auditLog.length > 50) auditLog = auditLog.slice(0, 50);
                    }

                    await firebaseSetDoc(docRef, {
                        sales: sales,
                        inventory: inventory,
                        losses: losses,
                        debts: debts,
                        notes: notes,
                        financialGoal: financialGoal,
                        updatedAt: now,
                        lastSyncBy: window.firebaseAuth.currentUser.email,
                        lastSeenDevice: navigator.userAgent,
                        auditLog: auditLog
                    }, { merge: true });
                    // showToast("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ‚òÅÔ∏è");
                } catch (e) {
                    console.error("Firebase Save Error:", e);
                    showToast("–û—à–∏–±–∫–∞ –æ–±–ª–∞–∫–∞ ‚ö†Ô∏è", "error");
                }
            }
        }

        function processCloudUpdate(data) {
            const cloudTime = data.updatedAt || 0;
            const localTime = parseInt(localStorage.getItem('vapeLastUpdate')) || 0;

            // Only update if cloud data is newer
            // Also update if local is empty (initial sync)
            if (cloudTime > localTime || (sales.length === 0 && inventory.length === 0)) {
                // Prevent updating if we just saved this exact data (avoid loops)
                if (data.lastSyncBy === window.firebaseAuth.currentUser?.email && Math.abs(cloudTime - localTime) < 2000) {
                    return;
                }

                sales = data.sales || [];
                inventory = data.inventory || [];
                losses = data.losses || [];
                debts = data.debts || [];
                notes = data.notes || [];
                financialGoal = data.financialGoal || 0;

                localStorage.setItem('vapeSales', JSON.stringify(sales));
                localStorage.setItem('vapeInventory', JSON.stringify(inventory));
                localStorage.setItem('vapeLosses', JSON.stringify(losses));
                localStorage.setItem('vapeDebts', JSON.stringify(debts));
                localStorage.setItem('vapeNotes', JSON.stringify(notes));
                localStorage.setItem('vapeFinancialGoal', financialGoal);
                localStorage.setItem('vapeLastUpdate', cloudTime);

                document.getElementById('goalInput').value = financialGoal || '';
                renderNotes();

                // Refresh UI
                const activeTab = document.querySelector('.tab.active')?.onclick.toString().match(/'(.*?)'/)?.[1] || 'sales';
                if (activeTab === 'sales') renderSales();
                else if (activeTab === 'inventory') renderInventory();
                else if (activeTab === 'losses') renderLosses();
                else if (activeTab === 'stats') renderStats();

                updateDatalist();
                showToast("–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã üîÑ");
            }
        }

        function showToast(message, type = 'success') {
            if (type === 'error') triggerHaptic('error');
            else triggerHaptic('success');
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }


        // Window click handler for modals
        window.onclick = function (event) {
            const modals = ['editLossModal', 'duplicateConflictModal', 'changePasswordModal', 'helpPageModal', 'notesModal'];
            modals.forEach(id => {
                const modal = document.getElementById(id);
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }

        function logout() {
            if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?")) {
                sessionStorage.removeItem('vapeAuth');
                localStorage.removeItem('vapeAuth');
                // Don't remove cachedPasswordHash so offline login still works later if needed

                // Sign out from Firebase if available
                if (window.firebaseAuth) {
                    window.firebaseAuth.signOut().then(() => {
                        window.location.href = 'login.html';
                    }).catch(err => {
                        console.error("Firebase signout error:", err);
                        window.location.href = 'login.html';
                    });
                } else {
                    window.location.href = 'login.html';
                }
            }
        }

        // Password Change Functions
        function openChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'flex';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordChangeError').style.display = 'none';
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
        }

        async function sha256(message) {
            const encoder = new TextEncoder();
            const data = encoder.encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function saveNewPassword() {
            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            const errorDiv = document.getElementById('passwordChangeError');

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                errorDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = '–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword.length < 3) {
                errorDiv.textContent = '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞)';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                // Verify current password
                const currentHash = await sha256(currentPassword);

                // Load current password from Firebase
                if (!window.firebaseDB) {
                    errorDiv.textContent = 'Firebase –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
                    errorDiv.style.display = 'block';
                    return;
                }

                const docRef = firebaseDoc(window.firebaseDB, "auth", "adminPassword");
                const docSnap = await firebaseGetDoc(docRef);

                let storedHash = null;
                if (docSnap.exists()) {
                    storedHash = docSnap.data().passwordHash;
                }

                if (currentHash !== storedHash) {
                    errorDiv.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å!';
                    errorDiv.style.display = 'block';
                    return;
                }

                // Save new password
                const newHash = await sha256(newPassword);
                console.log('üîê Saving new password to Firebase...');
                console.log('New password hash:', newHash);

                // Save to Firebase with Cloud History (Plaintext as requested)
                const newEntry = {
                    date: new Date().toISOString(),
                    password: newPassword, // Storing plaintext for admin history
                    device: navigator.userAgent,
                    by: 'user'
                };

                // Get existing history or create new
                let currentHistory = [];
                if (docSnap.exists() && docSnap.data().history) {
                    currentHistory = docSnap.data().history;
                }
                currentHistory.unshift(newEntry);

                await firebaseSetDoc(docRef, {
                    passwordHash: newHash,
                    history: currentHistory,
                    updatedAt: Date.now(),
                    updatedBy: 'admin'
                });

                // Save to local history
                const history = JSON.parse(localStorage.getItem('localPasswordHistory') || '[]');
                history.unshift({ date: new Date().toLocaleString(), type: 'change' });
                localStorage.setItem('localPasswordHistory', JSON.stringify(history));

                console.log('‚úÖ Password successfully saved to Firebase!');
                showToast('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω! üîí');
                closeChangePasswordModal();
            } catch (err) {
                console.error('Password change error:', err);
                errorDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
                errorDiv.style.display = 'block';
            }
        }

        function clearSales() {
            if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–¥–∞–∂?")) {
                sales = [];
                saveData();
                renderSales();
            }
        }

        function clearInventory() {
            if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Å–∫–ª–∞–¥?")) {
                inventory = [];
                saveData();
                renderInventory();
                updateDatalist();
            }
        }

        async function exportData() {
            const data = {
                sales,
                inventory,
                losses,
                exportedAt: new Date().toISOString()
            };
            const jsonStr = JSON.stringify(data, null, 2);

            // Try sharing if supported/mobile
            if (navigator.share) {
                try {
                    const file = new File([jsonStr], `vape_backup_${new Date().toISOString().slice(0, 10)}.json`, { type: 'application/json' });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: '–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è Vape Tracker',
                            text: '–ú–æ—è –±–∞–∑–∞ –ø—Ä–æ–¥–∞–∂ –∏ —Å–∫–ª–∞–¥–∞.'
                        });
                        return; // Successfully shared, don't download
                    }
                } catch (e) {
                    console.log('Sharing failed, falling back to download', e);
                }
            }

            // Fallback to simple download
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vape_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /* Admin & Force Setup Logic */
        // Check triggers on load
        document.addEventListener('DOMContentLoaded', async () => {
            const role = localStorage.getItem('vapeRole');

            // 1. Show Admin Panel
            if (role === 'system') {
                document.getElementById('adminPanel').style.display = 'block';
                loadAdminData();
            } else {
                document.getElementById('adminPanel').style.display = 'none';
            }

            // 2. Check if Password is Set (Force Setup)
            // Only check if we are online and firebase is ready.
            // We'll use a loop to wait for firebaseDB
            const checkInterval = setInterval(async () => {
                if (window.firebaseDB && window.firebaseGetDoc) {
                    clearInterval(checkInterval);
                    const docRef = firebaseDoc(window.firebaseDB, "auth", "adminPassword");
                    try {
                        const snap = await firebaseGetDoc(docRef);
                        // If no doc or passwordHash is null, force setup
                        if (!snap.exists() || !snap.data().passwordHash) {
                            console.log('‚ö†Ô∏è Password not set! Forcing setup.');
                            document.getElementById('forceSetupModal').style.display = 'flex';
                        }
                    } catch (e) { console.error('Force check error:', e); }
                }
            }, 500);
        });

        async function loadAdminData() {
            if (!window.firebaseDB) return;

            try {
                // 1. Monitor Activity & Global Stats
                const mainDocRef = firebaseDoc(window.firebaseDB, "tracker", "mainData");
                window.firebaseOnSnapshot(mainDocRef, (snap) => {
                    const data = snap.data() || {};
                    if (data.updatedAt) {
                        document.getElementById('adminLastSeen').textContent = new Date(data.updatedAt).toLocaleString('ru-RU');
                        let device = 'Web';
                        if (data.lastSeenDevice) {
                            if (data.lastSeenDevice.includes('iPhone')) device = 'iPhone';
                            else if (data.lastSeenDevice.includes('Android')) device = 'Android';
                            else if (data.lastSeenDevice.includes('Mac')) device = 'Mac';
                        }
                        document.getElementById('adminLastDevice').textContent = device;
                    }

                    if (data.auditLog) {
                        renderAuditLog(data.auditLog);
                    } else {
                        document.getElementById('adminActivityLog').innerHTML = '<div style="opacity:0.5; text-align:center;">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</div>';
                    }
                });

                // 2. Monitor Password History (Secure collection)
                const authDocRef = firebaseDoc(window.firebaseDB, "auth", "adminPassword");
                window.firebaseOnSnapshot(authDocRef, (snap) => {
                    const data = snap.data() || {};
                    if (data.history) {
                        renderAdminHistory(data.history);
                    } else {
                        renderAdminHistory([]);
                    }
                });
            } catch (e) {
                console.error("Admin Load Error:", e);
            }
        }

        function renderAuditLog(log) {
            if (localStorage.getItem('vapeRole') !== 'system') return;
            const list = document.getElementById('adminActivityLog');
            list.innerHTML = log.map(item => `
                <div style="border-bottom: 1px solid rgba(255,255,255,0.05); padding: 6px 0; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <span style="color: var(--accent-color)">‚Ä¢</span> ${item.text}
                        <div style="font-size: 9px; opacity: 0.5;">${item.device}</div>
                    </div>
                    <div style="font-size: 10px; opacity: 0.6;">${new Date(item.time).toLocaleTimeString('ru-RU')}</div>
                </div>
            `).join('');
        }

        async function clearAuditLog() {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –ª–µ–Ω—Ç—É –¥–µ–π—Å—Ç–≤–∏–π?')) return;
            try {
                const docRef = firebaseDoc(window.firebaseDB, "tracker", "mainData");
                await firebaseSetDoc(docRef, { auditLog: [] }, { merge: true });
            } catch (e) { alert(e); }
        }

        async function adminResetPassword() {
            if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —Å–±—Ä–æ—Å–∏—Ç –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û–Ω —Å–º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –±–µ–∑ –ø–∞—Ä–æ–ª—è, –Ω–æ —Å–∏—Å—Ç–µ–º–∞ –ø–æ—Ç—Ä–µ–±—É–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;

            try {
                const docRef = firebaseDoc(window.firebaseDB, "auth", "adminPassword");
                await firebaseSetDoc(docRef, {
                    passwordHash: null,
                    updatedAt: Date.now(),
                    updatedBy: 'system_reset'
                });

                // Log to local history
                const history = JSON.parse(localStorage.getItem('localPasswordHistory') || '[]');
                history.unshift({ date: new Date().toLocaleString(), type: 'reset_by_admin' });
                localStorage.setItem('localPasswordHistory', JSON.stringify(history));

                renderAdminHistory();
                alert('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω!');
            } catch (e) { alert('–û—à–∏–±–∫–∞: ' + e.message); }
        }

        function renderAdminHistory(history) {
            if (localStorage.getItem('vapeRole') !== 'system') return;
            const list = document.getElementById('adminPassHistory');

            if (!history || history.length === 0) {
                list.innerHTML = '<div style="opacity:0.5; text-align:center;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
                return;
            }

            list.innerHTML = history.map(h => {
                const date = new Date(h.date).toLocaleString('ru-RU');
                // Attempt to simplify user agent
                let device = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                if (h.device) {
                    if (h.device.includes('iPhone')) device = 'iPhone';
                    else if (h.device.includes('Android')) device = 'Android';
                    else if (h.device.includes('Mac')) device = 'Mac';
                    else if (h.device.includes('Windows')) device = 'Windows';
                    else device = 'Web';
                }

                return `
                <div style="border-bottom: 1px solid rgba(255,255,255,0.1); padding: 8px 0;">
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color: var(--accent-color); font-weight:bold;">${h.password || '***'}</span>
                        <span style="opacity:0.6;">${date}</span>
                    </div>
                    <div style="font-size: 10px; opacity: 0.5; margin-top: 2px;">
                        ${device} ${h.by === 'user' ? '(–°–º–µ–Ω–∞)' : '(–°–±—Ä–æ—Å)'}
                    </div>
                </div>
            `}).join('');
        }

        function adminClearHistory() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –û–ë–õ–ê–ß–ù–£–Æ –∏—Å—Ç–æ—Ä–∏—é –ø–∞—Ä–æ–ª–µ–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
                try {
                    const docRef = firebaseDoc(window.firebaseDB, "auth", "adminPassword");
                    firebaseSetDoc(docRef, { history: [] }, { merge: true });
                } catch (e) { alert('–û—à–∏–±–∫–∞: ' + e); }
            }
        }

        async function saveForcedPassword() {
            const newPass = document.getElementById('forceNewPass').value.trim();
            const confirmPass = document.getElementById('forceConfirmPass').value.trim();
            const errorDiv = document.getElementById('forceSetupError');

            if (!newPass) {
                errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
                errorDiv.style.display = 'block';
                return;
            }
            if (newPass !== confirmPass) {
                errorDiv.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                errorDiv.style.display = 'block';
                return;
            }
            if (newPass.length < 3) {
                errorDiv.textContent = '–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const hash = await sha256(newPass);
                const docRef = firebaseDoc(window.firebaseDB, "auth", "adminPassword");

                // Fetch current history to append
                let currentHistory = [];
                try {
                    const snap = await firebaseGetDoc(docRef);
                    if (snap.exists() && snap.data().history) {
                        currentHistory = snap.data().history;
                    }
                } catch (e) { }

                currentHistory.unshift({
                    date: new Date().toISOString(),
                    password: newPass, // PLAINTEXT saved
                    device: navigator.userAgent,
                    by: 'user_force_setup'
                });

                await firebaseSetDoc(docRef, {
                    passwordHash: hash,
                    history: currentHistory,
                    updatedAt: Date.now(),
                    updatedBy: 'user_force_setup'
                });

                document.getElementById('forceSetupModal').style.display = 'none';
                alert('–ü–∞—Ä–æ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! üéâ');
            } catch (e) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
                errorDiv.style.display = 'block';
            }
        }
        async function shareData() {
            const textData = JSON.stringify({ sales, inventory, losses }, null, 2);
            /* simpler share for plain text summary if needed, but JSON is better for backup */
            const shareData = {
                title: 'Vape Tracker Backup',
                text: '–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –¥–∞–Ω–Ω—ã—Ö Vape Tracker',
                files: [
                    new File([textData], `vape_backup_${new Date().toLocaleDateString()}.txt`, {
                        type: 'text/plain',
                    }),
                ],
            };

            if (navigator.canShare && navigator.canShare(shareData)) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è: ' + err.message);
                }
            } else {
                // Fallback to clipboard
                try {
                    await navigator.clipboard.writeText(textData);
                    alert('–î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (—Ç.–∫. –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)');
                } catch (err) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.');
                }
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (!data.inventory || !data.sales) {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    }

                    const mode = confirm('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏?\n\nOK = –û–±—ä–µ–¥–∏–Ω–∏—Ç—å (–¥–æ–±–∞–≤–∏—Ç—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º)\n–û—Ç–º–µ–Ω–∞ = –ó–∞–º–µ–Ω–∏—Ç—å (—É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ)');

                    if (mode) {
                        // Merge mode - add imported data
                        data.inventory.forEach(item => {
                            const existing = inventory.find(i => i.name.toLowerCase() === item.name.toLowerCase());
                            if (existing) {
                                existing.qty += item.qty;
                            } else {
                                item.id = Date.now() + Math.random(); // new id
                                inventory.push(item);
                            }
                        });

                        const existingIds = new Set(sales.map(s => s.id));
                        data.sales.forEach(sale => {
                            if (!existingIds.has(sale.id)) {
                                sales.push(sale);
                            }
                        });
                        // Sort sales by timestamp
                        sales.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                        // Import losses
                        if (data.losses) {
                            const existingLossIds = new Set(losses.map(l => l.id));
                            data.losses.forEach(loss => {
                                if (!existingLossIds.has(loss.id)) {
                                    losses.push(loss);
                                }
                            });
                            losses.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        }
                    } else {
                        // Replace mode
                        inventory = data.inventory;
                        sales = data.sales;
                        losses = data.losses || [];
                    }

                    saveData();
                    renderSales();
                    renderInventory();
                    alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');

                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        function onDateChange(input) {
            document.getElementById('calIcon').classList.toggle('active', input.value !== '');
            renderSales();
        }

        // Stats Functions
        function setStatsPeriod(period) {
            statsPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderStats();
        }

        function getFilteredSales(period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            return sales.filter(s => {
                if (period === 'all') return true;

                // Fallback for objects missing timestamp
                const saleDate = s.timestamp ? new Date(s.timestamp) : new Date(2023, 0, 1);
                const saleDateOnly = new Date(saleDate.getFullYear(), saleDate.getMonth(), saleDate.getDate());

                if (period === 'day') {
                    return saleDateOnly.getTime() === today.getTime();
                } else if (period === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return saleDate >= weekAgo;
                } else if (period === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    return saleDate >= monthAgo;
                }
                return true;
            });
        }

        function getFilteredLosses(period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            return losses.filter(l => {
                if (period === 'all') return true;

                const lossDate = l.timestamp ? new Date(l.timestamp) : new Date(2023, 0, 1);

                if (period === 'day') {
                    const lossDayOnly = new Date(lossDate.getFullYear(), lossDate.getMonth(), lossDate.getDate());
                    return lossDayOnly.getTime() === today.getTime();
                } else if (period === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return lossDate >= weekAgo;
                } else if (period === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    return lossDate >= monthAgo;
                }
                return true;
            });
        }



        function renderStats() {
            const filteredSales = getFilteredSales(statsPeriod);
            const filteredLosses = getFilteredLosses(statsPeriod);

            // Calculate stats
            let revenue = 0;
            let profit = 0;
            let salesCount = 0;
            const productStats = {};

            filteredSales.forEach(s => {
                revenue += s.price * s.qty;
                profit += (s.price - (s.cost || 0)) * s.qty;
                salesCount += s.qty;

                const name = s.name.toLowerCase();
                if (!productStats[name]) {
                    productStats[name] = { name: s.name, qty: 0, revenue: 0 };
                }
                productStats[name].qty += s.qty;
                productStats[name].revenue += s.price * s.qty;
            });

            let lossesTotal = 0;
            filteredLosses.forEach(l => {
                lossesTotal += l.cost * l.qty;
                // Subtract from profit if enabled for this loss item
                // Legacy support: if deductProfit property missing, assume true? 
                // Or assume false? Defaulting to true for old data might be safer for conservative profitCalc, 
                // but user just added this. Let's assume true for existing data if we want to be strict, 
                // or check the flag. Let's support the flag.
                if (l.deductProfit !== false) { // Default to true if undefined
                    profit -= (l.cost * l.qty);
                }
            });

            document.getElementById('statRevenue').textContent = revenue.toLocaleString('ru-RU');
            document.getElementById('statProfit').textContent = profit.toLocaleString('ru-RU');
            document.getElementById('statLosses').textContent = lossesTotal.toLocaleString('ru-RU');
            document.getElementById('statSalesCount').textContent = salesCount.toLocaleString('ru-RU');

            // Current Inventory Stats (Global)
            const invCostTotal = inventory.reduce((sum, item) => sum + (item.cost * (item.qty || 0)), 0);
            const invRevenueTotal = inventory.reduce((sum, item) => sum + ((item.price || 0) * (item.qty || 0)), 0);
            const invProfitPotential = invRevenueTotal - invCostTotal;

            document.getElementById('statInvValue').textContent = invCostTotal.toLocaleString('ru-RU');
            document.getElementById('statInvProfit').textContent = invProfitPotential.toLocaleString('ru-RU');

            document.getElementById('statRevenue').innerText = revenue.toLocaleString('ru-RU');
            document.getElementById('statProfit').innerText = profit.toLocaleString('ru-RU');
            document.getElementById('statLosses').innerText = lossesTotal.toLocaleString('ru-RU');

            renderRevenueChart(filteredSales, statsPeriod);

            // Update Losses Page Total if element exists
            const lpTotal = document.getElementById('lossesPageTotal');
            if (lpTotal) {
                const overallLossesTotal = losses.reduce((sum, l) => sum + (l.cost * l.qty), 0);
                lpTotal.textContent = overallLossesTotal.toLocaleString('ru-RU');
            }

            // Top products
            const sortedProducts = Object.values(productStats).sort((a, b) => b.qty - a.qty);
            const maxQty = sortedProducts[0]?.qty || 1;

            const topContainer = document.getElementById('topProducts');
            if (sortedProducts.length === 0) {
                topContainer.innerHTML = '<div class="empty-state" style="padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            } else {
                topContainer.innerHTML = sortedProducts.slice(0, 5).map((p, i) => {
                    const colors = ['#ffffff', '#e0e0e0', '#c0c0c0', '#a0a0b0', '#808080'];
                    const width = (p.qty / maxQty) * 100;
                    return `
                        <div class="product-bar">
                            <span class="product-bar-name">${p.name}</span>
                            <div class="product-bar-fill">
                                <div class="product-bar-progress" style="width: ${width}%; background: ${colors[i % colors.length]};">
                                    ${p.qty} —à—Ç.
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Worst products (on stock but not selling)
            const worstContainer = document.getElementById('worstProducts');
            const soldNames = new Set(Object.keys(productStats));
            const notSelling = inventory.filter(item => !soldNames.has(item.name.toLowerCase()) && item.qty > 0);

            if (notSelling.length === 0) {
                worstContainer.innerHTML = '<div class="empty-state" style="padding: 20px;">–í—Å—ë –ø—Ä–æ–¥–∞—ë—Ç—Å—è! üéâ</div>';
            } else {
                worstContainer.innerHTML = notSelling.slice(0, 5).map(item => `
                    <div class="product-bar">
                        <span class="product-bar-name">${item.name}</span>
                        <div class="product-bar-fill">
                            <div class="product-bar-progress" style="width: 100%; background: rgba(255, 61, 113, 0.5);">
                                ${item.qty} —à—Ç. –Ω–∞ —Å–∫–ª–∞–¥–µ
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }



        // Loss Functions
        function openLossModal() {
            document.getElementById('lossModal').style.display = 'flex';
        }

        function setupLossAutocomplete() {
            const nameInput = document.getElementById('lossName');
            const listDiv = document.getElementById('lossAutocompleteList');
            if (!nameInput || !listDiv) return;

            nameInput.addEventListener('input', function () {
                const val = this.value;
                listDiv.innerHTML = '';
                if (!val) return;

                const matches = inventory.filter(item => item.name.toLowerCase().includes(val.toLowerCase()));
                matches.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.innerHTML = `
                            <span>${item.name}</span>
                            <small>${item.qty} —à—Ç.</small>
                        `;
                    div.addEventListener('click', function () {
                        nameInput.value = item.name;
                        document.getElementById('lossQty').value = 1;
                        document.getElementById('lossCost').value = item.cost;
                        listDiv.innerHTML = '';
                    });
                    listDiv.appendChild(div);
                });
            });

            document.addEventListener('click', function (e) {
                if (e.target !== nameInput) {
                    listDiv.innerHTML = '';
                }
            });
        }

        function closeLossModal() {
            document.getElementById('lossModal').style.display = 'none';
            document.getElementById('lossName').value = '';
            document.getElementById('lossQty').value = '';
            document.getElementById('lossCost').value = '';
            document.getElementById('lossNote').value = '';
        }

        function saveLoss() {
            const name = document.getElementById('lossName').value.trim();
            const qty = parseInt(document.getElementById('lossQty').value);
            const cost = parseFloat(document.getElementById('lossCost').value);
            const reason = document.getElementById('lossReason').value;
            const note = document.getElementById('lossNote').value.trim();

            const deductStock = document.getElementById('lossDeductStock').checked;

            if (!name || isNaN(qty) || isNaN(cost)) {
                alert('–ó–∞–ø–æ–ª–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ü–µ–Ω—É!');
                return;
            }

            const now = new Date();
            losses.unshift({
                id: Date.now(),
                name,
                qty,
                cost,
                reason,
                note,
                date: now.toLocaleDateString('ru-RU'),
                timestamp: now.getTime()
            });

            // Deduct from inventory if requested
            if (deductStock) {
                const invItem = inventory.find(i => i.name.toLowerCase() === name.toLowerCase());
                if (invItem) {
                    invItem.qty = Math.max(0, invItem.qty - qty);
                } else {
                    // Optional: alert that item wasn't found in stock? 
                    // Silent fail is okay per request "if not in stock just loss"
                }
            }

            saveData();
            closeLossModal();
            renderStats();
            renderLosses();
            renderInventory();
        }

        function renderLosses() {
            const container = document.getElementById('lossesHistory');
            const totalEl = document.getElementById('lossesPageTotal');
            container.innerHTML = '';

            let totalLoss = 0;
            losses.forEach(l => totalLoss += (l.cost * l.qty));
            if (totalEl) totalEl.textContent = totalLoss.toLocaleString('ru-RU');

            if (losses.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;">–£–±—ã—Ç–∫–æ–≤ –Ω–µ—Ç üëç</div>';
                return;
            }

            const reasonLabels = { defect: '–ë—Ä–∞–∫', lost: '–ü–æ—Ç–µ—Ä—è–Ω', gift: '–ü–æ–¥–∞—Ä–∏–ª', self: '–û—Å—Ç–∞–≤–∏–ª —Å–µ–±–µ', other: '–î—Ä—É–≥–æ–µ' };
            losses.forEach(l => {
                const markup = `
                    <div class="item-info">
                        <b>${l.name}</b>
                        <small>${l.date} ‚Ä¢ ${reasonLabels[l.reason] || l.reason} ‚Ä¢ ${l.qty} —à—Ç.${l.note ? ' ‚Ä¢ ' + l.note : ''}</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="loss-item-amount" style="color: #ff3d71; font-weight: 700;">-${(l.cost * l.qty).toLocaleString('ru-RU')} ‚ÇΩ</span>
                        <button class="edit-btn" onclick="openLossEdit(${l.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteLoss(${l.id})">√ó</button>
                    </div>
                `;
                const wrapper = createSwipeWrapper(markup, () => deleteLoss(l.id));
                container.appendChild(wrapper);
            });
        }

        function deleteLoss(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –æ–± —É–±—ã—Ç–∫–µ?')) {
                losses = losses.filter(l => l.id !== id);
                saveData();
                renderLosses();
                renderStats();
            }
        }

        // Edit Loss Functions
        function openLossEdit(id) {
            const loss = losses.find(l => l.id === id);
            if (loss) {
                document.getElementById('editLossId').value = id;
                document.getElementById('editLossName').value = loss.name || '';
                document.getElementById('editLossQty').value = loss.qty || '';
                document.getElementById('editLossCost').value = loss.cost || '';
                document.getElementById('editLossReason').value = loss.reason || 'defect';
                document.getElementById('editLossNote').value = loss.note || '';
                document.getElementById('editLossModal').style.display = 'flex';
            }
        }

        function closeLossEditModal() {
            document.getElementById('editLossModal').style.display = 'none';
        }

        function saveLossEdit() {
            const id = parseInt(document.getElementById('editLossId').value);
            const name = document.getElementById('editLossName').value.trim();
            const qty = parseInt(document.getElementById('editLossQty').value);
            const cost = parseFloat(document.getElementById('editLossCost').value);
            const reason = document.getElementById('editLossReason').value;
            const note = document.getElementById('editLossNote').value.trim();

            if (!name || isNaN(qty) || isNaN(cost)) {
                alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
                return;
            }

            const loss = losses.find(l => l.id === id);
            if (loss) {
                loss.name = name;
                loss.qty = qty;
                loss.cost = cost;
                loss.reason = reason;
                loss.note = note;

                saveData();
                closeLossEditModal();
                renderLosses();
                renderStats();
            }
        }





        // Update Info Page Statistics
        function updateInfoPageStats() {
            const salesCountEl = document.getElementById('infoSalesCount');
            const inventoryCountEl = document.getElementById('infoInventoryCount');
            const inventoryValueEl = document.getElementById('infoInventoryValue');

            if (salesCountEl) {
                salesCountEl.textContent = sales.length;
            }

            if (inventoryCountEl) {
                const totalQty = inventory.reduce((sum, item) => sum + (item.qty || 0), 0);
                inventoryCountEl.textContent = totalQty;
            }

            if (inventoryValueEl) {
                const totalValue = inventory.reduce((sum, item) => sum + (item.cost * (item.qty || 0)), 0);
                inventoryValueEl.textContent = totalValue.toLocaleString('ru-RU');
            }
        }

        // Help Page Functions
        function openHelpPage() {
            document.getElementById('helpPageModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeHelpPage() {
            document.getElementById('helpPageModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        // Notes Functions
        function openNotesModal() {
            triggerHaptic('light');
            document.getElementById('notesModal').style.display = 'flex';
            renderNotes();
        }

        function closeNotesModal() {
            triggerHaptic('light');
            document.getElementById('notesModal').style.display = 'none';
        }

        function addNote() {
            const input = document.getElementById('noteInput');
            const text = input.value.trim();
            if (!text) return;

            const newNote = {
                id: Date.now(),
                text: text,
                date: new Date().toISOString()
            };

            notes.unshift(newNote);
            input.value = '';

            saveData(`–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–º–µ—Ç–∫–∞`);
            renderNotes();
        }

        function deleteNote(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?')) return;
            notes = notes.filter(n => n.id !== id);
            saveData(`–£–¥–∞–ª–µ–Ω–∞ –∑–∞–º–µ—Ç–∫–∞`);
            renderNotes();
        }

        function renderNotes() {
            const container = document.getElementById('notesContainer');
            if (notes.length === 0) {
                container.innerHTML = '<div style="opacity:0.5; text-align:center; padding: 20px;">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</div>';
                return;
            }

            container.innerHTML = notes.map(note => `
                <div class="note-item">
                    <div class="note-date">${new Date(note.date).toLocaleString('ru-RU')}</div>
                    <div class="note-text">${note.text}</div>
                    <div class="note-delete" onclick="deleteNote(${note.id})">üóëÔ∏è</div>
                </div>
            `).join('');
        }

        // Goal Functions
        function updateGoal() {
            const input = document.getElementById('goalInput');
            financialGoal = parseInt(input.value) || 0;
            saveData(`–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Ü–µ–ª—å`);
            renderSales(); // Refresh stats with new goal progress
        }

        function updateGoalUI(currentRevenue) {
            const container = document.getElementById('goalContainer');
            const progressSpan = document.getElementById('goalProgressText');
            const bar = document.getElementById('goalProgressBar');

            if (!financialGoal || financialGoal <= 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            const percent = Math.min(100, (currentRevenue / financialGoal) * 100);

            progressSpan.textContent = `${currentRevenue.toLocaleString('ru-RU')} / ${financialGoal.toLocaleString('ru-RU')} ‚ÇΩ`;
            bar.style.width = percent + '%';

            // Color logic
            if (percent < 40) {
                bar.style.background = 'var(--danger-color)';
                bar.style.boxShadow = '0 0 10px rgba(255, 59, 48, 0.3)';
            } else if (percent < 80) {
                bar.style.background = '#ffd93d'; // Yellow/Orange
                bar.style.boxShadow = '0 0 10px rgba(255, 217, 61, 0.3)';
            } else if (percent < 100) {
                bar.style.background = 'var(--accent-color)';
                bar.style.boxShadow = '0 0 10px rgba(0, 242, 255, 0.3)';
            } else {
                bar.style.background = 'var(--success-color)';
                bar.style.boxShadow = '0 0 15px rgba(0, 240, 170, 0.5)';
            }
        }

        let revenueChartInstance = null;

        function renderRevenueChart(salesData, period) {
            const canvas = document.getElementById('revenueChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            if (revenueChartInstance) {
                revenueChartInstance.destroy();
            }

            // Group by date
            const dailyData = {};
            salesData.forEach(s => {
                const date = s.date;
                if (date === '–ë–µ–∑ –¥–∞—Ç—ã' || !date) return;
                if (!dailyData[date]) dailyData[date] = 0;
                dailyData[date] += s.price * s.qty;
            });

            // Sort dates
            const labels = Object.keys(dailyData).sort((a, b) => {
                try {
                    const [da, ma, ya] = a.split('.');
                    const [db, mb, yb] = b.split('.');
                    return new Date(ya, ma - 1, da) - new Date(yb, mb - 1, db);
                } catch (e) { return 0; }
            });

            const data = labels.map(l => dailyData[l]);

            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 0.2)');
            gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

            revenueChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: '#ffffff',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: labels.length > 15 ? 0 : 4,
                        pointBackgroundColor: '#ffffff',
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                label: (ctx) => `–í—ã—Ä—É—á–∫–∞: ${ctx.parsed.y.toLocaleString('ru-RU')} ‚ÇΩ`
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: labels.length > 1,
                            grid: { display: false },
                            ticks: {
                                color: 'rgba(255,255,255,0.5)',
                                font: { size: 9 },
                                maxRotation: 0,
                                callback: function (val, index) {
                                    const label = this.getLabelForValue(val);
                                    if (labels.length > 7 && index % Math.floor(labels.length / 5) !== 0) return '';
                                    return label.split('.')[0] + '.' + label.split('.')[1];
                                }
                            }
                        },
                        y: {
                            display: false,
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Init
        document.getElementById('goalInput').value = financialGoal || '';
        renderSales();
        renderStats();
        updateDatalist();
        setupLossAutocomplete();
        renderNotes();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }
    </script>
    <script>
        // Settings & Theme Logic
        const body = document.body;
        const themeSwitch = document.getElementById('themeSwitch');
        const notesSwitch = document.getElementById('notesSwitch');
        const notesBtn = document.querySelector('.notes-btn');

        // ==========================================
        // AI CONSTANTS & CONFIG (Moved up to avoid TDZ)
        // ==========================================
        const DAILY_MSG_LIMIT = 50;
        let aiConfig = {
            enabled: true, // –í–∫–ª/–≤—ã–∫–ª AI
            model: 'llama-3.3-70b-versatile',
            customModel: '',
            groqKey: '',
            geminiKey: '',
            systemPrompt: '–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤–µ–π–ø-—à–æ–ø–∞.',
            backupKeys: []
        };

        async function toggleUserAI() {
            const enabled = document.getElementById('userAISwitch').checked;
            localStorage.setItem('vapeUserAIEnabled', enabled);
            refreshAIVisibility();
            showToast(enabled ? "AI –≤–∫–ª—é—á–µ–Ω" : "AI —Å–∫—Ä—ã—Ç");

            // Also update admin status if needed
            if (!enabled) {
                // optional: logic if user disables it
            }
        }

        async function clearChatHistory() {
            if (!confirm("–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏?")) return;

            // 1. Clear Local Storage
            // localStorage.removeItem('vapeAIUsage'); // Maybe keep usage stats?
            // Let's just clear the visual history if that's what is requested, 
            // but usually "Clear History" means clearing the chat logs.

            // If we want to clear the 'usage' count for today:
            // const today = new Date().toISOString().split('T')[0];
            // let usage = JSON.parse(localStorage.getItem('vapeAIUsage') || '{}');
            // delete usage[today];
            // localStorage.setItem('vapeAIUsage', JSON.stringify(usage));

            // 2. Clear visual list in Admin panel
            const historyContainer = document.getElementById('adminChatHistory');
            if (historyContainer) {
                historyContainer.innerHTML = '<div style="text-align: center; opacity: 0.4;">–ü—É—Å—Ç–æ</div>';
            }

            showToast("–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞");
        }

        function refreshAIVisibility() {
            const userEnabled = localStorage.getItem('vapeUserAIEnabled') !== 'false';
            const adminEnabled = aiConfig.enabled !== false;
            const btn = document.getElementById('aiFab');

            if (btn) {
                // Show if Admin allows AND User allows
                btn.style.display = (adminEnabled && userEnabled) ? 'flex' : 'none';
            }
        }

        function initSettings() {
            // ... existing theme/notes code

            // AI User Setting
            const userAI = localStorage.getItem('vapeUserAIEnabled') !== 'false';
            const aiSw = document.getElementById('userAISwitch');
            if (aiSw) aiSw.checked = userAI;
            refreshAIVisibility();
            // Theme
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;

            let isLight = false;
            if (savedTheme === 'light') isLight = true;
            else if (savedTheme === 'dark') isLight = false;
            else if (systemPrefersLight) isLight = true;

            if (isLight) body.classList.add('light-theme');
            else body.classList.remove('light-theme');

            if (themeSwitch) themeSwitch.checked = isLight;

            // Notes
            const notesEnabled = localStorage.getItem('vapeNotesEnabled') !== 'false';
            if (notesSwitch) notesSwitch.checked = notesEnabled;
            if (notesBtn) notesBtn.style.display = notesEnabled ? 'flex' : 'none';

            // Haptic
            const hapticEnabled = localStorage.getItem('vapeHapticEnabled') === 'true';
            const hapticIntensity = localStorage.getItem('vapeHapticIntensity') || '2';
            const hapticSwitch = document.getElementById('hapticSwitch');
            const hapticIntensityRow = document.getElementById('hapticIntensityRow');
            const hapticIntensityInput = document.getElementById('hapticIntensity');

            if (hapticSwitch) hapticSwitch.checked = hapticEnabled;
            if (hapticIntensityRow) hapticIntensityRow.style.display = hapticEnabled ? 'flex' : 'none';
            if (hapticIntensityInput) hapticIntensityInput.value = hapticIntensity;
            updateHapticIntensityText(hapticIntensity);
        }

        function triggerHaptic(type = 'medium') {
            const enabled = localStorage.getItem('vapeHapticEnabled') === 'true';
            if (!enabled || !navigator.vibrate) return;

            const intensity = localStorage.getItem('vapeHapticIntensity') || '2';

            // Map intensity settings to millisecond patterns
            const patterns = {
                '1': [10],      // Light
                '2': [20],      // Medium
                '3': [40]       // Heavy (was 50, refined to 40 for more 'clicky' feel)
            };

            // If a specific type is requested (like 'success' or 'error'), we can override
            if (type === 'success') navigator.vibrate([10, 30, 10]);
            else if (type === 'error') navigator.vibrate([50, 50, 50]);
            else if (type === 'light') navigator.vibrate([10]);
            else navigator.vibrate(patterns[intensity] || [20]);
        }

        function toggleHapticSetting() {
            const hapticSwitch = document.getElementById('hapticSwitch');
            const hapticIntensityRow = document.getElementById('hapticIntensityRow');
            const enabled = hapticSwitch.checked;

            localStorage.setItem('vapeHapticEnabled', enabled);
            if (hapticIntensityRow) hapticIntensityRow.style.display = enabled ? 'flex' : 'none';

            if (enabled) {
                triggerHaptic();
                showToast("–í–∏–±—Ä–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞");
            } else {
                showToast("–í–∏–±—Ä–∞—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞");
            }
        }

        function updateHapticIntensity() {
            const input = document.getElementById('hapticIntensity');
            const val = input.value;
            localStorage.setItem('vapeHapticIntensity', val);
            updateHapticIntensityText(val);
            triggerHaptic();
        }

        function updateHapticIntensityText(val) {
            const textEl = document.getElementById('hapticIntensityValue');
            if (!textEl) return;

            const labels = {
                '1': '–õ–µ–≥–∫–∞—è',
                '2': '–°—Ä–µ–¥–Ω—è—è',
                '3': '–°–∏–ª—å–Ω–∞—è'
            };
            textEl.innerText = labels[val] || '–°—Ä–µ–¥–Ω—è—è';
        }

        function toggleTheme() {
            const isLight = themeSwitch.checked;
            if (isLight) body.classList.add('light-theme');
            else body.classList.remove('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }

        function toggleNotesSetting() {
            const enabled = notesSwitch.checked;
            localStorage.setItem('vapeNotesEnabled', enabled);
            if (notesBtn) notesBtn.style.display = enabled ? 'flex' : 'none';
            showToast(enabled ? "–ó–∞–º–µ—Ç–∫–∏ –≤–∫–ª—é—á–µ–Ω—ã" : "–ó–∞–º–µ—Ç–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã");
        }

        initSettings();

        // ==========================================
        // AI ASSISTANT LOGIC (GROQ + GEMINI + FIREBASE)
        // ==========================================
        // (Config moved to top)

        // Init: Load Settings from Firebase/Local
        async function initAI() {
            // Try Local First
            const localConfig = localStorage.getItem('vapeAIConfig');
            if (localConfig) {
                aiConfig = JSON.parse(localConfig);
                updateAdminUI();
            }

            // Sync with Firebase
            if (navigator.onLine) {
                try {
                    const docSnap = await getDoc(doc(db, "settings", "ai_config"));
                    if (docSnap.exists()) {
                        // Merge strategies
                        const cloudData = docSnap.data();
                        aiConfig = { ...aiConfig, ...cloudData };
                        localStorage.setItem('vapeAIConfig', JSON.stringify(aiConfig));
                        updateAdminUI();
                    }
                } catch (e) {
                    console.error("AI Config Sync Error:", e);
                }
            }

            // Check usage limit
            updateAdminAIStatus();
        }

        function updateAdminUI() {
            const enabledCheck = document.getElementById('aiEnabledCheck');
            const modelSel = document.getElementById('aiModelSelect');
            const customInp = document.getElementById('aiCustomModel');
            const groqInp = document.getElementById('aiGroqKey');
            const geminiInp = document.getElementById('aiGeminiKey');
            const promptInp = document.getElementById('aiSystemPrompt');
            const backupsInp = document.getElementById('aiBackupKeys');

            if (enabledCheck) enabledCheck.checked = aiConfig.enabled !== false;
            // Show/Hide AI Button based on config
            const aiBtn = document.getElementById('aiFab');
            if (aiBtn) aiBtn.style.display = (aiConfig.enabled !== false) ? 'flex' : 'none';

            if (modelSel) modelSel.value = aiConfig.model || 'llama-3.3-70b-versatile';
            if (customInp) {
                customInp.value = aiConfig.customModel || '';
                customInp.style.display = aiConfig.model === 'custom' ? 'block' : 'none';
            }
            if (groqInp) groqInp.value = aiConfig.groqKey || '';
            if (geminiInp) geminiInp.value = aiConfig.geminiKey || '';
            if (promptInp) promptInp.value = aiConfig.systemPrompt || '';
            if (backupsInp) backupsInp.value = (aiConfig.backupKeys || []).join('\n');

            // Toggle custom input visibility
            if (modelSel) {
                modelSel.onchange = () => {
                    const val = modelSel.value;
                    customInp.style.display = val === 'custom' ? 'block' : 'none';
                    saveAISettings(); // Auto save
                };
            }
        }

        async function saveAISettings() {
            const enabled = document.getElementById('aiEnabledCheck').checked;
            const model = document.getElementById('aiModelSelect').value;
            const custom = document.getElementById('aiCustomModel').value;
            const groqKey = document.getElementById('aiGroqKey').value.trim();
            const geminiKey = document.getElementById('aiGeminiKey').value.trim();
            const systemPrompt = document.getElementById('aiSystemPrompt').value.trim();
            const backups = document.getElementById('aiBackupKeys').value.split('\n').map(k => k.trim()).filter(k => k);

            aiConfig = {
                enabled,
                model,
                customModel: custom,
                groqKey,
                geminiKey,
                systemPrompt,
                backupKeys: backups
            };

            // Save Local
            localStorage.setItem('vapeAIConfig', JSON.stringify(aiConfig));

            // Save Firebase
            try {
                await setDoc(doc(db, "settings", "ai_config"), aiConfig);
                showToast("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã ‚òÅÔ∏è");
            } catch (e) {
                showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ", "error");
            }
        }

        // --- Chat Logic ---

        function openChatModal() {
            triggerHaptic('light');
            document.getElementById('chatModal').style.display = 'flex';
            scrollToBottomChat();
        }

        function closeChatModal() {
            triggerHaptic('light');
            document.getElementById('chatModal').style.display = 'none';
        }

        function handleChatEnter(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        function scrollToBottomChat() {
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // 1. Check Limits
            const today = new Date().toISOString().split('T')[0];
            const usage = JSON.parse(localStorage.getItem('vapeAIUsage') || '{}');
            const currentCount = usage[today] || 0;

            if (currentCount >= DAILY_MSG_LIMIT) {
                addMessageToChat("ai", "–ë—Ä–æ, –ª–∏–º–∏—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å—ë. –°–ø–∏—à–µ–º—Å—è –∑–∞–≤—Ç—Ä–∞! üåô");
                input.value = '';
                return;
            }

            // 2. UI Update
            triggerHaptic('light');
            addMessageToChat("user", message);
            input.value = '';
            const typingId = showTypingIndicator();

            // 3. System Prompt
            const revenue = document.getElementById('totalRevenue').innerText;
            const profit = document.getElementById('totalProfit').innerText;
            const products = JSON.parse(localStorage.getItem('inventory') || '[]').length;

            const basePrompt = aiConfig.systemPrompt || '–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤–µ–π–ø-—à–æ–ø–∞.';

            // –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –£–ü–†–ê–í–õ–ï–ù–ò–Æ (–î–õ–Ø AI)
            const toolInstructions = `
            –¢–´ ‚Äî –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–† –í–ï–ô–ü-–®–û–ü–ê.
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å —Ü–µ–Ω—ã —Ç–∞–∫: "–∑–∞–∫—É–ø 500 –ø—Ä–æ–¥–∞–∂–∞ 1000", "–æ–ø—Ç 300 —Ä—Ü 600".
            –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π JSON –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π:

            1. –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä: {"action":"add_inventory","name":"–ò–º—è","qty":10,"cost":500,"price":1000}
               (–ï–°–õ–ò "cost" –Ω–µ —É–∫–∞–∑–∞–Ω, —Å—á–∏—Ç–∞–π cost=0. –ï–°–õ–ò "price" –Ω–µ —É–∫–∞–∑–∞–Ω, price = cost * 1.5)
            2. –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Å–∫–ª–∞–¥: {"action":"clear_inventory"}
            3. –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä: {"action":"delete_inventory","name":"–ò–º—è"}
            4. –ü—Ä–æ–¥–∞–∂–∞: {"action":"add_sale","name":"–ò–º—è","qty":1,"price":1000}
            5. –£–±—ã—Ç–æ–∫ (–±—Ä–∞–∫/–∫—Ä–∞–∂–∞): {"action":"add_loss","name":"–ò–º—è","qty":1,"cost":300,"reason":"defect"}
            6. –î–æ–ª–≥–∏: {"action":"add_debt","name":"–ò–º—è","amount":500} | {"action":"clear_debts"}
            7. –ó–∞–º–µ—Ç–∫–∏: {"action":"add_note","text":"—Ç–µ–∫—Å—Ç"} | {"action":"delete_note","id":"all"}

            –ü–†–ò–ú–ï–†: "–û–∫. {"action":"add_inventory","name":"Husky","qty":5,"cost":300,"price":450}"
            `;

            const dynamicContext = `\n–î–∞–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω–∞ —Å–µ–π—á–∞—Å: –í—ã—Ä—É—á–∫–∞ ${revenue}, –ü—Ä–∏–±—ã–ª—å ${profit}, –¢–æ–≤–∞—Ä–æ–≤ ${products}.`;
            const contextSystem = basePrompt + toolInstructions + dynamicContext;

            try {
                let success = false;
                let aiReply = "";

                // Determine Provider based on Model ID
                let modelID = aiConfig.model === 'custom' ? aiConfig.customModel : aiConfig.model;
                if (!modelID) modelID = 'llama-3.3-70b-versatile';

                const isGemini = modelID.startsWith('gemini');

                // Select Keys Config
                let primaryKey = isGemini ? aiConfig.geminiKey : aiConfig.groqKey;
                let keysToTry = [];
                if (primaryKey) keysToTry.push(primaryKey);
                if (aiConfig.backupKeys && aiConfig.backupKeys.length > 0) keysToTry.push(...aiConfig.backupKeys);

                // Ensure at least one key exists (or empty string to trigger provider error)
                if (keysToTry.length === 0) throw new Error(isGemini ? "–ù–µ—Ç –∫–ª—é—á–∞ Gemini" : "–ù–µ—Ç –∫–ª—é—á–∞ Groq");

                // Loop through keys
                for (const apiKey of keysToTry) {
                    try {
                        let text = "";
                        if (isGemini) {
                            text = await callGeminiAPI(apiKey, modelID, contextSystem, message);
                        } else {
                            text = await callGroqAPI(apiKey, modelID, contextSystem, message);
                        }
                        if (text) {
                            aiReply = text;
                            success = true;
                            break;
                        }
                    } catch (e) {
                        console.warn("Key failure:", e);
                        continue;
                    }
                }

                if (!success) throw new Error("–í—Å–µ –∫–ª—é—á–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã –∏–ª–∏ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏.");

                removeTypingIndicator(typingId);

                // –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç JSON –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const cleanReply = aiReply.replace(/\{"action":.*\}/g, '').trim();

                addMessageToChat("ai", cleanReply || "–í—ã–ø–æ–ª–Ω–µ–Ω–æ.");
                processAIAction(aiReply, message); // –ü–µ—Ä–µ–¥–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (message) –¥–ª—è –ª–æ–≥–æ–≤
                triggerHaptic('success');

                // Update Usage
                usage[today] = currentCount + 1;
                localStorage.setItem('vapeAIUsage', JSON.stringify(usage));
                updateAdminAIStatus();

                // Log to Firebase
                addDoc(collection(db, "ai_chat_logs"), {
                    timestamp: new Date(),
                    userMessage: message,
                    aiReply: aiReply,
                    model: modelID
                }).catch(e => console.error(e));

                // Local History
                saveToChatHistory(message, aiReply);

            } catch (error) {
                removeTypingIndicator(typingId);
                addMessageToChat("ai", `–û—à–∏–±–∫–∞: ${error.message || "–°–±–æ–π —Å–∏—Å—Ç–µ–º—ã"}`);
                triggerHaptic('error');
            }
        }

        async function callGroqAPI(key, model, system, userMsg) {
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${key}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: "system", content: system },
                        { role: "user", content: userMsg }
                    ],
                    temperature: 0.7,
                    max_tokens: 1024
                })
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || "Groq Error");
            }
            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function callGeminiAPI(key, modelId, system, userMsg) {
            let model = modelId;
            // Gemini endpoint
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;

            const body = {
                contents: [{
                    parts: [{ text: system + "\n\nUser Question: " + userMsg }]
                }]
            };

            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || "Gemini Error");
            }
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π AI (–ü–û–õ–ù–´–ô –ö–û–ù–¢–†–û–õ–¨)
        function processAIAction(text) {
            try {
                const jsonMatch = text.match(/\{"action":.*\}/);
                if (!jsonMatch) return;

                const data = JSON.parse(jsonMatch[0]);
                console.log("AI Command:", data);

                switch (data.action) {
                    case 'add_inventory':
                        if (!data.name) return;
                        const existing = inventory.find(i => i.name.toLowerCase() === data.name.toLowerCase());
                        if (existing) {
                            existing.qty += parseInt(data.qty || 1);
                            saveData(`AI: –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ${data.name}`);
                        } else {
                            inventory.unshift({
                                id: Date.now(),
                                name: data.name,
                                qty: parseInt(data.qty || 1),
                                cost: parseFloat(data.price || 0),
                                price: parseFloat(data.price || 0) * 1.5,
                                date: new Date().toLocaleDateString('ru-RU')
                            });
                            saveData(`AI: –ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä ${data.name}`);
                        }
                        renderInventory();
                        showToast(`üì¶ –°–∫–ª–∞–¥: ${data.name}`);
                        break;

                    case 'clear_inventory':
                        inventory = [];
                        saveData(`AI: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–∫–ª–∞–¥–∞`);
                        renderInventory();
                        showToast(`üóëÔ∏è –°–∫–ª–∞–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω`);
                        break;

                    case 'delete_inventory':
                        if (!data.name) return;
                        inventory = inventory.filter(i => i.name.toLowerCase() !== data.name.toLowerCase());
                        saveData(`AI: –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞`);
                        renderInventory();
                        showToast(`üóëÔ∏è –°–∫–ª–∞–¥: —É–¥–∞–ª–µ–Ω ${data.name}`);
                        break;

                    case 'add_sale':
                        if (!data.name) return;
                        const invItem = inventory.find(i => i.name.toLowerCase() === data.name.toLowerCase());
                        sales.unshift({
                            id: Date.now(),
                            name: data.name,
                            qty: parseInt(data.qty || 1),
                            price: parseFloat(data.price || 0),
                            cost: invItem ? invItem.cost : 0,
                            date: new Date().toLocaleDateString('ru-RU'),
                            timestamp: Date.now()
                        });
                        if (invItem) invItem.qty = Math.max(0, invItem.qty - (data.qty || 1));
                        saveData(`AI: –ü—Ä–æ–¥–∞–∂–∞ ${data.name}`);
                        renderSales();
                        renderInventory();
                        showToast(`üí∞ –ü—Ä–æ–¥–∞–∂–∞ –∑–∞–ø–∏—Å–∞–Ω–∞`);
                        break;

                    case 'add_loss':
                        if (!data.name) return;
                        losses.unshift({
                            id: Date.now(),
                            name: data.name,
                            qty: parseInt(data.qty || 1),
                            cost: parseFloat(data.cost || 0),
                            reason: data.reason || 'other',
                            date: new Date().toLocaleDateString('ru-RU'),
                            timestamp: Date.now()
                        });
                        saveData(`AI: –ë—Ä–∞–∫/–£–±—ã—Ç–æ–∫`);
                        renderLosses();
                        showToast(`üìâ –£–±—ã—Ç–æ–∫ –∑–∞–ø–∏—Å–∞–Ω`);
                        break;

                    case 'add_debt':
                        if (!data.name) return;
                        debts.unshift({
                            id: Date.now(),
                            name: data.name,
                            amount: parseFloat(data.amount || 0),
                            date: new Date().toLocaleDateString('ru-RU')
                        });
                        saveData(`AI: –ù–æ–≤—ã–π –¥–æ–ª–≥`);
                        renderDebts();
                        showToast(`ü§ù –î–æ–ª–≥: ${data.name}`);
                        break;

                    case 'clear_debts':
                        debts = [];
                        saveData(`AI: –î–æ–ª–≥–∏ –æ—á–∏—â–µ–Ω—ã`);
                        renderDebts();
                        showToast(`‚úÖ –í—Å–µ –¥–æ–ª–≥–∏ —Å–ø–∏—Å–∞–Ω—ã`);
                        break;

                    case 'add_note':
                        if (!data.text) return;
                        notes.unshift({ id: Date.now(), text: data.text, date: new Date().toISOString() });
                        saveData(`AI: –ó–∞–º–µ—Ç–∫–∞`);
                        renderNotes();
                        showToast(`üìù –ó–∞–º–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞`);
                        break;

                    case 'delete_note':
                        if (data.id === 'all') notes = [];
                        saveData(`AI: –ó–∞–º–µ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω—ã`);
                        renderNotes();
                        showToast(`üóëÔ∏è –ó–∞–º–µ—Ç–∫–∏ –æ—á–∏—â–µ–Ω—ã`);
                        break;
                }
                triggerHaptic('success');
            } catch (e) {
                console.error("AI Action Error:", e);
            }
        }

        function addMessageToChat(role, text) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            container.appendChild(div);
            scrollToBottomChat();
        }

        function showTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.className = 'typing';
            div.id = id;
            div.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(div);
            scrollToBottomChat();
            return id;
        }

        function removeTypingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function saveToChatHistory(user, ai) {
            const hist = JSON.parse(localStorage.getItem('vapeChatHistory') || '[]');
            hist.unshift({
                time: new Date().toLocaleTimeString(),
                user: user,
                ai: ai
            });
            if (hist.length > 50) hist.pop();
            localStorage.setItem('vapeChatHistory', JSON.stringify(hist));
            renderAdminChatHistory();
        }

        async function renderAdminChatHistory() {
            const container = document.getElementById('adminChatHistory');
            if (!container) return;

            // –ï—Å–ª–∏ Firebase –Ω–µ –≥–æ—Ç–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –∫–∞–∫ fallback
            if (!window.firebaseDB || !window.getDocs || !window.query) {
                const hist = JSON.parse(localStorage.getItem('vapeChatHistory') || '[]');
                let html = '';
                if (hist.length === 0) {
                    html = '<div style="text-align: center; opacity: 0.4;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
                } else {
                    hist.slice(0, 10).forEach(h => {
                        html += `<div><b>L:</b> ${h.user}</div>`;
                    });
                    html += '<div style="text-align:center; opacity:0.5; font-size:10px;">(–õ–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à)</div>';
                }
                container.innerHTML = html;
                return;
            }

            container.innerHTML = '<div style="text-align:center; opacity:0.5; font-size:12px; padding:10px;">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–ª–∞—á–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏... ‚òÅÔ∏è</div>';

            try {
                const q = window.query(
                    window.collection(window.firebaseDB, "ai_chat_logs"),
                    window.orderBy("timestamp", "desc"),
                    window.limit(20)
                );

                const querySnapshot = await window.getDocs(q);

                if (querySnapshot.empty) {
                    container.innerHTML = '<div style="text-align: center; opacity: 0.4; padding:10px;">–ò—Å—Ç–æ—Ä–∏—è –≤ –æ–±–ª–∞–∫–µ –ø—É—Å—Ç–∞</div>';
                    return;
                }

                let html = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let aiText = data.aiReply ? data.aiReply.replace(/\{"action":.*\}/g, '').trim() : '';
                    if (!aiText && data.aiReply) aiText = "‚úîÔ∏è –í—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ";

                    // Format Time safely
                    let timeStr = '??:??';
                    if (data.timestamp && data.timestamp.seconds) {
                        timeStr = new Date(data.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }

                    html += `
                        <div style="margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px;">
                             <div style="font-size: 10px; opacity: 0.4; margin-bottom: 4px; display:flex; justify-content:space-between;">
                                <span>${timeStr}</span>
                                <span>${data.model || 'AI'}</span>
                             </div>
                             <div style="margin-bottom: 4px; font-size: 13px;"><b>User:</b> <span style="opacity:0.9">${data.userMessage}</span></div>
                             <div style="color: var(--accent-color); font-size: 12px; line-height: 1.4;">ü§ñ ${aiText}</div>
                        </div>
                    `;
                });
                container.innerHTML = html;

                // See next step for exposing these functions. For now, writing logic placeholder:
                /*
                const q = query(collection(db, "ai_chat_logs"), orderBy("timestamp", "desc"), limit(20));
                const querySnapshot = await getDocs(q);
                let html = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    html += `...`;
                });
                container.innerHTML = html;
                */
            } catch (e) {
                container.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏';
            }
        }

        function updateAdminAIStatus() {
            const countEl = document.getElementById('adminDailyCount');
            const today = new Date().toISOString().split('T')[0];
            const usage = JSON.parse(localStorage.getItem('vapeAIUsage') || '{}');
            const count = usage[today] || 0;
            if (countEl) countEl.innerText = `${count} / ${DAILY_MSG_LIMIT}`;
            renderAdminChatHistory();
        }

        // --- NEW FEATURES ---

        // Restore active chat from local history
        function loadChatHistory() {
            const hist = JSON.parse(localStorage.getItem('vapeChatHistory') || '[]');
            const container = document.getElementById('chatMessages');
            if (hist.length > 0 && (!container.children.length || container.innerHTML.includes('–ü—É—Å—Ç–æ'))) {
                container.innerHTML = ''; // Clean placeholder
                // Show last 10 messages
                hist.slice(0, 10).reverse().forEach(h => {
                    addMessageToChat('user', h.user);

                    // Clean AI message from JSON before showing in history
                    const cleanAi = h.ai.replace(/\{"action":.*\}/g, '').trim();
                    if (cleanAi) addMessageToChat('ai', cleanAi);
                });
                addMessageToChat('ai', '<i>–ò—Å—Ç–æ—Ä–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞...</i>');
                scrollToBottomChat();
            }
        }

        // Real-Time Data Sync
        function initRealTimeSync() {
            if (!window.firebaseOnSnapshot || !window.firebaseDoc || !window.firebaseDB) return;

            console.log("üîå Connecting Real-Time Sync...");
            const docRef = window.firebaseDoc(window.firebaseDB, "tracker", "data");

            window.firebaseOnSnapshot(docRef, (docSnap) => {
                if (!docSnap.exists()) return;
                const data = docSnap.data();

                // Basic diff check to avoid loop (if timestamps match)
                // We'll just overwrite local for now as "Cloud is Truth"

                inventory = data.inventory || [];
                sales = data.sales || [];
                debts = data.debts || [];
                losses = data.losses || [];
                notes = data.notes || [];

                // Save to localStorage so it persists on reload
                // BUT do NOT call saveData() which pushes back to cloud!
                localStorage.setItem('inventory', JSON.stringify(inventory));
                localStorage.setItem('sales', JSON.stringify(sales));
                localStorage.setItem('debts', JSON.stringify(debts));
                localStorage.setItem('losses', JSON.stringify(losses));
                localStorage.setItem('notes', JSON.stringify(notes));
                localStorage.setItem('financialGoal', data.financialGoal || 0);

                if (data.financialGoal) financialGoal = data.financialGoal;

                renderAll();
                // showToast("‚òÅÔ∏è –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã");
            });
        }

        // Start
        setTimeout(() => {
            initAI();
            loadChatHistory();
            initRealTimeSync();
        }, 1000);

        // –ö–õ–ò–ö –í–ù–ï –ß–ê–¢–ê –î–õ–Ø –ó–ê–ö–†–´–¢–ò–Ø
        window.addEventListener('mousedown', (e) => {
            const modal = document.getElementById('chatModal');
            const aiBtn = document.querySelector('.ai-btn') || document.querySelector('.btn-float[onclick*="openChatModal"]');

            // –ï—Å–ª–∏ —á–∞—Ç –æ—Ç–∫—Ä—ã—Ç –∏ –∫–ª–∏–∫ –Ω–µ –ø–æ –Ω–µ–º—É –∏ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
            if (modal && modal.style.display === 'flex') {
                if (!modal.contains(e.target) && (!aiBtn || !aiBtn.contains(e.target))) {
                    closeChatModal();
                }
            }
        });

        // Export functions to window for HTML access
        window.sendChatMessage = sendChatMessage;
        window.handleChatEnter = handleChatEnter;
        window.closeChatModal = closeChatModal;
        window.openChatModal = openChatModal;
        window.saveAISettings = saveAISettings;
        window.clearChatHistory = clearChatHistory;
        window.toggleUserAI = toggleUserAI;
        window.initAI = initAI;

    </script>
    </div> <!-- CONTAINER ENDS HERE -->
</body>

</html>