<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vape Sales Tracker</title>

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vape Tracker">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Apple Splash Screens -->
    <link rel="apple-touch-startup-image" href="vape_bg_new.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&subset=cyrillic&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-color: #050505;
            --bg-image: url('vape_bg_new.png');
            --bg-overlay: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6));
            --card-bg: rgba(20, 20, 35, 0.6);
            --accent-color: #ffffff;
            --secondary-accent: #e0e0e0;
            --text-color: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --success-color: #00ff9d;
            --danger-color: #ff3d71;
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.4);
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        body.light-theme {
            --bg-color: #f2f2f7;
            --bg-image: url('vape_bg_light.png');
            --bg-overlay: linear-gradient(rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.3));
            --card-bg: rgba(255, 255, 255, 0.65);
            /* more translucent for glass */
            --accent-color: #000000;
            --secondary-accent: rgba(0, 0, 0, 0.05);
            --text-color: #000000;
            --text-secondary: rgba(0, 0, 0, 0.6);
            --success-color: #00a83f;
            --danger-color: #ff3b30;
            --glass-border: rgba(0, 0, 0, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.05);
            --tab-active-bg: #000000;
            --tab-active-text: #ffffff;
        }

        :root {
            --tab-active-bg: #ffffff;
            --tab-active-text: #000000;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Roboto', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            /* Blur transitions handled separately for smoothness */
        }

        body {
            background-color: var(--bg-color);
            background-image:
                var(--bg-overlay),
                var(--bg-image);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: var(--text-color);
            margin: 0;
            padding: calc(45px + var(--safe-area-top)) 20px calc(110px + var(--safe-area-bottom));
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 28px;
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 8px;
            color: var(--accent-color);
            margin-bottom: 40px;
            opacity: 0.9;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0f0f19 0%, #1a1a2e 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.4s ease;
        }

        #loadingOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Navigation */
        .tabs {
            position: fixed;
            bottom: calc(25px + var(--safe-area-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 15, 25, 0.8);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-radius: 40px;
            display: flex;
            padding: 8px;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--glass-border);
            width: 95%;
            max-width: 450px;
        }

        .tab {
            flex: 1;
            padding: 12px 0;
            border-radius: 32px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: var(--text-secondary);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .tab.active {
            background: var(--tab-active-bg);
            color: var(--tab-active-text);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.15);
        }

        .page {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .page.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .theme-toggle {
            position: absolute;
            top: calc(20px + var(--safe-area-top));
            right: 20px;
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            background: var(--glass-border);
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 35px;
        }

        .total-box {
            text-align: left;
            background: var(--card-bg);
            backdrop-filter: blur(30px) saturate(150%);
            -webkit-backdrop-filter: blur(30px) saturate(150%);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 28px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            transition: backdrop-filter 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: auto;
            transform: translateZ(0);
        }

        .total-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background: var(--accent-color);
            opacity: 0.5;
        }

        .total-box.profit::before {
            background: var(--secondary-accent);
        }

        .total-box div {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 400;
        }

        .total-box span {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-color);
        }

        /* Input Card */
        .input-card {
            background: var(--card-bg);
            backdrop-filter: blur(30px) saturate(150%);
            -webkit-backdrop-filter: blur(30px) saturate(150%);
            padding: 30px;
            border-radius: 28px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            margin-bottom: 35px;
            border: 1px solid var(--glass-border);
            transition: backdrop-filter 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: auto;
            transform: translateZ(0);
        }

        .input-group {
            margin-bottom: 20px;
        }

        input,
        select {
            width: 100%;
            padding: 18px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            appearance: none;
        }

        input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: none;
            transform: translateY(-2px);
        }

        /* Light Theme Input Improvements */
        body.light-theme input,
        body.light-theme select {
            background: rgba(0, 0, 0, 0.08);
            border: 1.5px solid rgba(0, 0, 0, 0.15);
            color: #000;
        }

        body.light-theme input::placeholder,
        body.light-theme select option {
            color: rgba(0, 0, 0, 0.4);
        }

        body.light-theme input:focus,
        body.light-theme select:focus {
            background: rgba(0, 0, 0, 0.12);
            border-color: rgba(0, 0, 0, 0.3);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
            font-size: 15px;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }

        .checkbox-group input {
            display: none;
        }

        .checkbox-custom {
            width: 24px;
            height: 24px;
            border-radius: 8px;
            border: 2px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
        }

        .checkbox-group input:checked+.checkbox-custom {
            background: #ffffff;
            border-color: #ffffff;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .checkbox-custom::after {
            content: '‚úì';
            color: #000;
            font-size: 16px;
            font-weight: 800;
            display: none;
        }

        .checkbox-group input:checked+.checkbox-custom::after {
            display: block;
        }

        /* Autocomplete */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .autocomplete-list {
            position: absolute;
            top: 105%;
            left: 0;
            right: 0;
            background: rgba(20, 20, 35, 0.95);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1100;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            display: none;
        }

        .autocomplete-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: rgba(0, 242, 255, 0.1);
            color: var(--accent-color);
        }

        .autocomplete-item b {
            font-size: 16px;
        }

        .autocomplete-item small {
            font-size: 12px;
            font-weight: 800;
        }

        /* Stats */

        .main-btn {
            width: 100%;
            padding: 18px;
            border-radius: 18px;
            border: none;
            background: var(--accent-color);
            color: var(--bg-color);
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 20px var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .main-btn:active {
            transform: scale(0.97);
            box-shadow: 0 5px 10px var(--shadow-color);
        }

        body.light-theme .main-btn {
            background: #000;
            color: #fff;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        button.main-btn.btn-error {
            background: #ff4d4d !important;
            box-shadow: 0 0 30px rgba(255, 77, 77, 0.4);
            animation: error-shake 0.4s ease-in-out;
        }

        @keyframes error-shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20%,
            60% {
                transform: translateX(-5px);
            }

            40%,
            80% {
                transform: translateX(5px);
            }
        }

        /* History & Items */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 25px;
            padding: 0 5px;
        }

        .history-header h2 {
            font-size: 14px;
            margin: 0 0 12px 0;
            font-weight: 300;
            letter-spacing: 5px;
            text-transform: uppercase;
            color: var(--text-color);
            opacity: 0.6;
            user-select: none;
            -webkit-user-select: none;
        }

        .clear-btn {
            background: rgba(255, 61, 113, 0.1);
            border: 1px solid rgba(255, 61, 113, 0.4);
            color: var(--danger-color);
            padding: 0 18px;
            height: 44px;
            border-radius: 22px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clear-btn:active {
            background: var(--danger-color);
            color: white;
        }

        .date-divider {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin: 30px 0 15px;
            padding-left: 5px;
            letter-spacing: 3px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: fadeInItem 0.4s ease-out;
        }

        .date-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, var(--glass-border), transparent);
        }

        .item-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(5px);
            padding: 20px;
            border-radius: 22px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--glass-border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInItem 0.4s ease-out;
        }

        .item-card:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }

        .item-info b {
            font-size: 18px;
            color: var(--text-color);
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .item-info small {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .item-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .item-price {
            font-weight: 800;
            font-size: 18px;
            color: var(--success-color);
        }

        .delete-btn {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: #ff3d71;
            font-size: 18px;
            width: 36px;
            height: 36px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-btn:active {
            background: rgba(255, 61, 113, 0.2);
            transform: scale(0.9);
        }

        .badge {
            font-size: 10px;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        .badge.active {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #000 !important;
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }

        body.light-theme .badge.active {
            background: #000 !important;
            color: #fff !important;
        }

        .badge.toggle-btn {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-color);
            cursor: pointer;
            margin: 0;
            height: 44px;
            padding: 0 20px;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            border: 1px solid var(--glass-border);
        }

        .badge.toggle-btn:hover {
            border-color: var(--glass-border);
        }

        .badge-profit {
            background: rgba(0, 255, 157, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(0, 255, 157, 0.2);
        }

        /* Calendar Trigger */
        .date-filter-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .calendar-trigger {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--accent-color);
            position: relative;
        }

        .calendar-trigger::after {
            content: 'üìÖ';
            font-size: 18px;
        }

        .calendar-trigger.active {
            background: rgba(0, 242, 255, 0.1);
            border-color: var(--accent-color);
        }

        input[type="date"].hidden-picker {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        /* Inventory Controls */
        .qty-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qty-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .qty-btn:active {
            background: var(--accent-color);
            color: black;
            transform: scale(0.9);
        }

        .edit-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }

        .edit-btn:hover {
            color: var(--accent-color);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-card {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .modal-card h3 {
            margin-top: 0;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 800;
            letter-spacing: 1px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 40px;
            display: block;
            margin-bottom: 10px;
        }

        /* Stats Period Selector */
        .stats-period-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.05);
            /* Lighter by default */
            padding: 6px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
        }

        body.light-theme .stats-period-selector {
            background: rgba(0, 0, 0, 0.05);
        }

        .period-btn {
            flex: 1;
            padding: 12px 8px;
            border: none;
            border-radius: 16px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .period-btn.active {
            background: var(--accent-color);
            color: var(--bg-color);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.1);
        }

        /* Top Products Bar */
        .product-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .product-bar-name {
            width: 100px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-bar-fill {
            flex: 1;
            height: 24px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .product-bar-progress {
            height: 100%;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-size: 12px;
            font-weight: 600;
            transition: width 0.5s ease;
        }

        /* Low Stock Warning */
        .low-stock-warning {
            display: inline-block;
            background: linear-gradient(135deg, #ff3d71, #ff6b6b);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 8px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        /* Loss Item */
        .loss-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 61, 113, 0.1);
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #ff3d71;
        }

        .loss-item-info {
            flex: 1;
        }

        .loss-item-info b {
            font-size: 14px;
        }

        .loss-item-info small {
            display: block;
            color: var(--text-secondary);
            margin-top: 4px;
            font-size: 12px;
        }

        @keyframes fadeInItem {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        #salesDisplay {
            transition: all 0.3s ease;
            min-height: 200px;
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideDownToast 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes slideDownToast {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast.error {
            border-color: rgba(255, 61, 113, 0.3);
        }

        /* Sync Badge */
        .sync-badge {
            position: fixed;
            top: calc(10px + var(--safe-area-top));
            right: 20px;
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            letter-spacing: 1px;
            text-transform: uppercase;
            opacity: 0.8;
            pointer-events: none;
        }

        .sync-badge.online {
            color: var(--success-color);
            border-color: rgba(0, 255, 157, 0.2);
        }

        .sync-badge.offline {
            color: var(--danger-color);
            border-color: rgba(255, 61, 113, 0.2);
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Theme Toggle Only -->
        <div style="position: absolute; top: calc(20px + var(--safe-area-top)); right: 20px; z-index: 100;">
            <button id="themeToggle" class="theme-toggle" style="position: static; margin-bottom: 0;">‚òÄÔ∏è</button>
        </div>

        <h1>VAPE TRACKER</h1>

        <div class="stats-grid">
            <div class="total-box">
                <div>–í—ã—Ä—É—á–∫–∞</div>
                <span id="totalRevenue">0</span> ‚ÇΩ
            </div>
            <div class="total-box profit">
                <div>–ü—Ä–∏–±—ã–ª—å</div>
                <span id="totalProfit" style="color: var(--success-color);">0</span> ‚ÇΩ
            </div>
        </div>

        <!-- Page: Sales -->
        <div id="salesPage" class="page active">
            <div class="input-card">
                <div class="input-group autocomplete-container">
                    <input type="text" id="saleName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: Brusko)"
                        oninput="handleAutocomplete(this)" onfocus="handleAutocomplete(this)" autocomplete="off">
                    <div id="autocompleteList" class="autocomplete-list"></div>
                </div>
                <div class="input-group" style="display: flex; gap: 15px;">
                    <input type="number" id="saleQty" placeholder="–ö–æ–ª-–≤–æ" required>
                    <input type="number" id="salePrice" placeholder="–¶–µ–Ω–∞" required>
                </div>
                <div class="input-group">
                    <input type="text" id="saleNote" placeholder="–ó–∞–º–µ—Ç–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                </div>

                <div style="margin-bottom: 20px;">
                    <label class="checkbox-group">
                        <input type="checkbox" id="useDate" checked onchange="toggleDateInput()">
                        <div class="checkbox-custom"></div>
                        <span>–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞</span>
                    </label>

                    <div id="manualDateContainer" style="display: none; animation: fadeIn 0.3s ease; margin-top: 10px;">
                        <input type="date" id="saleDate"
                            style="border-radius: 16px; background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); color: white; padding: 14px;">
                    </div>
                </div>

                <button id="addSaleBtn" class="main-btn" onclick="addSale()">–ü–†–û–î–ê–¢–¨</button>
            </div>

            <div class="history-header">
                <div style="display: flex; flex-direction: column; gap: 4px; width: 100%;">
                    <div style="display: flex; gap: 4px; align-items: center; width: 100%;">
                        <select id="sortType" class="badge toggle-btn" onchange="setSortType(this.value)"
                            style="padding-right: 30px; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2210%22%20height%3D%2210%22%20viewBox%3D%220%200%2012%2012%22%20fill%3D%22none%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cpath%20d%3D%22M2%204L6%208L10%204%22%20stroke%3D%22white%22%20stroke-width%3D%221.5%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 10px center; appearance: none; outline: none; border: 1px solid var(--glass-border); flex: 1; height: 44px;">
                            <option value="date" style="background:#222; color:#fff">–ü–æ –¥–∞—Ç–µ</option>
                            <option value="amount" style="background:#222; color:#fff">–ü–æ —Å—É–º–º–µ</option>
                            <option value="name" style="background:#222; color:#fff">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                            <option value="popular" style="background:#222; color:#fff">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
                            <option value="profit_day" style="background:#222; color:#fff">–ü—Ä–∏–±—ã–ª—å–Ω—ã–π –¥–µ–Ω—å</option>
                        </select>
                        <button id="sortDirBtn" class="badge toggle-btn" onclick="toggleSortDir()"
                            style="width: 44px; min-width: 44px; padding: 0; font-size: 16px; border: 1px solid var(--glass-border);">‚Üì</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div id="calendarWrapper" class="date-filter-wrapper">
                        <div class="calendar-trigger" id="calIcon"></div>
                        <input type="date" id="dateFilter" class="hidden-picker" onchange="onDateChange(this)"
                            onfocus="document.getElementById('calIcon').classList.add('active')"
                            onblur="document.getElementById('calIcon').classList.remove('active')">
                    </div>
                    <button class="clear-btn" onclick="clearSales()">–û–ß–ò–°–¢–ò–¢–¨</button>
                </div>
            </div>
            <div id="salesDisplay"></div>
        </div>

        <!-- Page: Inventory -->
        <div id="inventoryPage" class="page">
            <div class="input-card">
                <div class="input-group">
                    <input type="text" id="invName" placeholder="–ù—É —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–π, —á–µ–º –∑–∞–∫—É–ø–∏–ª—Å—è?" required>
                </div>
                <div class="input-group" style="display: flex; gap: 15px;">
                    <input type="text" id="invStrength" placeholder="–ö—Ä–µ–ø–æ—Å—Ç—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    <input type="number" id="invQty" placeholder="–®—Ç." required>
                </div>
                <div class="input-group" style="display: flex; gap: 15px;">
                    <input type="number" id="invCost" placeholder="–ó–∞–∫—É–ø (‚ÇΩ/—à—Ç)" required>
                    <input type="number" id="invPrice" placeholder="–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (‚ÇΩ)" required>
                </div>
                <button class="main-btn" onclick="addInventory()">–ù–ê –°–ö–õ–ê–î</button>
            </div>

            <div class="history-header" style="justify-content: flex-end; margin-top: 10px; margin-bottom: 15px;">
                <button class="clear-btn" onclick="clearInventory()"
                    style="width: 44px; padding: 0; background: rgba(255, 61, 113, 0.08);"
                    title="–û—á–∏—Å—Ç–∏—Ç—å —Å–∫–ª–∞–¥">üóëÔ∏è</button>
            </div>

            <!-- Inventory Stats -->
            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="total-box">
                    <div>–ó–∞–∫—É–ø–ª–µ–Ω–æ –Ω–∞</div>
                    <span id="invTotalCost">0</span> ‚ÇΩ
                </div>
                <div class="total-box profit">
                    <div>–û–∂–∏–¥. –≤—ã—Ä—É—á–∫–∞</div>
                    <span id="invTotalRevenue">0</span> ‚ÇΩ
                </div>
            </div>

            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="total-box">
                    <div>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞</div>
                    <span id="invTotalCount">0</span> —à—Ç.
                </div>
                <div class="total-box profit">
                    <div>–†–∞–∑–Ω–æ–≤–∏–¥–Ω–æ—Å—Ç—å</div>
                    <span id="invTotalVariety">0</span> –µ–¥.
                </div>
            </div>

            <div id="inventoryDisplay"></div>
        </div>

        <!-- Page: Losses -->
        <div id="lossesPage" class="page">
            <div class="input-card" style="padding: 30px;">
                <h3 style="margin: 0 0 25px 0; text-align: center; letter-spacing: 2px;">–£–ë–´–¢–ö–ò / –°–ü–ò–°–ê–ù–ò–Ø</h3>

                <div class="total-box" style="margin-bottom: 25px; --accent-color: #ff3b30;">
                    <div>–£–±—ã—Ç–æ–∫</div>
                    <span id="lossesPageTotal" style="color: #ff3b30;">0</span> ‚ÇΩ
                </div>

                <button class="main-btn"
                    style="margin-bottom: 25px; background: linear-gradient(135deg, #ff3d71, #ff6b6b); box-shadow: 0 10px 20px rgba(255, 61, 113, 0.2);"
                    onclick="openLossModal()">–î–û–ë–ê–í–ò–¢–¨ –£–ë–´–¢–û–ö</button>

                <div id="lossesHistory"></div>

                <div style="padding: 20px 10px 0; opacity: 0.6; font-size: 13px; text-align: center; line-height: 1.5;">
                    –ó–¥–µ—Å—å —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –±—Ä–∞–∫–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã, –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ <br> –∏–ª–∏ –µ—Å–ª–∏ —Ä–µ—à–∏–ª —Å–∞–º –ø–æ–ø–∞—Ä–∏—Ç—å –∏–ª–∏ –ø–æ–¥–∞—Ä–∏—Ç—å.
                </div>
            </div>
        </div>

        <!-- Page: Stats -->
        <div id="statsPage" class="page">
            <div class="stats-period-selector">
                <button class="period-btn active" onclick="setStatsPeriod('day')">–î–µ–Ω—å</button>
                <button class="period-btn" onclick="setStatsPeriod('week')">–ù–µ–¥–µ–ª—è</button>
                <button class="period-btn" onclick="setStatsPeriod('month')">–ú–µ—Å—è—Ü</button>
                <button class="period-btn" onclick="setStatsPeriod('all')">–í—Å—ë</button>
            </div>

            <div class="stats-grid">
                <div class="total-box">
                    <div>–í—ã—Ä—É—á–∫–∞</div>
                    <span id="statRevenue">0</span> ‚ÇΩ
                </div>
                <div class="total-box profit">
                    <div>–ü—Ä–∏–±—ã–ª—å</div>
                    <span id="statProfit">0</span> ‚ÇΩ
                </div>
            </div>

            <div class="stats-grid">
                <div class="total-box" style="--accent-color: #ff6b6b;">
                    <div>–£–±—ã—Ç–∫–∏</div>
                    <span id="statLosses" style="color: #ff6b6b;">0</span> ‚ÇΩ
                </div>
                <div class="total-box" style="--accent-color: #ffd93d;">
                    <div>–ü—Ä–æ–¥–∞–∂</div>
                    <span id="statSalesCount">0</span> —à—Ç.
                </div>
            </div>

            <div class="input-card" style="padding: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--text-secondary);">üî• –¢–û–ü —Ç–æ–≤–∞—Ä—ã</h3>
                <div id="topProducts"></div>
            </div>

            <div class="input-card" style="padding: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--text-secondary);">üìâ –ù–µ –ø—Ä–æ–¥–∞—ë—Ç—Å—è</h3>
                <div id="worstProducts"></div>
            </div>
        </div>
    </div>

    <!-- Edit Inventory Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-card">
            <h3>–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –¢–û–í–ê–†</h3>
            <input type="hidden" id="editItemId">
            <div class="input-group">
                <input type="text" id="editName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            </div>
            <div class="input-group">
                <input type="text" id="editStrength" placeholder="–ö—Ä–µ–ø–æ—Å—Ç—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div class="input-group" style="display: flex; gap: 15px;">
                <input type="number" id="editCost" placeholder="–ó–∞–∫—É–ø">
                <input type="number" id="editPrice" placeholder="–ü—Ä–æ–¥–∞–∂–∞">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2;" onclick="saveEdit()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <!-- Edit Sale Modal -->
    <div id="editSaleModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="letter-spacing: 2px;">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –ü–†–û–î–ê–ñ–£</h3>
            <input type="hidden" id="editSaleId">
            <div class="input-group">
                <input type="text" id="editSaleName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            </div>
            <div class="input-group" style="display: flex; gap: 10px;">
                <input type="number" id="editSaleQty" placeholder="–ö–æ–ª-–≤–æ">
                <input type="number" id="editSalePrice" placeholder="–¶–µ–Ω–∞">
            </div>
            <div class="input-group">
                <input type="text" id="editSaleNote" placeholder="–ó–∞–º–µ—Ç–∫–∞">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2;" onclick="saveSaleEdit()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeSaleModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <!-- Add Loss Modal -->
    <div id="lossModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="color: #ff6b6b;">–î–û–ë–ê–í–ò–¢–¨ –£–ë–´–¢–û–ö</h3>
            <div class="input-group">
                <div class="autocomplete-container" style="width: 100%;">
                    <input type="text" id="lossName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" autocomplete="off">
                    <div id="lossAutocompleteList" class="autocomplete-list"></div>
                </div>
            </div>
            <div class="input-group" style="display: flex; gap: 15px;">
                <input type="number" id="lossQty" placeholder="–ö–æ–ª-–≤–æ">
                <input type="number" id="lossCost" placeholder="–ó–∞–∫—É–ø —Ü–µ–Ω–∞">
            </div>
            <div class="input-group">
                <select id="lossReason"
                    style="width: 100%; padding: 14px; border-radius: 16px; background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); color: white; font-size: 16px;">
                    <option value="defect">–ë—Ä–∞–∫</option>
                    <option value="lost">–ü–æ—Ç–µ—Ä—è–Ω</option>
                    <option value="gift">–ü–æ–¥–∞—Ä–∏–ª</option>
                    <option value="self">–û—Å—Ç–∞–≤–∏–ª —Å–µ–±–µ</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>

            <div class="checkbox-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="lossDeductStock" checked>
                    <div class="checkbox-custom"></div>
                    <span>–°–ø–∏—Å–∞—Ç—å —Å–æ —Å–∫–ª–∞–¥–∞</span>
                </label>
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <input type="text" id="lossNote" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2; background: linear-gradient(135deg, #ff3d71, #ff6b6b);"
                    onclick="saveLoss()">–î–û–ë–ê–í–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeLossModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <!-- Edit Loss Modal -->
    <div id="editLossModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="color: #ff6b6b; letter-spacing: 2px;">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –£–ë–´–¢–û–ö</h3>
            <input type="hidden" id="editLossId">
            <div class="input-group">
                <input type="text" id="editLossName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
            </div>
            <div class="input-group" style="display: flex; gap: 15px;">
                <input type="number" id="editLossQty" placeholder="–ö–æ–ª-–≤–æ">
                <input type="number" id="editLossCost" placeholder="–ó–∞–∫—É–ø —Ü–µ–Ω–∞">
            </div>
            <div class="input-group">
                <select id="editLossReason"
                    style="width: 100%; padding: 14px; border-radius: 16px; background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); color: white; font-size: 16px;">
                    <option value="defect">–ë—Ä–∞–∫</option>
                    <option value="lost">–ü–æ—Ç–µ—Ä—è–Ω</option>
                    <option value="gift">–ü–æ–¥–∞—Ä–∏–ª</option>
                    <option value="self">–û—Å—Ç–∞–≤–∏–ª —Å–µ–±–µ</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>
            <div class="input-group" style="margin-top: 20px;">
                <input type="text" id="editLossNote" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2; background: linear-gradient(135deg, #ff3d71, #ff6b6b);"
                    onclick="saveLossEdit()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeLossEditModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <!-- Duplicate Conflict Modal -->
    <div id="duplicateConflictModal" class="modal-overlay">
        <div class="modal-card" style="text-align: center;">
            <h3 style="color: #ffd93d;">–¢–û–í–ê–† –£–ñ–ï –ï–°–¢–¨</h3>
            <p style="font-size: 14px; opacity: 0.8; margin-bottom: 20px;">
                –¢–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω–∞ –∏ –∫—Ä–µ–ø–æ—Å—Ç—å) —É–∂–µ –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ. –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?
            </p>
            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                <button class="main-btn" style="background: var(--success-color); color: #000;"
                    onclick="handleMergeResult('merge')">–û–ë–™–ï–î–ò–ù–ò–¢–¨ –°–£–ú–ú–£</button>
                <button class="main-btn" style="background: rgba(255,255,255,0.1);"
                    onclick="handleMergeResult('new')">–î–û–ë–ê–í–ò–¢–¨ –ö–ê–ö –ù–û–í–´–ô</button>
            </div>
            <div class="checkbox-group" style="justify-content: center;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="dontAskMerge">
                    <div class="checkbox-custom"></div>
                    <span style="font-size: 12px;">–ë–æ–ª—å—à–µ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å</span>
                </label>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <div class="sync-badge online" id="syncStatus">
        <span id="syncIcon">‚òÅÔ∏è</span> <span id="syncText">–°–ï–¢–¨: OK</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('sales')"><span
                style="font-size: 18px;">üí∏</span><span>–ü—Ä–æ–¥–∞–∂–∏</span></div>
        <div class="tab" onclick="switchTab('inventory')"><span style="font-size: 18px;">üì¶</span><span>–°–∫–ª–∞–¥</span>
        </div>
        <div class="tab" onclick="switchTab('losses')"><span style="font-size: 18px;">üìâ</span><span>–£–±—ã—Ç–∫–∏</span>
        </div>
        <div class="tab" onclick="switchTab('stats')"><span style="font-size: 18px;">üìä</span><span>–ò—Ç–æ–≥–∏</span>
        </div>
        <div class="tab" onclick="switchTab('data')"><span style="font-size: 18px;">‚öôÔ∏è</span><span>–ò–Ω—Ñ–æ</span></div>
    </div>

    <!-- Data & Settings Page -->
    <div id="dataPage" class="page">
        <!-- Statistics Cards -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
            <div
                style="background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 15px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center;">
                <div style="font-size: 24px; margin-bottom: 5px;">üìä</div>
                <div
                    style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px;">
                    –ü—Ä–æ–¥–∞–∂</div>
                <div id="infoSalesCount" style="font-size: 20px; font-weight: 700; color: var(--accent-color);">0</div>
            </div>
            <div
                style="background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 15px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center;">
                <div style="font-size: 24px; margin-bottom: 5px;">üì¶</div>
                <div
                    style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px;">
                    –ù–∞ —Å–∫–ª–∞–¥–µ</div>
                <div id="infoInventoryCount" style="font-size: 20px; font-weight: 700; color: var(--accent-color);">0
                </div>
            </div>
        </div>

        <!-- Data Management Card -->
        <div class="input-card">
            <h3 style="margin-top: 0; margin-bottom: 20px; text-align: center; letter-spacing: 2px; font-size: 14px;">
                –î–ê–ù–ù–´–ï</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <button class="main-btn" onclick="exportData()"
                    style="padding: 14px 10px; font-size: 11px; background: rgba(0,0,0,0.05); color: var(--text-color); border: 1px solid var(--glass-border);">
                    ‚¨áÔ∏è –ë–≠–ö–ê–ü
                </button>
                <button class="main-btn" onclick="document.getElementById('importFile').click()"
                    style="padding: 14px 10px; font-size: 11px; background: rgba(0,0,0,0.05); color: var(--text-color); border: 1px solid var(--glass-border);">
                    ‚¨ÜÔ∏è –ó–ê–ì–†–£–ó–ò–¢–¨
                </button>
            </div>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">

            <button class="main-btn" onclick="shareData()" style="margin-bottom: 15px;">
                üì§ –ü–û–î–ï–õ–ò–¢–¨–°–Ø –î–ê–ù–ù–´–ú–ò
            </button>

            <button class="main-btn" onclick="openHelpPage()"
                style="background: rgba(0,242,255,0.15); color: var(--accent-color); border: 1.5px solid rgba(0,242,255,0.3);">
                ‚ùì –ö–ê–ö –ü–û–õ–¨–ó–û–í–ê–¢–¨–°–Ø?
            </button>

            <div
                style="margin-top: 20px; background: rgba(255,255,255,0.05); padding: 18px; border-radius: 18px; border: 1px solid var(--glass-border);">
                <h4
                    style="margin-top: 0; margin-bottom: 12px; color: var(--accent-color); font-size: 13px; text-transform: uppercase; letter-spacing: 1.5px;">
                    –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:</h4>
                <div style="font-size: 13px; line-height: 1.6; color: var(--text-color); opacity: 0.9;">
                    <p style="margin-bottom: 10px;">üíæ <b>–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∫–æ–ø–∏—é:</b> –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø, —á—Ç–æ–±—ã –Ω–µ
                        –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ.</p>
                    <p style="margin: 0;">üîÑ <b>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:</b> –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–ø–∞–ª–∏ ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª –∏ –≤—ã–±–µ—Ä–∏—Ç–µ
                        —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞. –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏—Å—Ç–æ—Ä–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–µ—Ä–Ω—É—Ç—Å—è.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Page Modal -->
    <div id="helpPageModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 600px; margin: 0 auto; padding: calc(45px + var(--safe-area-top)) 20px 120px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; font-size: 18px; letter-spacing: 2px;">–ö–ê–ö –ü–û–õ–¨–ó–û–í–ê–¢–¨–°–Ø?</h2>
                <button onclick="closeHelpPage()"
                    style="background: none; border: none; font-size: 28px; color: var(--text-color); cursor: pointer; padding: 10px;">‚úï</button>
            </div>

            <!-- Sales Section -->
            <div class="input-card" style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: var(--accent-color);">üí∏ –ü—Ä–æ–¥–∞–∂–∏</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–ó–¥–µ—Å—å –≤—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç–µ –∫–∞–∂–¥—É—é –ø—Ä–æ–¥–∞–∂—É:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><b>–ù–∞–∑–≤–∞–Ω–∏–µ</b> ‚Äî –Ω–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å, –∏ —Ç–æ–≤–∞—Ä—ã —Å–æ —Å–∫–ª–∞–¥–∞ –ø–æ—è–≤—è—Ç—Å—è –≤ –ø–æ–¥—Å–∫–∞–∑–∫–∞—Ö</li>
                        <li><b>–ö–æ–ª-–≤–æ</b> ‚Äî —Å–∫–æ–ª—å–∫–æ —à—Ç—É–∫ –ø—Ä–æ–¥–∞–ª–∏</li>
                        <li><b>–¶–µ–Ω–∞</b> ‚Äî –∑–∞ —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–¥–∞–ª–∏ (—Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏)</li>
                        <li><b>–ó–∞–º–µ—Ç–∫–∞</b> ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</li>
                    </ul>
                    <p style="margin: 10px 0 0 0;">–ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Ç–æ–≤–∞—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å–æ —Å–∫–ª–∞–¥–∞, –∞ –ø—Ä–∏–±—ã–ª—å
                        —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫: —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ ‚àí –∑–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞.</p>
                </div>
            </div>

            <!-- Inventory Section -->
            <div class="input-card" style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: var(--accent-color);">üì¶ –°–∫–ª–∞–¥</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–°—é–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç–µ —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–∫—É–ø–∏–ª–∏:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><b>–ù–∞–∑–≤–∞–Ω–∏–µ</b> ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: Brusko –Ø–≥–æ–¥–Ω—ã–π –º–∏–∫—Å)</li>
                        <li><b>–ö–æ–ª-–≤–æ</b> ‚Äî —Å–∫–æ–ª—å–∫–æ —à—Ç—É–∫ –∑–∞–∫—É–ø–∏–ª–∏</li>
                        <li><b>–ó–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞</b> ‚Äî –∑–∞ —Å–∫–æ–ª—å–∫–æ –∫—É–ø–∏–ª–∏ (–æ–¥–Ω–∞ —à—Ç—É–∫–∞)</li>
                    </ul>
                    <p style="margin: 10px 0 0 0;">–ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ –µ—Å—Ç—å ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫
                        —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é.</p>
                </div>
            </div>

            <!-- Losses Section -->
            <div class="input-card" style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: var(--accent-color);">üìâ –£–±—ã—Ç–∫–∏</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –ø–æ—Ç–µ—Ä–∏: –±—Ä–∞–∫, –∫—Ä–∞–∂–∞, –ø—Ä–æ—Å—Ä–æ—á–∫–∞ –∏ —Ç.–¥.</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><b>–ù–∞–∑–≤–∞–Ω–∏–µ</b> ‚Äî –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∏–∑ —Å–∫–ª–∞–¥–∞ –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</li>
                        <li><b>–ö–æ–ª-–≤–æ</b> ‚Äî —Å–∫–æ–ª—å–∫–æ —à—Ç—É–∫ –ø–æ—Ç–µ—Ä—è–Ω–æ</li>
                        <li><b>–ó–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞</b> ‚Äî –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—É–º–º—ã —É–±—ã—Ç–∫–∞</li>
                        <li><b>–ü—Ä–∏—á–∏–Ω–∞</b> ‚Äî –ø–æ—á–µ–º—É —Ç–æ–≤–∞—Ä —Å–ø–∏—Å–∞–Ω</li>
                        <li><b>–°–ø–∏—Å–∞—Ç—å —Å–æ —Å–∫–ª–∞–¥–∞</b> ‚Äî —É–º–µ–Ω—å—à–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</li>
                    </ul>
                </div>
            </div>

            <!-- Stats Section -->
            <div class="input-card" style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: var(--accent-color);">üìä –ò—Ç–æ–≥–∏</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><b>–í—ã—Ä—É—á–∫–∞</b> ‚Äî —Å—É–º–º–∞ –≤—Å–µ—Ö –ø—Ä–æ–¥–∞–∂</li>
                        <li><b>–ü—Ä–∏–±—ã–ª—å</b> ‚Äî –≤—ã—Ä—É—á–∫–∞ –º–∏–Ω—É—Å –∑–∞–∫—É–ø–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</li>
                        <li><b>–£–±—ã—Ç–∫–∏</b> ‚Äî –æ–±—â–∞—è —Å—É–º–º–∞ —Å–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</li>
                        <li><b>–¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤</b> ‚Äî —Å–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏</li>
                    </ul>
                    <p style="margin: 10px 0 0 0;">–ú–æ–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –¥–∞—Ç–∞–º –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞ –¥–µ–Ω—å, –Ω–µ–¥–µ–ª—é –∏–ª–∏ –º–µ—Å—è—Ü.</p>
                </div>
            </div>

            <!-- Data Section -->
            <div class="input-card">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: var(--accent-color);">‚öôÔ∏è –ò–Ω—Ñ–æ</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><b>–ë—ç–∫–∞–ø</b> ‚Äî —Å–∫–∞—á–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª</li>
                        <li><b>–ó–∞–≥—Ä—É–∑–∏—Ç—å</b> ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞</li>
                        <li><b>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</b> ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±—ç–∫–∞–ø —á–µ—Ä–µ–∑ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</li>
                    </ul>
                    <p style="margin: 10px 0 0 0;">‚ö†Ô∏è –î–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø —Ä–µ–≥—É–ª—è—Ä–Ω–æ! –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏ –º–æ–≥—É—Ç
                        –ø—Ä–æ–ø–∞—Å—Ç—å –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCScA2lHy_jvWi3J7Lf2bLTje_HR-AHeZc",
            authDomain: "vape-price.firebaseapp.com",
            projectId: "vape-price",
            storageBucket: "vape-price.firebasestorage.app",
            messagingSenderId: "251545583200",
            appId: "1:251545583200:web:037acd5796580e28c6cd05",
            measurementId: "G-03V6W6RVYL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        enableIndexedDbPersistence(db).catch((err) => {
            console.warn('Persistence status:', err.code);
        });

        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseAuth = auth;

        // Auto-login to Firebase using our hardcoded admin account
        // This keeps the database private while keeping the UI login simple
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Firebase Authenticated üîì");
                updateSyncUI(true);
                loadCloudData(); // Load after auth
            } else {
                console.log("Authenticating Firebase...");
                signInWithEmailAndPassword(auth, "admin@vape.com", "artemvape")
                    .catch(err => console.error("Firebase Auth Error:", err));
            }
        });

        window.addEventListener('online', () => updateSyncUI(navigator.onLine && !!auth.currentUser));
        window.addEventListener('offline', () => updateSyncUI(false));

        function updateSyncUI(online) {
            const badge = document.getElementById('syncStatus');
            const text = document.getElementById('syncText');
            if (badge && text) {
                if (online) {
                    badge.className = 'sync-badge online';
                    text.textContent = '–°–ï–¢–¨: OK';
                } else {
                    badge.className = 'sync-badge offline';
                    text.textContent = '–û–§–§–õ–ê–ô–ù';
                }
            }
        }
    </script>

    <script>
        // Auth Check - redirect to login if not authenticated
        if (!sessionStorage.getItem('vapeAuth') && !localStorage.getItem('vapeAuthRemember')) {
            window.location.href = 'login.html';
        }

        // Data State
        let sales = JSON.parse(localStorage.getItem('vapeSales')) || [];
        let inventory = JSON.parse(localStorage.getItem('vapeInventory')) || [];
        let losses = JSON.parse(localStorage.getItem('vapeLosses')) || [];

        // Load cloud data on startup removed from here, handled by onAuthStateChanged
        let sortType = localStorage.getItem('vapeSortType') || 'date';
        let sortDir = localStorage.getItem('vapeSortDir') || 'desc';
        let statsPeriod = 'day';

        // Anti-duplicate protection vars
        let lastAddedSignature = '';
        let lastAddedTime = 0;

        let pendingInventoryItem = null;
        let vapeDontAskMerge = localStorage.getItem('vapeDontAskMerge') === 'true';

        // Loading animation
        window.addEventListener('DOMContentLoaded', () => {
            const overlay = document.getElementById('loadingOverlay');
            setTimeout(() => {
                overlay.classList.add('hidden');
                setTimeout(() => overlay.remove(), 400);
            }, 600); // Show for 600ms
        });

        // Tab Switching
        let isSwitching = false;

        function switchTab(tabName) {
            if (isSwitching) return;

            const currentTab = document.querySelector('.tab.active');
            let targetTabIndex = 1;
            if (tabName === 'inventory') targetTabIndex = 2;
            if (tabName === 'losses') targetTabIndex = 3;
            if (tabName === 'stats') targetTabIndex = 4;
            if (tabName === 'data') targetTabIndex = 5;

            const targetTab = document.querySelector(`.tab:nth-child(${targetTabIndex})`);

            // If clicking same tab, do nothing
            if (currentTab === targetTab) return;

            isSwitching = true;

            // 1. Update Tabs immediately for responsiveness
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            targetTab.classList.add('active');

            // 2. Find active page
            const activePage = document.querySelector('.page.active');
            let targetPageId = 'salesPage';
            if (tabName === 'inventory') targetPageId = 'inventoryPage';
            if (tabName === 'losses') targetPageId = 'lossesPage';
            if (tabName === 'stats') targetPageId = 'statsPage';
            if (tabName === 'data') targetPageId = 'dataPage';

            const targetPage = document.getElementById(targetPageId);

            // Helper to render data
            const renderData = () => {
                if (tabName === 'sales') renderSales();
                else if (tabName === 'inventory') renderInventory();
                else if (tabName === 'losses') renderLosses();
                else if (tabName === 'stats') renderStats();
                else if (tabName === 'data') updateInfoPageStats();
            };

            // 3. Sequential Transition
            if (activePage) {
                // Fade out old
                activePage.classList.remove('active');

                // Wait for CSS transition (300ms)
                setTimeout(() => {
                    activePage.style.display = 'none';

                    renderData(); // Update data before showing

                    // Show new page (invisible state)
                    targetPage.style.display = 'block';
                    // Force reflow
                    void targetPage.offsetWidth;

                    // Fade in new
                    targetPage.classList.add('active');

                    isSwitching = false;
                }, 300);
            } else {
                // Initial load or edge case
                renderData();
                targetPage.style.display = 'block';
                setTimeout(() => targetPage.classList.add('active'), 10);
                isSwitching = false;
            }
        }

        // Inventory Logic
        function addInventory() {
            const name = document.getElementById('invName').value.trim();
            const strength = document.getElementById('invStrength').value.trim();
            const qty = parseInt(document.getElementById('invQty').value);
            const cost = parseFloat(document.getElementById('invCost').value);
            const price = parseFloat(document.getElementById('invPrice').value);

            if (name && !isNaN(qty) && !isNaN(cost) && !isNaN(price)) {
                const newItem = { id: Date.now(), name, strength, qty, cost, price };

                // Check for strict duplicate (Name + Strength + Cost + Price)
                const existing = inventory.find(i =>
                    i.name.toLowerCase() === name.toLowerCase() &&
                    (i.strength || '').toLowerCase() === strength.toLowerCase() &&
                    i.cost === cost &&
                    i.price === price
                );

                if (existing && !vapeDontAskMerge) {
                    pendingInventoryItem = newItem;
                    document.getElementById('duplicateConflictModal').style.display = 'flex';
                } else if (existing && vapeDontAskMerge) {
                    // Merge automatically if user said "don't ask"
                    existing.qty += qty;
                    finalizeInventoryAdd();
                } else {
                    inventory.push(newItem);
                    finalizeInventoryAdd();
                }
            } else {
                alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è —Å–∫–ª–∞–¥–∞!");
            }
        }

        function handleMergeResult(action) {
            if (!pendingInventoryItem) return;

            if (action === 'merge') {
                const existing = inventory.find(i =>
                    i.name.toLowerCase() === pendingInventoryItem.name.toLowerCase() &&
                    (i.strength || '').toLowerCase() === (pendingInventoryItem.strength || '').toLowerCase() &&
                    i.cost === pendingInventoryItem.cost &&
                    i.price === pendingInventoryItem.price
                );
                if (existing) existing.qty += pendingInventoryItem.qty;
            } else {
                inventory.push(pendingInventoryItem);
            }

            if (document.getElementById('dontAskMerge').checked) {
                vapeDontAskMerge = true;
                localStorage.setItem('vapeDontAskMerge', 'true');
            }

            finalizeInventoryAdd();
            document.getElementById('duplicateConflictModal').style.display = 'none';
        }

        function finalizeInventoryAdd() {
            document.getElementById('invName').value = '';
            document.getElementById('invStrength').value = '';
            document.getElementById('invQty').value = '';
            document.getElementById('invCost').value = '';
            document.getElementById('invPrice').value = '';
            pendingInventoryItem = null;
            saveData();
            renderInventory();
        }

        function deleteInventory(id) {
            if (confirm("–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä —Å–æ —Å–∫–ª–∞–¥–∞?")) {
                inventory = inventory.filter(i => i.id !== id);
                saveData();
                renderInventory();
                updateDatalist();
            }
        }

        function renderInventory() {
            const display = document.getElementById('inventoryDisplay');
            display.innerHTML = '';

            let totalCost = 0;
            let totalRevenue = 0;
            let totalCount = 0;
            inventory.forEach(item => {
                totalCost += item.cost * item.qty;
                totalRevenue += (item.price || 0) * item.qty;
                totalCount += item.qty;
            });

            document.getElementById('invTotalCost').textContent = totalCost.toLocaleString('ru-RU');
            document.getElementById('invTotalRevenue').textContent = totalRevenue.toLocaleString('ru-RU');
            document.getElementById('invTotalCount').textContent = totalCount.toLocaleString('ru-RU');
            document.getElementById('invTotalVariety').textContent = inventory.length.toLocaleString('ru-RU');

            if (inventory.length === 0) {
                display.innerHTML = '<div class="empty-state">–°–∫–ª–∞–¥ –ø—É—Å—Ç</div>';
                return;
            }

            inventory.forEach(item => {
                const lowStockWarning = item.qty === 1 ? '<span class="low-stock-warning">‚ö†Ô∏è –ü–æ—Å–ª–µ–¥–Ω–∏–π!</span>' :
                    item.qty === 0 ? '<span class="low-stock-warning" style="background: #666;">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>' : '';
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-info">
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <b style="font-size: 17px;">${item.name}</b>
                            ${item.strength ? `<span class="badge" style="background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); padding: 5px 10px; opacity: 0.8;">${item.strength}</span>` : ''}
                            <button class="edit-btn" onclick="openEdit(${item.id})">‚úé</button>
                            ${lowStockWarning}
                        </div>
                        <small style="margin-top: 5px; display: block;">–í –Ω–∞–ª–∏—á–∏–∏: ${item.qty} —à—Ç. | –ó–∞–∫—É–ø: ${item.cost} ‚ÇΩ | –ü—Ä–æ–¥.: ${item.price || 0} ‚ÇΩ</small>
                    </div>
                    <div class="item-right" style="flex-direction: row; align-items: center; gap: 8px;">
                        <div class="qty-controls">
                            <div class="qty-btn" onclick="updateQty(${item.id}, -1)">‚àí</div>
                            <div class="qty-btn" onclick="updateQty(${item.id}, 1)">+</div>
                        </div>
                        <button class="delete-btn" onclick="deleteInventory(${item.id})">√ó</button>
                    </div>
                `;
                display.appendChild(card);
            });
        }

        function updateQty(id, change) {
            const item = inventory.find(i => i.id === id);
            if (item) {
                item.qty = Math.max(0, item.qty + change);
                saveData();
                renderInventory();
            }
        }

        function openEdit(id) {
            const item = inventory.find(i => i.id === id);
            if (item) {
                document.getElementById('editItemId').value = id;
                document.getElementById('editName').value = item.name;
                document.getElementById('editStrength').value = item.strength || '';
                document.getElementById('editCost').value = item.cost;
                document.getElementById('editPrice').value = item.price;
                document.getElementById('editModal').style.display = 'flex';
            }
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function saveEdit() {
            const id = parseInt(document.getElementById('editItemId').value);
            const name = document.getElementById('editName').value.trim();
            const strength = document.getElementById('editStrength').value.trim();
            const cost = parseFloat(document.getElementById('editCost').value);
            const price = parseFloat(document.getElementById('editPrice').value);

            if (name && !isNaN(cost) && !isNaN(price)) {
                const item = inventory.find(i => i.id === id);
                if (item) {
                    item.name = name;
                    item.strength = strength;
                    item.cost = cost;
                    item.price = price;
                    saveData();
                    renderInventory();
                    closeModal();
                }
            } else {
                alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
            }
        }

        // Autocomplete Logic
        function handleAutocomplete(input) {
            const val = input.value.toLowerCase();
            const list = document.getElementById('autocompleteList');
            list.innerHTML = '';

            if (!val && document.activeElement !== input) {
                list.style.display = 'none';
                return;
            }

            const matches = inventory.filter(i => i.name.toLowerCase().includes(val));

            if (matches.length > 0) {
                matches.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.innerHTML = `<b>${item.name}</b> <small style="float: right; color: var(--accent-color)">${item.qty} —à—Ç.</small>`;
                    div.onclick = () => {
                        input.value = item.name;
                        document.getElementById('salePrice').value = item.price || '';
                        list.style.display = 'none';
                    };
                    list.appendChild(div);
                });
                list.style.display = 'block';
            } else {
                list.style.display = 'none';
            }
        }

        // Close lists on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                document.getElementById('autocompleteList').style.display = 'none';
            }
        });

        // Sales Logic
        function toggleDateInput() {
            const useDate = document.getElementById('useDate').checked;
            document.getElementById('manualDateContainer').style.display = useDate ? 'none' : 'block';
        }

        function addSale() {
            const name = document.getElementById('saleName').value.trim();
            const qty = parseInt(document.getElementById('saleQty').value);
            const price = parseFloat(document.getElementById('salePrice').value);
            const note = document.getElementById('saleNote').value.trim();
            const useDate = document.getElementById('useDate').checked;
            const manualDate = document.getElementById('saleDate').value;

            if (name && !isNaN(qty) && !isNaN(price)) {
                // Anti-duplication check
                const currentSignature = `${name}|${qty}|${price}|${note}`;
                const timeNow = Date.now();
                if (currentSignature === lastAddedSignature && (timeNow - lastAddedTime < 5000)) {
                    const btn = document.getElementById('addSaleBtn');
                    btn.classList.add('btn-error');
                    btn.innerText = '–ü–û–î–û–ñ–î–ò–¢–ï...';

                    setTimeout(() => {
                        btn.classList.remove('btn-error');
                        btn.innerText = '–ü–†–û–î–ê–¢–¨';
                    }, 1000);
                    return;
                }

                let costPrice = 0;

                // Deduct from inventory if matched
                const invItem = inventory.find(i => i.name.toLowerCase() === name.toLowerCase());
                if (invItem) {
                    if (invItem.qty < qty) {
                        if (!confirm(`–ù–∞ —Å–∫–ª–∞–¥–µ –≤—Å–µ–≥–æ ${invItem.qty}. –ü—Ä–æ–¥–∞—Ç—å –≤—Å–µ —Ä–∞–≤–Ω–æ?`)) return;
                    }
                    costPrice = invItem.cost;
                    invItem.qty -= qty;
                }

                const now = new Date();
                let saleDateStr = now.toLocaleDateString('ru-RU');

                if (!useDate) {
                    if (manualDate) {
                        const d = new Date(manualDate);
                        saleDateStr = d.toLocaleDateString('ru-RU');
                    } else {
                        saleDateStr = '–ë–µ–∑ –¥–∞—Ç—ã';
                    }
                }

                const sale = {
                    id: Date.now(),
                    name,
                    qty,
                    price,
                    cost: costPrice,
                    date: saleDateStr,
                    timestamp: now.getTime(),
                    note: note || ''
                };

                sales.unshift(sale);

                lastAddedSignature = currentSignature;
                lastAddedTime = timeNow;

                saveData();
                renderSales();
                renderInventory(); // update stock count in view if switched back
                updateDatalist();

                document.getElementById('saleName').value = '';
                document.getElementById('saleQty').value = '';
                document.getElementById('salePrice').value = '';
                document.getElementById('saleNote').value = '';
            } else {
                alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è –ø—Ä–æ–¥–∞–∂–∏!");
            }
        }

        function deleteSale(id) {
            if (confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É?")) {
                sales = sales.filter(s => s.id !== id);
                saveData();
                renderSales();
            }
        }

        // Edit Sale Functions
        function openSaleEdit(id) {
            const sale = sales.find(s => s.id === id);
            if (sale) {
                document.getElementById('editSaleId').value = id;
                document.getElementById('editSaleName').value = sale.name || '';
                document.getElementById('editSaleQty').value = sale.qty || '';
                document.getElementById('editSalePrice').value = sale.price || '';
                document.getElementById('editSaleNote').value = sale.note || '';
                document.getElementById('editSaleModal').style.display = 'flex';
            }
        }

        function closeSaleModal() {
            document.getElementById('editSaleModal').style.display = 'none';
        }

        function saveSaleEdit() {
            const id = parseInt(document.getElementById('editSaleId').value);
            const name = document.getElementById('editSaleName').value.trim();
            const qty = parseInt(document.getElementById('editSaleQty').value);
            const price = parseFloat(document.getElementById('editSalePrice').value);
            const note = document.getElementById('editSaleNote').value.trim();

            if (!name || isNaN(qty) || isNaN(price)) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            const sale = sales.find(s => s.id === id);
            if (sale) {
                sale.name = name;
                sale.qty = qty;
                sale.price = price;
                sale.note = note;
                saveData();
                renderSales();
                closeSaleModal();
            }
        }

        function setSortType(type) {
            sortType = type;
            localStorage.setItem('vapeSortType', type);
            renderSales();
        }

        function toggleSortDir() {
            sortDir = sortDir === 'desc' ? 'asc' : 'desc';
            localStorage.setItem('vapeSortDir', sortDir);
            renderSales();
        }

        function updateSortUI() {
            document.getElementById('sortType').value = sortType;
            const dirBtn = document.getElementById('sortDirBtn');
            dirBtn.innerText = sortDir === 'desc' ? '‚Üì' : '‚Üë';
            dirBtn.style.display = sortType === 'profit_day' ? 'none' : 'flex';
        }

        function renderSales() {
            const display = document.getElementById('salesDisplay');
            const totalRevEl = document.getElementById('totalRevenue');
            const totalProfEl = document.getElementById('totalProfit');
            const filterDate = document.getElementById('dateFilter').value;

            display.innerHTML = '';

            updateSortUI();

            if (!['date', 'amount', 'name', 'popular', 'profit_day'].includes(sortType)) {
                sortType = 'date';
                localStorage.setItem('vapeSortType', 'date');
                updateSortUI();
            }

            let filteredSales = sales;
            if (filterDate) {
                const [y, m, d] = filterDate.split('-');
                const formattedFilter = `${parseInt(d)}.${parseInt(m)}.${y}`;
                filteredSales = sales.filter(s => {
                    const [sd, sm, sy] = s.date.split('.');
                    return `${parseInt(sd)}.${parseInt(sm)}.${sy}` === formattedFilter;
                });
            }

            let totalRev = 0;
            let totalProf = 0;

            // Stats (Filtered by date)
            filteredSales.forEach(s => {
                totalRev += (s.price * s.qty);
                totalProf += (s.price - (s.cost || 0)) * s.qty;
            });

            if (totalRevEl) totalRevEl.innerText = totalRev.toLocaleString('ru-RU');
            if (totalProfEl) totalProfEl.innerText = totalProf.toLocaleString('ru-RU');

            if (filteredSales.length === 0) {
                display.innerHTML = `<div class="empty-state">${filterDate ? '–ù–∞ —ç—Ç—É –¥–∞—Ç—É –ø—É—Å—Ç–æ' : '–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–¥–∞–∂'}</div>`;
                return;
            }

            if (sortType === 'date' || sortType === 'profit_day') {
                // Grouped views
                const groups = {};
                filteredSales.forEach(s => {
                    if (!groups[s.date]) {
                        groups[s.date] = { items: [], totalProfit: 0, dateObj: null };
                        if (s.date !== '–ë–µ–∑ –¥–∞—Ç—ã') {
                            const [d, m, y] = s.date.split('.');
                            groups[s.date].dateObj = new Date(y, m - 1, d);
                        }
                    }
                    groups[s.date].items.push(s);
                    groups[s.date].totalProfit += (s.price - (s.cost || 0)) * s.qty;
                });

                const sortedDates = Object.keys(groups).sort((a, b) => {
                    if (sortType === 'profit_day') {
                        return groups[b].totalProfit - groups[a].totalProfit;
                    } else if (sortDir === 'desc') {
                        if (a === '–ë–µ–∑ –¥–∞—Ç—ã') return 1;
                        if (b === '–ë–µ–∑ –¥–∞—Ç—ã') return -1;
                        return (groups[b].dateObj || 0) - (groups[a].dateObj || 0);
                    } else {
                        if (a === '–ë–µ–∑ –¥–∞—Ç—ã') return -1;
                        if (b === '–ë–µ–∑ –¥–∞—Ç—ã') return 1;
                        return (groups[a].dateObj || 0) - (groups[b].dateObj || 0);
                    }
                });

                sortedDates.forEach(date => {
                    const group = groups[date];
                    const div = document.createElement('div');
                    let html = `<div class="date-divider">${date} ${sortType === 'profit_day' ? `<span style="font-size:10px; opacity:0.7; margin-left:auto;">+${group.totalProfit.toLocaleString('ru-RU')} ‚ÇΩ</span>` : ''}</div>`;
                    group.items.forEach(s => {
                        const profit = (s.price - s.cost) * s.qty;
                        const noteHtml = s.note ? `<div style="margin-top: 6px; font-style: italic; color: var(--accent-color); font-size: 13px;">"–∑–∞–º–µ—Ç–∫–∞: ${s.note}"</div>` : '';
                        html += `
                            <div class="item-card">
                                <div class="item-info">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <b>${s.name}</b>
                                        <button class="edit-btn" onclick="openSaleEdit(${s.id})">‚úé</button>
                                    </div>
                                    <small>${sortType === 'profit_day' ? s.date + ' ‚Ä¢ ' : ''}${s.qty} —à—Ç. √ó ${s.price} ‚ÇΩ ${s.cost > 0 ? `<span class="badge badge-profit">+${profit.toLocaleString('ru-RU')} ‚ÇΩ</span>` : ''}</small>
                                    ${noteHtml}
                                </div>
                                <div class="item-right">
                                    <span class="item-price">${(s.price * s.qty).toLocaleString('ru-RU')} ‚ÇΩ</span>
                                    <button class="delete-btn" onclick="deleteSale(${s.id})">√ó</button>
                                </div>
                            </div>
                        `;
                    });
                    div.innerHTML = html;
                    display.appendChild(div);
                });
            } else {
                // Flat views (Amount, Name, Popular)
                const itemsToSort = [...filteredSales];

                if (sortType === 'amount') {
                    itemsToSort.sort((a, b) => sortDir === 'desc' ? (b.price * b.qty) - (a.price * a.qty) : (a.price * a.qty) - (b.price * b.qty));
                } else if (sortType === 'name') {
                    itemsToSort.sort((a, b) => sortDir === 'desc' ? b.name.localeCompare(a.name) : a.name.localeCompare(b.name));
                } else if (sortType === 'popular') {
                    itemsToSort.sort((a, b) => sortDir === 'desc' ? b.qty - a.qty : a.qty - b.qty);
                }

                itemsToSort.forEach(s => {
                    const profit = (s.price - s.cost) * s.qty;
                    const noteHtml = s.note ? `<div style="margin-top: 6px; font-style: italic; color: var(--accent-color); font-size: 13px;">"–∑–∞–º–µ—Ç–∫–∞: ${s.note}"</div>` : '';
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.innerHTML = `
                        <div class="item-info">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <b>${s.name}</b>
                                <button class="edit-btn" onclick="openSaleEdit(${s.id})">‚úé</button>
                            </div>
                            <small>${s.date} ‚Ä¢ ${s.qty} —à—Ç. √ó ${s.price} ‚ÇΩ ${s.cost > 0 ? `<span class="badge badge-profit">+${profit.toLocaleString('ru-RU')} ‚ÇΩ</span>` : ''}</small>
                            ${noteHtml}
                        </div>
                        <div class="item-right">
                            <span class="item-price">${(s.price * s.qty).toLocaleString('ru-RU')} ‚ÇΩ</span>
                            <button class="delete-btn" onclick="deleteSale(${s.id})">√ó</button>
                        </div>
                    `;
                    display.appendChild(card);
                });
            }
        }

        // Global Actions
        async function saveData() {
            // Local save (fallback)
            const now = Date.now();
            localStorage.setItem('vapeSales', JSON.stringify(sales));
            localStorage.setItem('vapeInventory', JSON.stringify(inventory));
            localStorage.setItem('vapeLosses', JSON.stringify(losses));
            localStorage.setItem('vapeLastUpdate', now);

            // Cloud save - only if authenticated
            if (window.firebaseDB && window.firebaseAuth.currentUser) {
                try {
                    await firebaseSetDoc(firebaseDoc(window.firebaseDB, "tracker", "mainData"), {
                        sales: sales,
                        inventory: inventory,
                        losses: losses,
                        updatedAt: now,
                        lastSyncBy: window.firebaseAuth.currentUser.email
                    });
                    showToast("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ‚òÅÔ∏è");
                } catch (e) {
                    console.error("Firebase Save Error:", e);
                    showToast("–û—à–∏–±–∫–∞ –æ–±–ª–∞–∫–∞ ‚ö†Ô∏è", "error");
                }
            }
        }

        async function loadCloudData() {
            if (!window.firebaseDB) return;

            try {
                const docSnap = await firebaseGetDoc(firebaseDoc(window.firebaseDB, "tracker", "mainData"));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const cloudTime = data.updatedAt || 0;
                    const localTime = parseInt(localStorage.getItem('vapeLastUpdate')) || 0;

                    // Only update if cloud data is newer or local is empty
                    if (cloudTime > localTime || (sales.length === 0 && inventory.length === 0)) {
                        sales = data.sales || [];
                        inventory = data.inventory || [];
                        losses = data.losses || [];

                        localStorage.setItem('vapeSales', JSON.stringify(sales));
                        localStorage.setItem('vapeInventory', JSON.stringify(inventory));
                        localStorage.setItem('vapeLosses', JSON.stringify(losses));
                        localStorage.setItem('vapeLastUpdate', cloudTime);

                        // Re-render current page
                        const activeTab = document.querySelector('.tab.active span:last-child').textContent;
                        if (activeTab === '–ü—Ä–æ–¥–∞–∂–∏') renderSales();
                        else if (activeTab === '–°–∫–ª–∞–¥') renderInventory();
                        else if (activeTab === '–£–±—ã—Ç–∫–∏') renderLosses();
                        else if (activeTab === '–ò—Ç–æ–≥–∏') renderStats();

                        updateDatalist();
                        showToast("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞ ‚òÅÔ∏è");
                    }
                }
            } catch (e) {
                console.error("Firebase Load Error:", e);
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        function clearSales() {
            if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–¥–∞–∂?")) {
                sales = [];
                saveData();
                renderSales();
            }
        }

        function clearInventory() {
            if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Å–∫–ª–∞–¥?")) {
                inventory = [];
                saveData();
                renderInventory();
                updateDatalist();
            }
        }

        async function exportData() {
            const data = {
                sales,
                inventory,
                losses,
                exportedAt: new Date().toISOString()
            };
            const jsonStr = JSON.stringify(data, null, 2);

            // Try sharing if supported/mobile
            if (navigator.share) {
                try {
                    const file = new File([jsonStr], `vape_backup_${new Date().toISOString().slice(0, 10)}.json`, { type: 'application/json' });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: '–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è Vape Tracker',
                            text: '–ú–æ—è –±–∞–∑–∞ –ø—Ä–æ–¥–∞–∂ –∏ —Å–∫–ª–∞–¥–∞.'
                        });
                        return; // Successfully shared, don't download
                    }
                } catch (e) {
                    console.log('Sharing failed, falling back to download', e);
                }
            }

            // Fallback to simple download
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vape_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function shareData() {
            const textData = JSON.stringify({ sales, inventory, losses }, null, 2);
            /* simpler share for plain text summary if needed, but JSON is better for backup */
            const shareData = {
                title: 'Vape Tracker Backup',
                text: '–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –¥–∞–Ω–Ω—ã—Ö Vape Tracker',
                files: [
                    new File([textData], `vape_backup_${new Date().toLocaleDateString()}.txt`, {
                        type: 'text/plain',
                    }),
                ],
            };

            if (navigator.canShare && navigator.canShare(shareData)) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è: ' + err.message);
                }
            } else {
                // Fallback to clipboard
                try {
                    await navigator.clipboard.writeText(textData);
                    alert('–î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (—Ç.–∫. –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)');
                } catch (err) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.');
                }
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (!data.inventory || !data.sales) {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    }

                    const mode = confirm('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏?\n\nOK = –û–±—ä–µ–¥–∏–Ω–∏—Ç—å (–¥–æ–±–∞–≤–∏—Ç—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º)\n–û—Ç–º–µ–Ω–∞ = –ó–∞–º–µ–Ω–∏—Ç—å (—É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ)');

                    if (mode) {
                        // Merge mode - add imported data
                        data.inventory.forEach(item => {
                            const existing = inventory.find(i => i.name.toLowerCase() === item.name.toLowerCase());
                            if (existing) {
                                existing.qty += item.qty;
                            } else {
                                item.id = Date.now() + Math.random(); // new id
                                inventory.push(item);
                            }
                        });

                        const existingIds = new Set(sales.map(s => s.id));
                        data.sales.forEach(sale => {
                            if (!existingIds.has(sale.id)) {
                                sales.push(sale);
                            }
                        });
                        // Sort sales by timestamp
                        sales.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                        // Import losses
                        if (data.losses) {
                            const existingLossIds = new Set(losses.map(l => l.id));
                            data.losses.forEach(loss => {
                                if (!existingLossIds.has(loss.id)) {
                                    losses.push(loss);
                                }
                            });
                            losses.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        }
                    } else {
                        // Replace mode
                        inventory = data.inventory;
                        sales = data.sales;
                        losses = data.losses || [];
                    }

                    saveData();
                    renderSales();
                    renderInventory();
                    alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');

                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        function onDateChange(input) {
            document.getElementById('calIcon').classList.toggle('active', input.value !== '');
            renderSales();
        }

        // Stats Functions
        function setStatsPeriod(period) {
            statsPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderStats();
        }

        function getFilteredSales(period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            return sales.filter(s => {
                if (period === 'all') return true;

                // Fallback for objects missing timestamp
                const saleDate = s.timestamp ? new Date(s.timestamp) : new Date(2023, 0, 1);
                const saleDateOnly = new Date(saleDate.getFullYear(), saleDate.getMonth(), saleDate.getDate());

                if (period === 'day') {
                    return saleDateOnly.getTime() === today.getTime();
                } else if (period === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return saleDate >= weekAgo;
                } else if (period === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    return saleDate >= monthAgo;
                }
                return true;
            });
        }

        function getFilteredLosses(period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            return losses.filter(l => {
                if (period === 'all') return true;

                const lossDate = l.timestamp ? new Date(l.timestamp) : new Date(2023, 0, 1);

                if (period === 'day') {
                    const lossDayOnly = new Date(lossDate.getFullYear(), lossDate.getMonth(), lossDate.getDate());
                    return lossDayOnly.getTime() === today.getTime();
                } else if (period === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return lossDate >= weekAgo;
                } else if (period === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    return lossDate >= monthAgo;
                }
                return true;
            });
        }



        function renderStats() {
            const filteredSales = getFilteredSales(statsPeriod);
            const filteredLosses = getFilteredLosses(statsPeriod);

            // Calculate stats
            let revenue = 0;
            let profit = 0;
            let salesCount = 0;
            const productStats = {};

            filteredSales.forEach(s => {
                revenue += s.price * s.qty;
                profit += (s.price - (s.cost || 0)) * s.qty;
                salesCount += s.qty;

                const name = s.name.toLowerCase();
                if (!productStats[name]) {
                    productStats[name] = { name: s.name, qty: 0, revenue: 0 };
                }
                productStats[name].qty += s.qty;
                productStats[name].revenue += s.price * s.qty;
            });

            let lossesTotal = 0;
            filteredLosses.forEach(l => {
                lossesTotal += l.cost * l.qty;
                // Subtract from profit if enabled for this loss item
                // Legacy support: if deductProfit property missing, assume true? 
                // Or assume false? Defaulting to true for old data might be safer for conservative profitCalc, 
                // but user just added this. Let's assume true for existing data if we want to be strict, 
                // or check the flag. Let's support the flag.
                if (l.deductProfit !== false) { // Default to true if undefined
                    profit -= (l.cost * l.qty);
                }
            });

            document.getElementById('statRevenue').textContent = revenue.toLocaleString('ru-RU');
            document.getElementById('statProfit').textContent = profit.toLocaleString('ru-RU');
            document.getElementById('statLosses').textContent = lossesTotal.toLocaleString('ru-RU');
            document.getElementById('statSalesCount').textContent = salesCount.toLocaleString('ru-RU');

            // Update Losses Page Total if element exists
            const lpTotal = document.getElementById('lossesPageTotal');
            if (lpTotal) {
                // Calculate overall total for the page display, or keep it period-based?
                // Usually Losses page should show absolute total. 
                // Let's use overall total for the page, and period total for the Stat box.
                const overallLossesTotal = losses.reduce((sum, l) => sum + (l.cost * l.qty), 0);
                lpTotal.textContent = overallLossesTotal.toLocaleString('ru-RU');
            }

            // Top products
            const sortedProducts = Object.values(productStats).sort((a, b) => b.qty - a.qty);
            const maxQty = sortedProducts[0]?.qty || 1;

            const topContainer = document.getElementById('topProducts');
            if (sortedProducts.length === 0) {
                topContainer.innerHTML = '<div class="empty-state" style="padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            } else {
                topContainer.innerHTML = sortedProducts.slice(0, 5).map((p, i) => {
                    const colors = ['#ffffff', '#e0e0e0', '#c0c0c0', '#a0a0b0', '#808080'];
                    const width = (p.qty / maxQty) * 100;
                    return `
                        <div class="product-bar">
                            <span class="product-bar-name">${p.name}</span>
                            <div class="product-bar-fill">
                                <div class="product-bar-progress" style="width: ${width}%; background: ${colors[i % colors.length]};">
                                    ${p.qty} —à—Ç.
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Worst products (on stock but not selling)
            const worstContainer = document.getElementById('worstProducts');
            const soldNames = new Set(Object.keys(productStats));
            const notSelling = inventory.filter(item => !soldNames.has(item.name.toLowerCase()) && item.qty > 0);

            if (notSelling.length === 0) {
                worstContainer.innerHTML = '<div class="empty-state" style="padding: 20px;">–í—Å—ë –ø—Ä–æ–¥–∞—ë—Ç—Å—è! üéâ</div>';
            } else {
                worstContainer.innerHTML = notSelling.slice(0, 5).map(item => `
                    <div class="product-bar">
                        <span class="product-bar-name">${item.name}</span>
                        <div class="product-bar-fill">
                            <div class="product-bar-progress" style="width: 100%; background: rgba(255, 61, 113, 0.5);">
                                ${item.qty} —à—Ç. –Ω–∞ —Å–∫–ª–∞–¥–µ
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Loss Functions
        function openLossModal() {
            document.getElementById('lossModal').style.display = 'flex';
        }

        function setupLossAutocomplete() {
            const nameInput = document.getElementById('lossName');
            const listDiv = document.getElementById('lossAutocompleteList');
            if (!nameInput || !listDiv) return;

            nameInput.addEventListener('input', function () {
                const val = this.value;
                listDiv.innerHTML = '';
                if (!val) return;

                const matches = inventory.filter(item => item.name.toLowerCase().includes(val.toLowerCase()));
                matches.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.innerHTML = `
                            <span>${item.name}</span>
                            <small>${item.qty} —à—Ç.</small>
                        `;
                    div.addEventListener('click', function () {
                        nameInput.value = item.name;
                        document.getElementById('lossQty').value = 1;
                        document.getElementById('lossCost').value = item.cost;
                        listDiv.innerHTML = '';
                    });
                    listDiv.appendChild(div);
                });
            });

            document.addEventListener('click', function (e) {
                if (e.target !== nameInput) {
                    listDiv.innerHTML = '';
                }
            });
        }

        function closeLossModal() {
            document.getElementById('lossModal').style.display = 'none';
            document.getElementById('lossName').value = '';
            document.getElementById('lossQty').value = '';
            document.getElementById('lossCost').value = '';
            document.getElementById('lossNote').value = '';
        }

        function saveLoss() {
            const name = document.getElementById('lossName').value.trim();
            const qty = parseInt(document.getElementById('lossQty').value);
            const cost = parseFloat(document.getElementById('lossCost').value);
            const reason = document.getElementById('lossReason').value;
            const note = document.getElementById('lossNote').value.trim();

            const deductStock = document.getElementById('lossDeductStock').checked;

            if (!name || isNaN(qty) || isNaN(cost)) {
                alert('–ó–∞–ø–æ–ª–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ü–µ–Ω—É!');
                return;
            }

            const now = new Date();
            losses.unshift({
                id: Date.now(),
                name,
                qty,
                cost,
                reason,
                note,
                date: now.toLocaleDateString('ru-RU'),
                timestamp: now.getTime()
            });

            // Deduct from inventory if requested
            if (deductStock) {
                const invItem = inventory.find(i => i.name.toLowerCase() === name.toLowerCase());
                if (invItem) {
                    invItem.qty = Math.max(0, invItem.qty - qty);
                } else {
                    // Optional: alert that item wasn't found in stock? 
                    // Silent fail is okay per request "if not in stock just loss"
                }
            }

            saveData();
            closeLossModal();
            renderStats();
            renderLosses();
            renderInventory();
        }

        function renderLosses() {
            const container = document.getElementById('lossesHistory');
            if (losses.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;">–£–±—ã—Ç–∫–æ–≤ –Ω–µ—Ç üëç</div>';
                return;
            }

            const reasonLabels = { defect: '–ë—Ä–∞–∫', lost: '–ü–æ—Ç–µ—Ä—è–Ω', gift: '–ü–æ–¥–∞—Ä–∏–ª', self: '–û—Å—Ç–∞–≤–∏–ª —Å–µ–±–µ', other: '–î—Ä—É–≥–æ–µ' };
            container.innerHTML = losses.map(l => `
                <div class="loss-item">
                    <div class="loss-item-info">
                        <b>${l.name}</b>
                        <small>${l.date} ‚Ä¢ ${reasonLabels[l.reason] || l.reason} ‚Ä¢ ${l.qty} —à—Ç.${l.note ? ' ‚Ä¢ ' + l.note : ''}</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="loss-item-amount" style="color: #ff3d71; font-weight: 700;">-${(l.cost * l.qty).toLocaleString('ru-RU')} ‚ÇΩ</span>
                        <button class="edit-btn" onclick="openLossEdit(${l.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteLoss(${l.id})">√ó</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteLoss(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –æ–± —É–±—ã—Ç–∫–µ?')) {
                losses = losses.filter(l => l.id !== id);
                saveData();
                renderLosses();
                renderStats();
            }
        }

        // Edit Loss Functions
        function openLossEdit(id) {
            const loss = losses.find(l => l.id === id);
            if (loss) {
                document.getElementById('editLossId').value = id;
                document.getElementById('editLossName').value = loss.name || '';
                document.getElementById('editLossQty').value = loss.qty || '';
                document.getElementById('editLossCost').value = loss.cost || '';
                document.getElementById('editLossReason').value = loss.reason || 'defect';
                document.getElementById('editLossNote').value = loss.note || '';
                document.getElementById('editLossModal').style.display = 'flex';
            }
        }

        function closeLossEditModal() {
            document.getElementById('editLossModal').style.display = 'none';
        }

        function saveLossEdit() {
            const id = parseInt(document.getElementById('editLossId').value);
            const name = document.getElementById('editLossName').value.trim();
            const qty = parseInt(document.getElementById('editLossQty').value);
            const cost = parseFloat(document.getElementById('editLossCost').value);
            const reason = document.getElementById('editLossReason').value;
            const note = document.getElementById('editLossNote').value.trim();

            if (!name || isNaN(qty) || isNaN(cost)) {
                alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
                return;
            }

            const loss = losses.find(l => l.id === id);
            if (loss) {
                loss.name = name;
                loss.qty = qty;
                loss.cost = cost;
                loss.reason = reason;
                loss.note = note;

                saveData();
                closeLossEditModal();
                renderLosses();
                renderStats();
            }
        }





        // Update Info Page Statistics
        function updateInfoPageStats() {
            const salesCountEl = document.getElementById('infoSalesCount');
            const inventoryCountEl = document.getElementById('infoInventoryCount');

            if (salesCountEl) {
                salesCountEl.textContent = sales.length;
            }

            if (inventoryCountEl) {
                // Sum total quantity of all inventory items
                const totalQty = inventory.reduce((sum, item) => sum + (item.qty || 0), 0);
                inventoryCountEl.textContent = totalQty;
            }
        }

        // Help Page Functions
        function openHelpPage() {
            document.getElementById('helpPageModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeHelpPage() {
            document.getElementById('helpPageModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        // Init
        renderSales();
        renderStats();
        updateDatalist();
        setupLossAutocomplete();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }
    </script>
    <script>
        // Theme Logic
        const toggleBtn = document.getElementById('themeToggle');
        const body = document.body;

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            // Default to dark if no preference, unless saved is explicitly light
            // Or if system prefers light AND saved is NOT dark
            const systemPrefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;

            if (savedTheme === 'light') {
                body.classList.add('light-theme');
                toggleBtn.textContent = 'üåô';
            } else if (savedTheme === 'dark') {
                body.classList.remove('light-theme');
                toggleBtn.textContent = '‚òÄÔ∏è';
            } else if (systemPrefersLight) {
                // System is light, but we default to dark per user request unless system overrides?
                // User asked: "Default dark (if from device failed to get theme)". 
                // But also "Site let use device theme".
                // Logic: If no localStorage, check system. If system is light -> light. Else -> dark.
                body.classList.add('light-theme');
                toggleBtn.textContent = 'üåô';
            } else {
                // Default dark
                body.classList.remove('light-theme');
                toggleBtn.textContent = '‚òÄÔ∏è';
            }
        }

        toggleBtn.addEventListener('click', () => {
            body.classList.toggle('light-theme');
            const isLight = body.classList.contains('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            toggleBtn.textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
        });

        initTheme();
    </script>
</body>

</html>