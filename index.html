<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vape Tracker</title>

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vape Tracker">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Apple Splash Screens -->
    <link rel="apple-touch-startup-image" href="vape_bg_new.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="icon" type="image/png" href="favicon.png">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&subset=cyrillic&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="css/style.css?v=2.0">
</head>

<body>

    <div class="container">
        <!-- Header Buttons -->
        <!-- Theme toggle moved to Settings in Info tab -->

        <!-- Floating Action Button -->
        <!-- Floating Action Button: AI Assistant -->
        <button id="aiFab" class="ai-btn" onclick="openChatModal()" title="AI –ü–æ–º–æ—â–Ω–∏–∫">
            <img src="ai_assistant.png" alt="AI">
        </button>

        <!-- Floating Action Button: Notes -->
        <button class="notes-btn" onclick="openNotesModal()" title="–ó–∞–º–µ—Ç–∫–∏">üìù</button>

        <div class="header" style="margin-top: 10px;">
            <div style="width: 80px;"></div> <!-- Spacer -->
            <h1 id="appTitle" onclick="handleTitleClick()">VAPE TRACKER</h1>
            <button class="logout-btn" onclick="logout()" title="–í—ã–π—Ç–∏">
                <span>–í–´–ô–¢–ò</span>
            </button>
        </div>

        <div class="stats-grid">
            <div class="total-box">
                <div>–í—ã—Ä—É—á–∫–∞</div>
                <span id="totalRevenue">0</span> ‚ÇΩ
            </div>
            <div class="total-box profit">
                <div>–ü—Ä–∏–±—ã–ª—å</div>
                <span id="totalProfit" style="color: var(--success-color);">0</span> ‚ÇΩ
            </div>
        </div>

        <div id="goalContainer" class="goal-container">
            <div class="goal-text">
                <span style="opacity: 0.7;">–¶–µ–ª—å</span>
                <span id="goalProgressText" style="color: var(--accent-color);">0 / 0 ‚ÇΩ</span>
            </div>
            <div class="progress-bg">
                <div id="goalProgressBar" class="progress-bar"></div>
            </div>
        </div>

        <!-- Page: Sales -->
        <div id="salesPage" class="page active">
            <div class="input-card">
                <div class="input-group autocomplete-container">
                    <input type="text" id="saleName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: Brusko)"
                        oninput="handleAutocomplete(this)" onfocus="handleAutocomplete(this)" autocomplete="off">
                    <div id="autocompleteList" class="autocomplete-list"></div>
                </div>
                <div class="input-group" style="display: flex; gap: 15px;">
                    <input type="number" id="saleQty" placeholder="–ö–æ–ª-–≤–æ" inputmode="numeric" pattern="[0-9]*"
                        required>
                    <input type="number" id="salePrice" placeholder="–¶–µ–Ω–∞" inputmode="decimal" step="any" required>
                </div>

                <div
                    style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <label class="checkbox-group" style="flex: 1; display: flex; justify-content: flex-start;">
                        <input type="checkbox" id="useDate" checked onchange="toggleDateInput()">
                        <div class="checkbox-custom"></div>
                        <span>–î–∞—Ç–∞</span>
                    </label>

                    <label class="checkbox-group" style="flex: 1; display: flex; justify-content: center;">
                        <input type="checkbox" id="showBuyer" onchange="toggleCustomerInput()">
                        <div class="checkbox-custom checkbox-accent"></div>
                        <span>–ö–ª–∏–µ–Ω—Ç</span>
                    </label>

                    <label class="checkbox-group" style="flex: 1; display: flex; justify-content: flex-end;">
                        <input type="checkbox" id="isDebt" onchange="toggleCustomerInput(); toggleDebtColor();">
                        <div class="checkbox-custom checkbox-warning"></div>
                        <span style="color: #ff9800;">–í –¥–æ–ª–≥</span>
                    </label>
                </div>

                <div id="debtorNameContainer"
                    style="display: none; animation: fadeIn 0.3s ease; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                    <input type="text" id="debtorName" placeholder="üë§ –§–ò–û –ø–æ–∫—É–ø–∞—Ç–µ–ª—è"
                        style="border-radius: 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; padding: 12px 14px; font-size: 14px;">
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="debtorContact" placeholder="üìû –ù–æ–º–µ—Ä"
                            style="flex:1; border-radius: 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; padding: 12px 14px; font-size: 14px;">
                        <input type="text" id="debtorSocial" placeholder="‚úàÔ∏è TG / –°–æ—Ü-—Å–µ—Ç–∏"
                            style="flex:1; border-radius: 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; padding: 12px 14px; font-size: 14px;">
                    </div>
                </div>

                <div id="manualDateContainer" style="display: none; animation: fadeIn 0.3s ease; margin-bottom: 15px;">
                    <input type="date" id="saleDate"
                        style="border-radius: 16px; background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); color: white; padding: 14px; width: 100%;">
                </div>

                <div class="input-group" style="margin-top: 5px;">
                    <input type="text" id="saleNote" placeholder="–ó–∞–º–µ—Ç–∫–∞ –∫ –ø—Ä–æ–¥–∞–∂–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                        style="border-radius: 16px; background: rgba(255,255,255,0.03); font-size: 13px; padding: 12px 14px;">
                </div>
            </div>

            <button id="addSaleBtn" class="main-btn" onclick="addSale()">–ü–†–û–î–ê–¢–¨</button>

            <div class="history-header" style="margin-top: 25px;">
                <div style="display: flex; flex-direction: column; gap: 4px; width: 100%;">
                    <div style="display: flex; gap: 4px; align-items: center; width: 100%;">
                        <select id="sortType" class="badge toggle-btn" onchange="setSortType(this.value)"
                            style="padding-right: 30px; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2210%22%20height%3D%2210%22%20viewBox%3D%220%200%2012%2012%22%20fill%3D%22none%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cpath%20d%3D%22M2%204L6%208L10%204%22%20stroke%3D%22white%22%20stroke-width%3D%221.5%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 10px center; appearance: none; outline: none; border: 1px solid var(--glass-border); flex: 1; height: 44px;">
                            <option value="date" style="background:#222; color:#fff">–ü–æ –¥–∞—Ç–µ</option>
                            <option value="amount" style="background:#222; color:#fff">–ü–æ —Å—É–º–º–µ</option>
                            <option value="name" style="background:#222; color:#fff">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                            <option value="popular" style="background:#222; color:#fff">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
                            <option value="profit_day" style="background:#222; color:#fff">–ü—Ä–∏–±—ã–ª—å–Ω—ã–π –¥–µ–Ω—å</option>
                        </select>
                        <button id="sortDirBtn" class="badge toggle-btn" onclick="toggleSortDir()"
                            style="width: 44px; min-width: 44px; padding: 0; font-size: 16px; border: 1px solid var(--glass-border);">‚Üì</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div id="calendarWrapper" class="date-filter-wrapper">
                        <div class="calendar-trigger" id="calIcon"></div>
                        <input type="date" id="dateFilter" class="hidden-picker" onchange="onDateChange(this)"
                            onfocus="document.getElementById('calIcon').classList.add('active')"
                            onblur="document.getElementById('calIcon').classList.remove('active')">
                    </div>
                    <button class="clear-btn" onclick="clearSales()">–û–ß–ò–°–¢–ò–¢–¨</button>
                </div>
            </div>
            <div id="salesDisplay"></div>
            <!-- salesPage ends here -->
        </div>

        <!-- Page: Inventory -->
        <div id="inventoryPage" class="page">
            <div class="input-card">
                <div class="input-group">
                    <input type="text" id="invName" placeholder="–ù—É —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–π, —á–µ–º –∑–∞–∫—É–ø–∏–ª—Å—è?" required>
                </div>
                <div class="input-group" style="display: flex; gap: 15px;">
                    <input type="text" id="invStrength" placeholder="–ö—Ä–µ–ø–æ—Å—Ç—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    <input type="number" id="invQty" placeholder="–®—Ç." inputmode="numeric" pattern="[0-9]*" required>
                </div>
                <div class="input-group" style="display: flex; gap: 15px;">
                    <input type="number" id="invCost" placeholder="–ó–∞–∫—É–ø (‚ÇΩ/—à—Ç)" inputmode="decimal" step="any"
                        required>
                    <input type="number" id="invPrice" placeholder="–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (‚ÇΩ)" inputmode="decimal" step="any"
                        required>
                </div>
                <button class="main-btn" onclick="addInventory()">–ù–ê –°–ö–õ–ê–î</button>
            </div>

            <div class="history-header" style="justify-content: flex-end; margin-top: 10px; margin-bottom: 15px;">
                <button class="clear-btn" onclick="clearInventory()"
                    style="width: 44px; padding: 0; background: rgba(255, 61, 113, 0.08);"
                    title="–û—á–∏—Å—Ç–∏—Ç—å —Å–∫–ª–∞–¥">üóëÔ∏è</button>
            </div>

            <!-- Inventory Stats -->
            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="total-box">
                    <div>–ó–∞–∫—É–ø–ª–µ–Ω–æ –Ω–∞</div>
                    <span id="invTotalCost">0</span> ‚ÇΩ
                </div>
                <div class="total-box profit">
                    <div>–û–∂–∏–¥. –≤—ã—Ä—É—á–∫–∞</div>
                    <span id="invTotalRevenue">0</span> ‚ÇΩ
                </div>
            </div>

            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="total-box">
                    <div>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞</div>
                    <span id="invTotalCount">0</span> —à—Ç.
                </div>
                <div class="total-box profit">
                    <div>–†–∞–∑–Ω–æ–≤–∏–¥–Ω–æ—Å—Ç—å</div>
                    <span id="invTotalVariety">0</span> –µ–¥.
                </div>
            </div>

            <div id="inventoryDisplay"></div>
        </div>

        <!-- Page: Debts -->
        <div id="debtsPage" class="page">
            <div class="input-card" style="padding: 30px;">
                <h3 style="margin: 0 0 25px 0; text-align: center; letter-spacing: 2px;">–†–ê–ë–û–¢–ê –° –î–û–õ–ì–ê–ú–ò</h3>

                <div class="total-box" style="margin-bottom: 25px; --accent-color: #ff9800;">
                    <div>–û–±—â–∏–π –¥–æ–ª–≥</div>
                    <span id="totalDebtsSum" style="color: #ff9800;">0</span> ‚ÇΩ
                </div>

                <div id="debtsDisplay"></div>

                <div style="padding: 20px 10px 0; opacity: 0.6; font-size: 13px; text-align: center; line-height: 1.5;">
                    üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ üü¢ ‚Äî –û–ø–ª–∞—á–µ–Ω–æ<br>
                    –°–≤–∞–π–ø –≤–ª–µ–≤–æ üî¥ ‚Äî –ü—Ä–æ—Å—Ç–∏—Ç—å (–≤ —É–±—ã—Ç–∫–∏)
                </div>
            </div>
        </div>

        <!-- Page: Losses -->
        <div id="lossesPage" class="page">
            <div class="input-card" style="padding: 30px;">
                <h3 style="margin: 0 0 25px 0; text-align: center; letter-spacing: 2px;">–£–ë–´–¢–ö–ò / –°–ü–ò–°–ê–ù–ò–Ø</h3>

                <div class="total-box" style="margin-bottom: 25px; --accent-color: #ff3b30;">
                    <div>–£–±—ã—Ç–æ–∫</div>
                    <span id="lossesPageTotal" style="color: #ff3b30;">0</span> ‚ÇΩ
                </div>

                <button class="main-btn"
                    style="margin-bottom: 25px; background: linear-gradient(135deg, #ff3d71, #ff6b6b); box-shadow: 0 10px 20px rgba(255, 61, 113, 0.2);"
                    onclick="openLossModal()">–î–û–ë–ê–í–ò–¢–¨ –£–ë–´–¢–û–ö</button>

                <div id="lossesHistory"></div>

                <div style="padding: 20px 10px 0; opacity: 0.6; font-size: 13px; text-align: center; line-height: 1.5;">
                    –ó–¥–µ—Å—å —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –±—Ä–∞–∫–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã, –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ <br> –∏–ª–∏ –µ—Å–ª–∏ —Ä–µ—à–∏–ª —Å–∞–º –ø–æ–ø–∞—Ä–∏—Ç—å –∏–ª–∏ –ø–æ–¥–∞—Ä–∏—Ç—å.
                </div>
            </div>
        </div>

        <!-- Page: Stats -->
        <div id="statsPage" class="page">
            <div class="stats-period-selector">
                <button class="period-btn active" onclick="setStatsPeriod('day')">–î–µ–Ω—å</button>
                <button class="period-btn" onclick="setStatsPeriod('week')">–ù–µ–¥–µ–ª—è</button>
                <button class="period-btn" onclick="setStatsPeriod('month')">–ú–µ—Å—è—Ü</button>
                <button class="period-btn" onclick="setStatsPeriod('all')">–í—Å—ë</button>
            </div>

            <div class="stats-grid">
                <div class="total-box">
                    <div>–í—ã—Ä—É—á–∫–∞</div>
                    <span id="statRevenue">0</span> ‚ÇΩ
                </div>
                <div class="total-box profit">
                    <div>–ü—Ä–∏–±—ã–ª—å</div>
                    <span id="statProfit">0</span> ‚ÇΩ
                </div>
            </div>

            <!-- Chart Card -->
            <div class="input-card" style="padding: 20px; overflow: hidden;">
                <h4
                    style="margin: 0 0 15px 0; font-size: 12px; color: var(--accent-color); text-transform: uppercase; letter-spacing: 2px; text-align: center;">
                    –ì—Ä–∞—Ñ–∏–∫ –≤—ã—Ä—É—á–∫–∏</h4>
                <div style="height: 200px; width: 100%; position: relative;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <div class="stats-grid">
                <div class="total-box" style="--accent-color: #ff6b6b;">
                    <div>–£–±—ã—Ç–∫–∏</div>
                    <span id="statLosses" style="color: #ff6b6b;">0</span> ‚ÇΩ
                </div>
                <div class="total-box" style="--accent-color: #ffd93d;">
                    <div>–ü—Ä–æ–¥–∞–∂</div>
                    <span id="statSalesCount">0</span> —à—Ç.
                </div>
            </div>

            <div
                style="margin: 25px 0 15px 12px; font-size: 11px; font-weight: bold; opacity: 0.5; text-transform: uppercase; letter-spacing: 1.5px;">
                –°–ö–õ–ê–î –°–ï–ô–ß–ê–°</div>
            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="total-box" style="--accent-color: var(--secondary-accent);">
                    <div>–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
                    <span id="statInvValue">0</span> ‚ÇΩ
                </div>
                <div class="total-box profit" style="--accent-color: var(--success-color);">
                    <div>–û–∂–∏–¥. –ø—Ä–∏–±—ã–ª—å</div>
                    <span id="statInvProfit">0</span> ‚ÇΩ
                </div>
            </div>

            <div class="input-card" style="padding: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--text-secondary);">üî• –¢–û–ü —Ç–æ–≤–∞—Ä—ã</h3>
                <div id="topProducts"></div>
            </div>

            <div class="input-card" style="padding: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--text-secondary);">üìâ –ù–µ –ø—Ä–æ–¥–∞—ë—Ç—Å—è</h3>
                <div id="worstProducts"></div>
            </div>
        </div>
    </div>

    <!-- Edit Inventory Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-card">
            <h3>–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –¢–û–í–ê–†</h3>
            <input type="hidden" id="editItemId">
            <div class="input-group">
                <input type="text" id="editName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            </div>
            <div class="input-group">
                <input type="text" id="editStrength" placeholder="–ö—Ä–µ–ø–æ—Å—Ç—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div class="input-group" style="display: flex; gap: 15px;">
                <input type="number" id="editCost" placeholder="–ó–∞–∫—É–ø" inputmode="decimal" step="any">
                <input type="number" id="editPrice" placeholder="–ü—Ä–æ–¥–∞–∂–∞" inputmode="decimal" step="any">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2;" onclick="saveEdit()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <!-- Edit Sale Modal -->
    <div id="editSaleModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="letter-spacing: 2px;">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –ü–†–û–î–ê–ñ–£</h3>
            <input type="hidden" id="editSaleId">
            <div class="input-group">
                <input type="text" id="editSaleName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            </div>
            <div class="input-group" style="display: flex; gap: 10px;">
                <input type="number" id="editSaleQty" placeholder="–ö–æ–ª-–≤–æ" inputmode="numeric" pattern="[0-9]*">
                <input type="number" id="editSalePrice" placeholder="–¶–µ–Ω–∞" inputmode="decimal" step="any">
            </div>
            <div class="input-group" style="margin-top: 10px;">
                <input type="text" id="editSaleNote" placeholder="–ó–∞–º–µ—Ç–∫–∞ –∫ –ø—Ä–æ–¥–∞–∂–µ">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2;" onclick="saveSaleEdit()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeSaleModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <!-- Add Loss Modal -->
    <div id="lossModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="color: #ff6b6b;">–î–û–ë–ê–í–ò–¢–¨ –£–ë–´–¢–û–ö</h3>
            <div class="input-group">
                <div class="autocomplete-container" style="width: 100%;">
                    <input type="text" id="lossName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" autocomplete="off">
                    <div id="lossAutocompleteList" class="autocomplete-list"></div>
                </div>
            </div>
            <div class="input-group" style="display: flex; gap: 15px;">
                <input type="number" id="lossQty" placeholder="–ö–æ–ª-–≤–æ" inputmode="numeric" pattern="[0-9]*">
                <input type="number" id="lossCost" placeholder="–ó–∞–∫—É–ø —Ü–µ–Ω–∞" inputmode="decimal" step="any">
            </div>
            <div class="input-group">
                <select id="lossReason"
                    style="width: 100%; padding: 14px; border-radius: 16px; background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); color: white; font-size: 16px;">
                    <option value="defect">–ë—Ä–∞–∫</option>
                    <option value="lost">–ü–æ—Ç–µ—Ä—è–Ω</option>
                    <option value="gift">–ü–æ–¥–∞—Ä–∏–ª</option>
                    <option value="self">–û—Å—Ç–∞–≤–∏–ª —Å–µ–±–µ</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>

            <div class="checkbox-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="lossDeductStock" checked>
                    <div class="checkbox-custom"></div>
                    <span>–°–ø–∏—Å–∞—Ç—å —Å–æ —Å–∫–ª–∞–¥–∞</span>
                </label>
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <input type="text" id="lossNote" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2; background: linear-gradient(135deg, #ff3d71, #ff6b6b);"
                    onclick="saveLoss()">–î–û–ë–ê–í–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeLossModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <!-- Edit Loss Modal -->
    <div id="editLossModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="color: #ff6b6b; letter-spacing: 2px;">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –£–ë–´–¢–û–ö</h3>
            <input type="hidden" id="editLossId">
            <div class="input-group">
                <input type="text" id="editLossName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
            </div>
            <div class="input-group" style="display: flex; gap: 15px;">
                <input type="number" id="editLossQty" placeholder="–ö–æ–ª-–≤–æ" inputmode="numeric" pattern="[0-9]*">
                <input type="number" id="editLossCost" placeholder="–ó–∞–∫—É–ø —Ü–µ–Ω–∞" inputmode="decimal" step="any">
            </div>
            <div class="input-group">
                <select id="editLossReason"
                    style="width: 100%; padding: 14px; border-radius: 16px; background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); color: white; font-size: 16px;">
                    <option value="defect">–ë—Ä–∞–∫</option>
                    <option value="lost">–ü–æ—Ç–µ—Ä—è–Ω</option>
                    <option value="gift">–ü–æ–¥–∞—Ä–∏–ª</option>
                    <option value="self">–û—Å—Ç–∞–≤–∏–ª —Å–µ–±–µ</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>
            <div class="input-group" style="margin-top: 20px;">
                <input type="text" id="editLossNote" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2; background: linear-gradient(135deg, #ff3d71, #ff6b6b);"
                    onclick="saveLossEdit()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeLossEditModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <!-- Duplicate Conflict Modal -->
    <div id="duplicateConflictModal" class="modal-overlay">
        <div class="modal-card" style="text-align: center;">
            <h3 style="color: #ffd93d;">–¢–û–í–ê–† –£–ñ–ï –ï–°–¢–¨</h3>
            <p style="font-size: 14px; opacity: 0.8; margin-bottom: 20px;">
                –¢–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω–∞ –∏ –∫—Ä–µ–ø–æ—Å—Ç—å) —É–∂–µ –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ. –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?
            </p>
            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                <button class="main-btn" style="background: var(--success-color); color: #000;"
                    onclick="handleMergeResult('merge')">–û–ë–™–ï–î–ò–ù–ò–¢–¨ –°–£–ú–ú–£</button>
                <button class="main-btn" style="background: rgba(255,255,255,0.1);"
                    onclick="handleMergeResult('new')">–î–û–ë–ê–í–ò–¢–¨ –ö–ê–ö –ù–û–í–´–ô</button>
            </div>
            <div class="checkbox-group" style="justify-content: center;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="dontAskMerge">
                    <div class="checkbox-custom"></div>
                    <span style="font-size: 12px;">–ë–æ–ª—å—à–µ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="letter-spacing: 2px;">–°–ú–ï–ù–ò–¢–¨ –ü–ê–†–û–õ–¨</h3>
            <div class="input-group">
                <input type="password" id="currentPassword" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
                <button type="button" class="toggle-password"
                    onclick="togglePasswordVisibility('currentPassword')">üëÅ</button>
            </div>
            <div class="input-group" style="margin-bottom: 5px;">
                <input type="password" id="newPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                <button type="button" class="toggle-password"
                    onclick="togglePasswordVisibility('newPassword')">üëÅ</button>
            </div>
            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 20px; padding-left: 5px;">
                –ú–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤
            </div>
            <div class="input-group">
                <input type="password" id="confirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                <button type="button" class="toggle-password"
                    onclick="togglePasswordVisibility('confirmPassword')">üëÅ</button>
            </div>
            <div id="passwordChangeError" style="color: #ff3b30; font-size: 13px; margin-bottom: 15px; display: none;">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" style="flex: 2;" onclick="saveNewPassword()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button class="clear-btn" style="flex: 1;" onclick="closeChangePasswordModal()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <!-- Removed old syncStatus div -->

    <!-- Notes Modal -->
    <div id="notesModal" class="modal-overlay">
        <div class="modal-card" style="max-height: 80vh; display: flex; flex-direction: column;">
            <h3 style="letter-spacing: 2px;">–ó–ê–ú–ï–¢–ö–ò</h3>

            <div style="margin-bottom: 20px;">
                <textarea id="noteInput" placeholder="–ß—Ç–æ –∑–∞–ø–∏—Å–∞—Ç—å?"
                    style="width: 100%; height: 100px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 14px; color: white; padding: 15px; font-size: 14px; resize: none;"></textarea>
                <button class="main-btn" onclick="addNote()" style="margin-top: 10px;">–î–û–ë–ê–í–ò–¢–¨</button>
            </div>

            <div id="notesContainer" style="flex: 1; overflow-y: auto; padding-right: 5px;">
                <!-- Notes will be listed here -->
            </div>

            <button class="clear-btn" style="margin-top: 20px; width: 100%;"
                onclick="closeNotesModal()">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('sales')"><span
                style="font-size: 18px;">üí∏</span><span>–ü—Ä–æ–¥–∞–∂–∏</span></div>
        <div class="tab" onclick="switchTab('inventory')"><span style="font-size: 18px;">üì¶</span><span>–°–∫–ª–∞–¥</span>
        </div>
        <div class="tab" onclick="switchTab('debts')"><span style="font-size: 18px;">ü§ù</span><span>–î–æ–ª–≥–∏</span>
        </div>
        <div class="tab" onclick="switchTab('losses')"><span style="font-size: 18px;">üìâ</span><span>–£–±—ã—Ç–∫–∏</span>
        </div>
        <div class="tab" onclick="switchTab('stats')"><span style="font-size: 18px;">üìä</span><span>–ò—Ç–æ–≥–∏</span>
        </div>
        <div class="tab" onclick="switchTab('data')"><span style="font-size: 18px;">‚öôÔ∏è</span><span>–ò–Ω—Ñ–æ</span></div>
    </div>

    <!-- Data & Settings Page -->
    <div id="dataPage" class="page">
        <div style="max-width: 600px; margin: 0 auto;">
            <!-- Statistics Cards -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                <div
                    style="background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 15px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 5px;">üìä</div>
                    <div
                        style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px;">
                        –ü—Ä–æ–¥–∞–∂</div>
                    <div id="infoSalesCount" style="font-size: 20px; font-weight: 700; color: var(--accent-color);">0
                    </div>
                </div>
                <div
                    style="background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 15px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 5px;">üì¶</div>
                    <div
                        style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px;">
                        –ù–∞ —Å–∫–ª–∞–¥–µ</div>
                    <div id="infoInventoryCount" style="font-size: 20px; font-weight: 700; color: var(--accent-color);">
                        0
                    </div>
                </div>
            </div>

            <div
                style="background: linear-gradient(135deg, rgba(112, 0, 255, 0.1), rgba(0, 242, 255, 0.1)); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 15px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center; margin-bottom: 20px;">
                <div
                    style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">
                    –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–∫–ª–∞–¥–∞</div>
                <div id="infoInventoryValue" style="font-size: 24px; font-weight: 700; color: #ffffff;">0 <span
                        style="font-size: 16px; font-weight: normal; opacity: 0.6;">‚ÇΩ</span></div>
            </div>

            <!-- Settings Card -->
            <div class="input-card">
                <h3
                    style="margin-top: 0; margin-bottom: 20px; text-align: center; letter-spacing: 2px; font-size: 14px;">
                    –ù–ê–°–¢–†–û–ô–ö–ò</h3>

                <div class="settings-row">
                    <div style="font-size: 14px; display: flex; align-items: center; gap: 10px;">
                        <span>‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="themeSwitch" onchange="toggleTheme()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="settings-row">
                    <div style="font-size: 14px; display: flex; align-items: center; gap: 10px;">
                        <span>üìù –ó–∞–º–µ—Ç–∫–∏</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="notesSwitch" onchange="toggleNotesSetting()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="settings-row">
                    <div style="font-size: 14px; display: flex; align-items: center; gap: 10px;">
                        <span>ü§ñ AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="userAISwitch" onchange="toggleUserAI()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="settings-row">
                    <div style="font-size: 14px; display: flex; align-items: center; gap: 10px;">
                        <span>üì≥ –í–∏–±—Ä–∞—Ü–∏—è (Haptic)</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="hapticSwitch" onchange="toggleHapticSetting()" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div id="hapticIntensityRow" class="settings-row"
                    style="display: none; flex-direction: column; align-items: flex-start; gap: 10px; border-bottom: none;">
                    <div
                        style="font-size: 12px; color: var(--text-secondary); display: flex; justify-content: space-between; width: 100%;">
                        <span>–°–∏–ª–∞ –æ—Ç–¥–∞—á–∏</span>
                        <span id="hapticIntensityValue">–°—Ä–µ–¥–Ω—è—è</span>
                    </div>
                    <input type="range" id="hapticIntensity" min="1" max="3" step="1" value="2"
                        oninput="updateHapticIntensity()"
                        style="width: 100%; height: 6px; border-radius: 3px; background: rgba(255,255,255,0.1); outline: none; -webkit-appearance: none; appearance: none; margin: 10px 0;">
                </div>
            </div>

            <!-- Goal Card -->
            <div class="input-card">
                <h3
                    style="margin-top: 0; margin-bottom: 15px; text-align: center; letter-spacing: 2px; font-size: 14px;">
                    üéØ
                    –ú–û–Ø –¶–ï–õ–¨</h3>
                <div class="input-group">
                    <input type="number" id="goalInput" placeholder="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—É–º–º—É (‚ÇΩ)" oninput="updateGoal()"
                        inputmode="numeric"
                        style="text-align: center; font-size: 18px; font-weight: bold; color: var(--accent-color);">
                </div>
                <div style="font-size: 10px; opacity: 0.5; text-align: center; line-height: 1.4;">
                    –¶–µ–ª—å –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –≤—ã—Ä—É—á–∫–µ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ (–¥–µ–Ω—å, –º–µ—Å—è—Ü –∏ —Ç.–¥.)
                </div>
            </div>

            <!-- Data Management Card -->
            <div class="input-card">
                <h3
                    style="margin-top: 0; margin-bottom: 20px; text-align: center; letter-spacing: 2px; font-size: 14px;">
                    –î–ê–ù–ù–´–ï</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <button class="main-btn" onclick="exportData()"
                        style="padding: 14px 10px; font-size: 11px; background: rgba(0,0,0,0.05); color: var(--text-color); border: 1px solid var(--glass-border);">
                        ‚¨áÔ∏è –ë–≠–ö–ê–ü
                    </button>
                    <button class="main-btn" onclick="document.getElementById('importFile').click()"
                        style="padding: 14px 10px; font-size: 11px; background: rgba(0,0,0,0.05); color: var(--text-color); border: 1px solid var(--glass-border);">
                        ‚¨ÜÔ∏è –ó–ê–ì–†–£–ó–ò–¢–¨
                    </button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">

                <button class="main-btn" onclick="shareData()" style="margin-bottom: 15px;">
                    üì§ –ü–û–î–ï–õ–ò–¢–¨–°–Ø –î–ê–ù–ù–´–ú–ò
                </button>

                <button class="main-btn" onclick="openHelpPage()"
                    style="background: rgba(0,242,255,0.15); color: var(--accent-color); border: 1.5px solid rgba(0,242,255,0.3);">
                    ‚ùì –ö–ê–ö –ü–û–õ–¨–ó–û–í–ê–¢–¨–°–Ø?
                </button>

                <button class="main-btn" onclick="openChangePasswordModal()"
                    style="margin-top: 15px; background: rgba(0, 242, 255, 0.15); color: var(--accent-color); border: 1.5px solid rgba(0, 242, 255, 0.3);">
                    üîë –°–ú–ï–ù–ò–¢–¨ –ü–ê–†–û–õ–¨
                </button>

                <button class="main-btn" onclick="logout()"
                    style="margin-top: 15px; background: rgba(255, 61, 113, 0.15); color: #ff3b30; border: 1.5px solid rgba(255, 61, 113, 0.3);">
                    üö™ –í–´–ô–¢–ò
                </button>

                <!-- Admin Panel (Hidden by default) -->
                <div id="adminPanel"
                    style="display: none; margin-top: 20px; background: rgba(255, 61, 113, 0.1); padding: 18px; border-radius: 18px; border: 1px solid var(--danger-color);">
                    <h4
                        style="margin-top: 0; margin-bottom: 12px; color: var(--danger-color); font-size: 13px; text-transform: uppercase; letter-spacing: 1.5px;">
                        üõ°Ô∏è –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å
                    </h4>

                    <div
                        style="font-size: 13px; color: var(--text-color); margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px;">
                        <div><b>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:</b> <span id="adminLastSeen"
                                style="color: var(--accent-color)">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
                        <div><b>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</b> <span id="adminLastDevice" style="opacity: 0.7;">-</span></div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <button class="main-btn" onclick="adminResetPassword()"
                            style="background: var(--danger-color); font-size: 12px; padding: 10px;">
                            ‚ôªÔ∏è –°–ë–†–û–°–ò–¢–¨ –ü–ê–†–û–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
                        </button>
                        <small style="display: block; margin-top: 5px; opacity: 0.6; font-size: 10px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                            —Å–º–æ–∂–µ—Ç
                            –≤–æ–π—Ç–∏ –±–µ–∑ –ø–∞—Ä–æ–ª—è, –Ω–æ –±—É–¥–µ—Ç –æ–±—è–∑–∞–Ω —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π.</small>
                    </div>

                    <div style="margin-top: 15px;">
                        <h5 style="margin: 0 0 10px 0; font-size: 12px; opacity: 0.8;">ü§ñ AI –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ:</h5>
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px;">
                            <h6 style="margin: 10px 0 5px 0; font-size: 10px; opacity: 0.6;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI (Firebase):
                            </h6>

                            <!-- AI Toggle -->
                            <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <label class="switch">
                                    <input type="checkbox" id="aiEnabledCheck" onchange="saveAISettings()">
                                    <span class="slider round"></span>
                                </label>
                                <span style="font-size: 12px;">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤–∫–ª—é—á–µ–Ω</span>
                            </div>

                            <!-- Model Select -->
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 10px; display: block; margin-bottom: 3px;">–ú–æ–¥–µ–ª—å:</label>
                                <select id="aiModelSelect" onchange="saveAISettings()"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 8px; padding: 5px; font-size: 11px;">
                                    <option value="llama-3.3-70b-versatile">Groq: Llama 3.3 70B</option>
                                    <option value="qwen/qwen3-32b">Groq: Qwen 3 32B</option>
                                    <option value="openai/gpt-oss-120b">Groq: GPT-OSS 120B</option>
                                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                    <option value="custom">Custom (—Å–º. –Ω–∏–∂–µ)</option>
                                </select>
                            </div>

                            <!-- Custom Model Name -->
                            <input type="text" id="aiCustomModel" placeholder="ID –ú–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä. gemini-2.5)"
                                style="width: 100%; margin-bottom: 8px; font-size: 11px; padding: 6px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 8px; color: white; display: none;">

                            <!-- Groq Key -->
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 10px; display: block; margin-bottom: 3px; color: #f59e0b;">üîë
                                    Groq API Key (gsk_...):</label>
                                <input type="password" id="aiGroqKey" placeholder="gsk_..." onchange="saveAISettings()"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #f59e0b; border-radius: 8px; padding: 6px; font-size: 11px; outline: none;">
                            </div>

                            <!-- Gemini Key -->
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 10px; display: block; margin-bottom: 3px; color: #3b82f6;">üíé
                                    Gemini API Key (AIza...):</label>
                                <input type="password" id="aiGeminiKey" placeholder="AIza..."
                                    onchange="saveAISettings()"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #3b82f6; border-radius: 8px; padding: 6px; font-size: 11px; outline: none;">
                            </div>

                            <!-- System Prompt -->
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 10px; display: block; margin-bottom: 3px; color: #10b981;">üìú
                                    –°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (Prompt):</label>
                                <textarea id="aiSystemPrompt" rows="3" placeholder="–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –≤ –≤–µ–π–ø-—à–æ–ø–µ..."
                                    onchange="saveAISettings()"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #fff; border-radius: 8px; padding: 6px; font-size: 11px; outline: none;"></textarea>
                            </div>

                            <div style="margin-bottom: 10px;">
                                <label
                                    style="font-size: 10px; display: block; margin-bottom: 3px; opacity: 0.5;">–†–µ–∑–µ—Ä–≤–Ω—ã–µ
                                    –∫–ª—é—á–∏ (–ª—é–±—ã–µ):</label>
                                <textarea id="aiBackupKeys" rows="2" placeholder="–î–æ–ø. –∫–ª—é—á–∏..."
                                    onchange="saveAISettings()"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 8px; padding: 6px; font-size: 10px; outline: none;"></textarea>
                            </div>

                            <button onclick="saveAISettings()"
                                style="width: 100%; background: var(--success-color); color: black; font-weight: bold; font-size: 11px; padding: 8px; border-radius: 8px; border: none; margin-bottom: 15px;">üíæ
                                –°–û–•–†–ê–ù–ò–¢–¨ –ù–ê–°–¢–†–û–ô–ö–ò</button>


                            <span style="font-size: 11px;">–õ–∏–º–∏—Ç (—Å–µ–≥–æ–¥–Ω—è):</span>
                            <span id="adminDailyCount" style="font-size: 12px; font-weight: bold;">0 / 20</span>
                        </div>

                        <h6 style="margin: 10px 0 5px 0; font-size: 10px; opacity: 0.6;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:</h6>
                        <div id="adminChatHistory"
                            style="max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 8px; font-size: 10px; font-family: monospace; margin-bottom: 5px;">
                            <div style="text-align: center; opacity: 0.4;">–ü—É—Å—Ç–æ</div>
                        </div>
                        <button onclick="clearChatHistory()"
                            style="width: 100%; background: rgba(255, 61, 113, 0.1); border: 1px solid rgba(255, 61, 113, 0.3); color: var(--danger-color); font-size: 10px; padding: 5px; border-radius: 6px;">–û—á–∏—Å—Ç–∏—Ç—å
                            –∏—Å—Ç–æ—Ä–∏—é AI</button>
                    </div>

                    <div style="margin-top: 15px;">
                        <h5
                            style="margin: 0 0 10px 0; font-size: 12px; opacity: 0.8; display: flex; justify-content: space-between;">
                            <span>üìú –õ–µ–Ω—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π:</span>
                            <span style="font-size: 10px; color: var(--accent-color); cursor: pointer;"
                                onclick="clearAuditLog()">–æ—á–∏—Å—Ç–∏—Ç—å</span>
                        </h5>
                        <div id="adminActivityLog"
                            style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 12px; font-size: 11px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05);">
                            <!-- Activity log items -->
                            <div style="opacity: 0.5; text-align: center; padding: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <h5 style="margin: 0 0 10px 0; font-size: 12px; opacity: 0.8;">–ò—Å—Ç–æ—Ä–∏—è –ø–∞—Ä–æ–ª–µ–π (–û–±–ª–∞–∫–æ):</h5>
                        <div id="adminPassHistory"
                            style="max-height: 100px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 8px; font-size: 11px; margin-bottom: 10px; font-family: monospace;">
                            <!-- History items -->
                        </div>
                    </div>
                </div>

                <div
                    style="margin-top: 20px; background: rgba(255,255,255,0.05); padding: 18px; border-radius: 18px; border: 1px solid var(--glass-border);">
                    <h4
                        style="margin-top: 0; margin-bottom: 12px; color: var(--accent-color); font-size: 13px; text-transform: uppercase; letter-spacing: 1.5px;">
                        –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:</h4>
                    <div style="font-size: 13px; line-height: 1.6; color: var(--text-color); opacity: 0.9;">
                        <p style="margin-bottom: 10px;">üíæ <b>–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∫–æ–ø–∏—é:</b> –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø, —á—Ç–æ–±—ã –Ω–µ
                            –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ.</p>
                        <p style="margin: 0;">üîÑ <b>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:</b> –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–ø–∞–ª–∏ ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª –∏
                            –≤—ã–±–µ—Ä–∏—Ç–µ
                            —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞. –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏—Å—Ç–æ—Ä–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–µ—Ä–Ω—É—Ç—Å—è.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal">
        <div class="chat-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <img src="ai_assistant.png" style="width: 30px; height: 30px; border-radius: 50%;">
                <span style="font-weight: bold; letter-spacing: 1px;">VAPE AI</span>
            </div>
            <button onclick="closeChatModal()"
                style="background: none; border: none; color: var(--text-secondary); font-size: 24px;">&times;</button>
        </div>
        <div id="chatMessages" class="chat-messages">
            <div class="message ai">–ô–æ, –±—Ä–æ! ü§ô –Ø –Ω–∞ —Å–≤—è–∑–∏. –ß–µ–º –ø–æ–º–æ—á—å –ø–æ —à–æ–ø—É?</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="–°–ø—Ä–æ—Å–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–°–∫–æ–ª—å–∫–æ –≤—ã—Ä—É—á–∫–∞?'"
                onkeypress="handleChatEnter(event)">
            <button class="send-btn" onclick="sendChatMessage()">‚û§</button>
        </div>
    </div>

    <!-- Force Password Setup Modal -->
    <div id="forceSetupModal" class="modal-overlay" style="z-index: 20000; background: var(--bg-color);">
        <div class="modal-card">
            <h3 style="letter-spacing: 2px; color: var(--danger-color);">‚ö†Ô∏è –£–°–¢–ê–ù–û–í–ò–¢–ï –ü–ê–†–û–õ–¨</h3>
            <p style="font-size: 14px; opacity: 0.9; line-height: 1.5; margin-bottom: 20px;">
                –í–∞—à –ø–∞—Ä–æ–ª—å –±—ã–ª —Å–±—Ä–æ—à–µ–Ω. –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–¥—É–º–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å.
            </p>
            <div class="input-group">
                <input type="password" id="forceNewPass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
            </div>
            <div class="input-group">
                <input type="password" id="forceConfirmPass" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <div id="forceSetupError" style="color: #ff3b30; font-size: 13px; margin-bottom: 15px; display: none;">
            </div>

            <button class="main-btn" onclick="saveForcedPassword()">–°–û–•–†–ê–ù–ò–¢–¨ –ò –í–û–ô–¢–ò</button>
        </div>
    </div>

    <!-- Help Page Modal -->
    <div id="helpPageModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 600px; margin: 0 auto; padding: calc(45px + var(--safe-area-top)) 20px 120px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; font-size: 18px; letter-spacing: 2px;">–ö–ê–ö –ü–û–õ–¨–ó–û–í–ê–¢–¨–°–Ø?</h2>
                <button onclick="closeHelpPage()"
                    style="background: none; border: none; font-size: 28px; color: var(--text-color); cursor: pointer; padding: 10px;">‚úï</button>
            </div>

            <!-- Sales Section -->
            <div class="input-card" style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: var(--accent-color);">üí∏ –ü—Ä–æ–¥–∞–∂–∏</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –∫–∞—Å—Å–∏—Ä–∞:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><b>–ù–∞–∑–≤–∞–Ω–∏–µ</b> ‚Äî –Ω–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å, –∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ —Å–æ —Å–∫–ª–∞–¥–∞.</li>
                        <li><b>–ö–æ–ª-–≤–æ</b> ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤.</li>
                        <li><b>–¶–µ–Ω–∞</b> ‚Äî –∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏.</li>
                        <li><b>–î–∞—Ç–∞</b> ‚Äî –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –ø—Ä–æ–¥–∞–∂–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –∑–∞–±—ã–ª–∏ –∑–∞–ø–∏—Å–∞—Ç—å –≤—á–µ—Ä–∞).</li>
                    </ul>
                    <p style="margin: 10px 0 0 0;">–ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                    </p>
                </div>
            </div>

            <!-- Inventory Section -->
            <div class="input-card" style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: #2196F3;">üì¶ –°–∫–ª–∞–¥</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><b>–î–æ–±–∞–≤–∏—Ç—å</b> ‚Äî –ø—Ä–∏—Ö–æ–¥ —Ç–æ–≤–∞—Ä–∞. –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —É–∂–µ –µ—Å—Ç—å, –µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–ª–∏—á–∏—Ç—Å—è.</li>
                        <li><b>–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∞</b> ‚Äî –Ω—É–∂–Ω–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–∏–±—ã–ª–∏.</li>
                    </ul>
                </div>
            </div>

            <!-- AI Assistant Section -->
            <div class="input-card" style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: #9C27B0;">ü§ñ AI –ü–æ–º–æ—â–Ω–∏–∫</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–í–∞—à –ª–∏—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ (–∫–Ω–æ–ø–∫–∞ —Å–ª–µ–≤–∞ –≤–Ω–∏–∑—É). –ï–º—É –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –∏–ª–∏
                        –≥–æ–≤–æ—Ä–∏—Ç—å –æ–±—ã—á–Ω—ã–º —è–∑—ã–∫–æ–º:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><i>"–î–æ–±–∞–≤—å 10 —à—Ç—É–∫ Husky –ø–æ 350 —Ä—É–±–ª–µ–π"</i></li>
                        <li><i>"–ü—Ä–æ–¥–∞–ª 2 –∂–∏–∂–∏ –ß–∞–ø–º–∞–Ω"</i></li>
                        <li><i>"–ó–∞–ø–∏—à–∏ –¥–æ–ª–≥ 500—Ä –Ω–∞ –°–∞—à—É"</i></li>
                    </ul>
                    <p style="margin: 10px 0 0 0;">AI —Å–∞–º –ø–æ–π–º–µ—Ç –∫–æ–º–∞–Ω–¥—É –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç –¥–µ–π—Å—Ç–≤–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.</p>
                </div>
            </div>

            <!-- Debts Section -->
            <div class="input-card" style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: #FF9800;">ü§ù –î–æ–ª–≥–∏</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–†–∞–∑–¥–µ–ª –¥–ª—è —É—á–µ—Ç–∞ –¥–æ–ª–∂–Ω–∏–∫–æ–≤:</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –∏–º—è –∏ —Å—É–º–º—É –¥–æ–ª–≥–∞.</li>
                        <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –¥–æ–ª–≥, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –µ–≥–æ (–∫–æ–≥–¥–∞ –≤–µ—Ä–Ω—É–ª–∏).</li>
                    </ul>
                </div>
            </div>

            <!-- Losses Section -->
            <div class="input-card" style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: var(--danger-color);">üìâ –£–±—ã—Ç–∫–∏</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0 0 10px 0;">–°–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–±—Ä–∞–∫, –∫—Ä–∞–∂–∞, –ø–æ–¥–∞—Ä–æ–∫):</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>–¢–æ–≤–∞—Ä —Å–ø–∏—à–µ—Ç—Å—è —Å–æ —Å–∫–ª–∞–¥–∞.</li>
                        <li>–°—É–º–º–∞ –∑–∞–∫—É–ø–∞ –ø–æ–π–¥–µ—Ç –≤ —É—á–µ—Ç —É–±—ã—Ç–∫–æ–≤.</li>
                    </ul>
                </div>
            </div>

            <!-- Sync Section -->
            <div class="input-card">
                <h3 style="margin: 0 0 15px 0; font-size: 15px; color: var(--success-color);">‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h3>
                <div style="font-size: 14px; line-height: 1.7; color: var(--text-color); opacity: 0.9;">
                    <p style="margin: 0;">–í—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –æ–±–ª–∞–∫–µ. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–π—Ç–∏ —Å –ª—é–±–æ–≥–æ
                        —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –∏ –≤—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–π.</p>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, query, orderBy, limit, getDocs, deleteDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBPDXk_HldcpjSTWHfIq00pAm-U_0EuaQQ",
            authDomain: "vape-price.firebaseapp.com",
            projectId: "vape-price",
            storageBucket: "vape-price.firebasestorage.app",
            messagingSenderId: "251545583200",
            appId: "1:251545583200:web:037acd5796580e28c6cd05",
            measurementId: "G-03V6W6RVYL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        enableIndexedDbPersistence(db).catch((err) => {
            console.warn('Persistence status:', err.code);
        });

        window.db = db;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.addDoc = addDoc;
        window.collection = collection;
        window.doc = doc;
        window.auth = auth;
        window.query = query;
        window.orderBy = orderBy;
        window.limit = limit;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;

        // Legacy compatibility
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseAuth = auth;


        // Real-time sync and auth monitoring
        let cloudSub = null;
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Firebase Authenticated üîì");
                updateSyncUI(true);

                // Real-time listener: data will sync instantly across devices
                if (cloudSub) cloudSub();
                cloudSub = onSnapshot(doc(db, "tracker", "mainData"), (docSnap) => {
                    if (docSnap.exists()) {
                        processCloudUpdate(docSnap.data());
                    }
                }, (err) => {
                    console.error("Cloud Listener Error:", err);
                    updateSyncUI(false);
                });

                // Initialize AI (Sync Config) only after Auth
                if (window.initAI) window.initAI();
            } else {
                // No authenticated user - redirect to login
                console.log("No Firebase Auth session - redirecting to login");
                window.location.href = 'login.html';
            }
        });


        window.addEventListener('offline', () => updateSyncUI(false));

        let isCloudOnline = true;

        function updateSyncUI(online) {
            isCloudOnline = online;
            const title = document.getElementById('appTitle');
            if (title) {
                if (online) {
                    title.classList.remove('offline');
                    title.textContent = 'VAPE TRACKER';
                } else {
                    title.classList.add('offline');
                    title.textContent = 'VAPE TRACKER !';
                }
            }
        }

        function handleTitleClick() {
            if (!isCloudOnline) {
                showToast("–í–æ–∑–º–æ–∂–Ω–æ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ, –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –±—É–¥–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ.", "error");
            }
        }
    </script>

    <script src="js/app.js?v=2.0"></script>
    <script src="js/settings.js?v=2.0"></script>
    <script src="js/ai-assistant.js?v=2.0"></script>
</body>

</html>